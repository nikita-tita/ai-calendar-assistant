#!/bin/bash

# üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π calendar.housler.ru
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å VPS –æ–¥–∏–Ω —Ä–∞–∑, –Ω–∞—Å—Ç—Ä–æ–∏—Ç SSH –∫–ª—é—á,
# –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç –ø–æ–ª–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

set -e

VPS_IP="91.229.8.221"
VPS_USER="root"
SSH_KEY="$HOME/.ssh/calendar_deploy"

echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞ –∫ VPS"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSH –∫–ª—é—á–∞
if [ ! -f "$SSH_KEY" ]; then
    echo "‚ùå SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω: $SSH_KEY"
    echo "–°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π SSH –∫–ª—é—á..."
    ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" -C "calendar-deploy-key"
fi

echo "üì§ –î–æ–±–∞–≤–ª—è—é SSH –∫–ª—é—á –Ω–∞ VPS..."
echo "–í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å VPS –æ–¥–∏–Ω —Ä–∞–∑."
echo ""

# –î–æ–±–∞–≤–ª—è–µ–º SSH –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh-copy-id -i "${SSH_KEY}.pub" "$VPS_USER@$VPS_IP"

echo ""
echo "‚úÖ SSH –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω!"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –¥–æ—Å—Ç—É–ø
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é SSH –¥–æ—Å—Ç—É–ø..."
if ssh -i "$SSH_KEY" -o ConnectTimeout=5 "$VPS_USER@$VPS_IP" "echo '‚úÖ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç!'"; then
    echo ""
    echo "=================================================="
    echo "üöÄ –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É..."
    echo "=================================================="
    echo ""

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    cd "$(dirname "$0")"

    # –û–±–Ω–æ–≤–ª—è–µ–º auto_setup_calendar.sh –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—à–µ–≥–æ SSH –∫–ª—é—á–∞
    sed -i.bak 's/ssh /ssh -i '"$SSH_KEY"' /g' auto_setup_calendar.sh

    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    ./auto_setup_calendar.sh
else
    echo "‚ùå –û—à–∏–±–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞"
    exit 1
fi
