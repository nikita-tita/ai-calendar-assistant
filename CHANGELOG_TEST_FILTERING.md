# Changelog: Test Data Filtering in Analytics

## üéØ –¶–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò—Å–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ –ø—Ä–æ–¥–∞–∫—à–Ω –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ pytest –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç `generate_mock_data.py` —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–ª–∏—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ã–ª–∞ –∏—Å–∫–∞–∂–µ–Ω–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª**: `app/utils/test_detection.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**:
- –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö user_id (–∏–∑ pytest fixtures –∏ mock data)
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö username (regex –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
- –§—É–Ω–∫—Ü–∏—è `is_test_user(user_id, username)` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ pytest –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `os.environ['PYTEST_RUNNING']`
- –£—Ç–∏–ª–∏—Ç–∞ `mark_test_data_in_db()` –¥–ª—è —Ä–∞–∑–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–¢–µ—Å—Ç–æ–≤—ã–µ ID**:
```python
TEST_USER_IDS = {
    "123456789",              # conftest.py sample_user_id
    "test_user_12345",        # test_calendar_service.py
    "property_test_user_123", # test_property_service.py
    "1234567" - "7890123",    # Mock users
}
```

**–¢–µ—Å—Ç–æ–≤—ã–µ username –ø–∞—Ç—Ç–µ—Ä–Ω—ã**:
```python
TEST_USERNAME_PATTERNS = [
    "aibroker_bot",
    r"^test_user.*",
    r".*_test_.*",
    r"^property_test.*",
]
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–§–∞–π–ª**: `app/services/analytics_service.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `log_action()`**:
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `is_test: Optional[bool] = None`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `is_test_user()` –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –≤ –ë–î (–ø–æ–ª–µ `is_test` —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ!)

**–û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (–¥–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä `WHERE is_test = 0`):
- `get_dashboard_stats()` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `get_admin_stats()` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∫–∏
- `get_all_users_details()` - –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- `get_user_dialog()` - –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
- `get_activity_timeline()` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `get_recent_actions()` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
- `get_errors()` - –æ—à–∏–±–∫–∏
- `get_error_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
- `get_llm_cost_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM
- `get_action_distribution()` - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
- `get_user_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest

**–§–∞–π–ª**: `tests/conftest.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
```python
os.environ['PYTEST_RUNNING'] = '1'
```

–¢–µ–ø–µ—Ä—å –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è, –ª–æ–≥–∏—Ä—É–µ–º—ã–µ –≤–æ –≤—Ä–µ–º—è pytest, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `is_test=1`.

### 4. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª**: `scripts/cleanup_test_data.py`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
- –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ë–î (—Ç–µ—Å—Ç/–ø—Ä–æ–¥ –¥–∞–Ω–Ω—ã–µ)
- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ (`--dry-run`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
python scripts/cleanup_test_data.py --dry-run

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
python scripts/cleanup_test_data.py
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚ùå –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
- ‚ùå –ò—Å–∫–∞–∂—ë–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∏—á–∏—Ç—å —Ç–µ—Å—Ç –æ—Ç –ø—Ä–æ–¥–∞

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ß–∏—Å—Ç–∞—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª—å–Ω–æ (—É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä `is_test = 0`)

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ö–µ–º–∞ –ë–î (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–ü–æ–ª–µ `is_test` —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `actions`:
```sql
CREATE TABLE actions (
    ...
    is_test INTEGER DEFAULT 0,
    ...
)
```

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `is_test` –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
- ‚úÖ –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å —á–µ—Ä–µ–∑ `cleanup_test_data.py`

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `is_test` –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è (—Ñ–∏–ª—å—Ç—Ä –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º WHERE)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 1 —Ä–∞–∑ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
```bash
git pull
```

### –®–∞–≥ 2: –ü–æ–º–µ—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```bash
cd ai-calendar-assistant
python scripts/cleanup_test_data.py --dry-run  # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
python scripts/cleanup_test_data.py            # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
```bash
# Docker
docker-compose restart

# –ò–ª–∏ systemd
sudo systemctl restart telegram-bot
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º is_test
```python
analytics_service.log_action(
    user_id="12345",
    action_type=ActionType.TEXT_MESSAGE,
    details="Test message",
    is_test=True  # –Ø–≤–Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —Ç–µ—Å—Ç
)
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```python
analytics_service.log_action(
    user_id="test_user_12345",  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∫–∞–∫ —Ç–µ—Å—Ç
    action_type=ActionType.TEXT_MESSAGE,
    details="Test message"
    # is_test –Ω–µ —É–∫–∞–∑–∞–Ω - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
```python
# –í app/utils/test_detection.py
TEST_USERNAME_PATTERNS = [
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ...
    r"^new_test_pattern.*",  # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
]
```

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–†–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–º–µ—Ç–∫–∞**: –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ `cleanup_test_data.py` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. **Regex –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–ª–æ–∂–Ω—ã–µ regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å `is_test_user()`
3. **–†—É—á–Ω—ã–µ —Ç–µ—Å—Ç—ã**: –î–µ–π—Å—Ç–≤–∏—è –æ—Ç —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ –ø–æ–º–µ—á–∞—Ç—å —è–≤–Ω–æ

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `app/utils/test_detection.py` (–Ω–æ–≤—ã–π)
- ‚úÖ `app/services/analytics_service.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- ‚úÖ `tests/conftest.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- ‚úÖ `scripts/cleanup_test_data.py` (–Ω–æ–≤—ã–π)

–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
- `app/models/analytics.py` - –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- `app/routers/admin.py` - –∞–¥–º–∏–Ω–∫–∞
- `app/static/admin.html` - UI –∞–¥–º–∏–Ω–∫–∏
- `app/static/admin_report.html` - –æ—Ç—á—ë—Ç—ã

## ‚ú® –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: Cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø–æ–º–µ—Ç–∫–∏ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–ê–¥–º–∏–Ω UI**: –ö–Ω–æ–ø–∫–∞ "–ü–æ–º–µ—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ" –≤ –∞–¥–º–∏–Ω–∫–µ
3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å/–∏—Å–∫–ª—é—á–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ UI
4. **–ú–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –û—Ç–¥–µ–ª—å–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

**–î–∞—Ç–∞**: 2024-12-18  
**–ê–≤—Ç–æ—Ä**: AI Calendar Assistant Team  
**–í–µ—Ä—Å–∏—è**: 1.0.0

