# üéØ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### 1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã ‚úì

**–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã**:
- –ú–µ—Ç–æ–¥ `log_action()` –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä `is_test`
- –¢–µ—Å—Ç–æ–≤—ã–µ user_id –∏–∑ pytest –Ω–µ –ø–æ–º–µ—á–∞–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (—Ö–∞—Ä–¥–∫–æ–¥)
- SQL-–∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∫–ª—é—á–∞–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

### 2. –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ‚úì

#### `app/utils/test_detection.py` (–ù–û–í–´–ô)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
```python
# –¢–µ—Å—Ç–æ–≤—ã–µ user_id
TEST_USER_IDS = {
    "123456789",              # pytest conftest
    "test_user_12345",        # calendar tests
    "property_test_user_123", # property tests
    "1234567" - "7890123",    # mock data
}

# –¢–µ—Å—Ç–æ–≤—ã–µ username –ø–∞—Ç—Ç–µ—Ä–Ω—ã
TEST_USERNAME_PATTERNS = [
    "aibroker_bot",
    r"^test_user.*",
    r".*_test_.*",
    r"^property_test.*",
]

# –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
def is_test_user(user_id: str, username: Optional[str] = None) -> bool
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ regex –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ pytest –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `PYTEST_RUNNING`
- ‚úÖ –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–∑–æ–≤–æ–π –ø–æ–º–µ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### `scripts/cleanup_test_data.py` (–ù–û–í–´–ô)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
- –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ë–î
- Dry-run —Ä–µ–∂–∏–º (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```bash
# –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
python scripts/cleanup_test_data.py --dry-run

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
python scripts/cleanup_test_data.py
```

### 3. –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ‚úì

#### `app/services/analytics_service.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:

1. **–ò–º–ø–æ—Ä—Ç**:
```python
from app.utils.test_detection import is_test_user
```

2. **–ú–µ—Ç–æ–¥ `log_action()`**:
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `is_test: Optional[bool] = None`
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `is_test_user()` –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î: `is_test` ‚Üí `1 if is_test else 0`

3. **–í—Å–µ –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (11 –º–µ—Ç–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ):
- `get_dashboard_stats()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_admin_stats()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_all_users_details()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_user_dialog()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_activity_timeline()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_recent_actions()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_errors()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_error_stats()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_llm_cost_stats()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_action_distribution()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`
- `get_user_stats()` - –¥–æ–±–∞–≤–ª–µ–Ω `WHERE is_test = 0`

#### `tests/conftest.py`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```python
import os

# –ü–æ–º–µ—Ç–∫–∞ pytest –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ['PYTEST_RUNNING'] = '1'
```

–¢–µ–ø–µ—Ä—å –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤–æ –≤—Ä–µ–º—è pytest –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `is_test=1`.

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚úì

#### `CHANGELOG_TEST_FILTERING.md`
–ü–æ–ª–Ω—ã–π changelog —Å:
- –û–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ —Ä–µ—à–µ–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ telegram_handler.py (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π)           ‚îÇ
‚îÇ  ‚Ä¢ llm_agent_yandex.py (LLM –∑–∞–ø—Ä–æ—Å—ã)                   ‚îÇ
‚îÇ  ‚Ä¢ calendar_radicale.py (–∫–∞–ª–µ–Ω–¥–∞—Ä—å)                     ‚îÇ
‚îÇ  ‚Ä¢ todos_service.py (–∑–∞–¥–∞—á–∏)                            ‚îÇ
‚îÇ  ‚Ä¢ events.py (WebApp API)                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          analytics_service.log_action()                 ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  1. –ü–æ–ª—É—á–∞–µ—Ç user_id, username                         ‚îÇ
‚îÇ  2. –ï—Å–ª–∏ is_test=None:                                  ‚îÇ
‚îÇ     ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç is_test_user(user_id, username)         ‚îÇ
‚îÇ  3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î —Å —Ñ–ª–∞–≥–æ–º is_test                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            test_detection.is_test_user()                ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:                                             ‚îÇ
‚îÇ  1. os.environ['PYTEST_RUNNING'] == '1' ‚Üí True         ‚îÇ
‚îÇ  2. user_id in TEST_USER_IDS ‚Üí True                    ‚îÇ
‚îÇ  3. username matches TEST_USERNAME_PATTERNS ‚Üí True     ‚îÇ
‚îÇ  4. –ò–Ω–∞—á–µ ‚Üí False                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SQLite Database (actions)                  ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  user_id | action_type | is_test | timestamp | ...     ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  123456  | text_msg    |    0    | 2024-...  | ...     ‚îÇ
‚îÇ  test_u  | text_msg    |    1    | 2024-...  | ...     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          –ú–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º)                 ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  SELECT ... FROM actions WHERE is_test = 0              ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  ‚Üí –¢–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Pytest —Ç–µ—Å—Ç
```python
# tests/test_calendar.py
def test_create_event(test_user_id):  # "test_user_12345"
    # ...
    # –í–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è analytics_service.log_action()
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. `conftest.py` —É—Å—Ç–∞–Ω–æ–≤–∏–ª `PYTEST_RUNNING=1`
2. `log_action()` –≤—ã–∑—ã–≤–∞–µ—Ç `is_test_user("test_user_12345", None)`
3. `is_test_user()` –≤–∏–¥–∏—Ç `PYTEST_RUNNING=1` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`
4. –î–µ–π—Å—Ç–≤–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å `is_test=1`
5. ‚úÖ –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –†–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```python
# telegram_handler.py
analytics_service.log_action(
    user_id="987654321",
    username="real_user",
    action_type=ActionType.TEXT_MESSAGE
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. `log_action()` –≤—ã–∑—ã–≤–∞–µ—Ç `is_test_user("987654321", "real_user")`
2. `is_test_user()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
   - `PYTEST_RUNNING` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úì
   - `987654321` –Ω–µ –≤ `TEST_USER_IDS` ‚úì
   - `real_user` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ ‚úì
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
4. –î–µ–π—Å—Ç–≤–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å `is_test=0`
5. ‚úÖ –ü–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢–µ—Å—Ç–æ–≤—ã–π username
```python
analytics_service.log_action(
    user_id="999999",
    username="test_user_abc",  # –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å r"^test_user.*"
    action_type=ActionType.TEXT_MESSAGE
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. `is_test_user("999999", "test_user_abc")`
2. Regex –ø–∞—Ç—Ç–µ—Ä–Ω `r"^test_user.*"` —Å–æ–≤–ø–∞–¥–∞–µ—Ç
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`
4. –î–µ–π—Å—Ç–≤–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å `is_test=1`
5. ‚úÖ –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```bash
cd /Users/fatbookpro/ai-calendar-assistant

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
python -m pylint app/services/analytics_service.py
python -m pylint app/utils/test_detection.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pytest tests/ -v
```

### –®–∞–≥ 2: –ü–æ–º–µ—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```bash
cd ai-calendar-assistant

# –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
python scripts/cleanup_test_data.py --dry-run

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
python scripts/cleanup_test_data.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥**:
```
üßπ Test Data Cleanup Script
============================================================

üìä Current Database Statistics:
  Total actions:      1,234
  Test actions:       0 (0.0%)
  Production actions: 1,234 (100.0%)
  Test users:         0
  Production users:   15

üîç Preview of data to be marked as test:

1Ô∏è‚É£  Test User IDs:
  123456789: 45 actions
  test_user_12345: 23 actions
  ...

‚ö†Ô∏è  This will mark the above data as test data.
Continue? (yes/no): yes

üîÑ Marking test data...

‚úÖ Cleanup complete!
  Marked by user_id:  68 actions
  Marked by username: 12 actions
  Total marked:       80 actions

üìà Changes:
  Test actions:   0 ‚Üí 80 (+80)
  Prod actions:   1,234 ‚Üí 1,154 (-80)
  Test users:     0 ‚Üí 3 (+3)
  Prod users:     15 ‚Üí 12 (-3)

üéâ All done! Test data has been marked and will be excluded from analytics.
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
1. –û—Ç–∫—Ä—ã—Ç—å `https://your-domain/static/admin.html`
2. –í–æ–π—Ç–∏ —Å 3 –ø–∞—Ä–æ–ª—è–º–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã

#### –ß–µ—Ä–µ–∑ SQL
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
sqlite3 /var/lib/calendar-bot/analytics.db

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM actions WHERE is_test = 1;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∞–Ω–Ω—ã–µ
SELECT COUNT(*) FROM actions WHERE is_test = 0;

# –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT DISTINCT user_id FROM actions WHERE is_test = 1;
```

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```bash
# Docker
docker-compose restart

# Systemd
sudo systemctl restart telegram-bot
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: Pytest –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pytest tests/integration/test_calendar_service.py -v

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
sqlite3 /var/lib/calendar-bot/analytics.db \
  "SELECT COUNT(*) FROM actions WHERE user_id='test_user_12345' AND is_test=1;"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0
```

### –¢–µ—Å—Ç 2: –†–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
sqlite3 /var/lib/calendar-bot/analytics.db \
  "SELECT is_test FROM actions WHERE user_id='REAL_USER_ID' ORDER BY timestamp DESC LIMIT 1;"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

### –¢–µ—Å—Ç 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```bash
# –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
```

## üîß –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
–í—Å–µ –≤—ã–∑–æ–≤—ã `log_action()` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `is_test` —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ:
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
analytics_service.log_action(
    user_id="12345",
    action_type=ActionType.TEXT_MESSAGE,
    details="Hello"
)
# ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç! is_test –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è
```

### ‚úÖ –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ is_test (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ú–æ–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å `is_test` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:
```python
# –Ø–≤–Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —Ç–µ—Å—Ç
analytics_service.log_action(
    user_id="12345",
    action_type=ActionType.TEXT_MESSAGE,
    details="Test message",
    is_test=True  # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º
)
```

### ‚úÖ –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:
- –ò–º–µ—é—Ç `is_test=0` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ú–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å —á–µ—Ä–µ–∑ `cleanup_test_data.py`
- –ù–µ —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã (–ø–æ–ª–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ!)

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω:

```python
# app/utils/test_detection.py

TEST_USER_IDS = {
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ...
    "new_test_user_id",  # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π ID
}

TEST_USERNAME_PATTERNS = [
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ...
    r"^integration_test.*",  # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
]
```

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å `cleanup_test_data.py` –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å—ë –µ—â—ë –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ cleanup_test_data.py –±—ã–ª –∑–∞–ø—É—â–µ–Ω
python scripts/cleanup_test_data.py --dry-run

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –Ω–∞–ø—Ä—è–º—É—é
sqlite3 /var/lib/calendar-bot/analytics.db \
  "SELECT user_id, COUNT(*) FROM actions WHERE is_test=0 GROUP BY user_id;"

# 3. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–∏—Ç—å –≤ TEST_USER_IDS
# –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å cleanup_test_data.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: –†–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —Ç–µ—Å—Ç

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
# 2. –í—Ä—É—á–Ω—É—é –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ë–î
sqlite3 /var/lib/calendar-bot/analytics.db \
  "UPDATE actions SET is_test=0 WHERE user_id='REAL_USER_ID';"

# 3. –£–±—Ä–∞—Ç—å –∏–∑ TEST_USER_IDS –µ—Å–ª–∏ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ –æ—à–∏–±–∫–µ
```

### –ü—Ä–æ–±–ª–µ–º–∞: Pytest —Ç–µ—Å—Ç—ã –Ω–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å conftest.py
grep "PYTEST_RUNNING" tests/conftest.py

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
python -c "import os; os.environ['PYTEST_RUNNING']='1'; from app.utils.test_detection import is_test_user; print(is_test_user('any_id'))"
# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: True
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è
- ‚úÖ –ü—Ä–æ–¥–∞–∫—à–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∏—Å—Ç–∞—è –∏ —Ç–æ—á–Ω–∞—è
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –ù–µ—Ç —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** - —á–µ—Ä–µ–∑ `is_test_user()`
2. ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL** - –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
3. ‚úÖ **Pytest –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —á–µ—Ä–µ–∑ `PYTEST_RUNNING`
4. ‚úÖ **–£—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏** - `cleanup_test_data.py`
5. ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
6. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ø–æ–ª–Ω–∞—è –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `cleanup_test_data.py` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∞–¥–º–∏–Ω–∫–µ
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

---

**–î–∞—Ç–∞**: 2024-12-18  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–û–¢–û–í–û –ö –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–Æ  
**–í–µ—Ä—Å–∏—è**: 1.0.0

