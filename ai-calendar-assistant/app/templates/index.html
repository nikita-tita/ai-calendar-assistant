<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calendar Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #0b0b0b);
            color: var(--tg-theme-text-color, #ffffff);
            overscroll-behavior: none;
            touch-action: pan-y;
            padding-bottom: 20px;
        }
        .secondary-bg { background: var(--tg-theme-secondary-bg-color, #1a1a1a); }
        .tertiary-bg { background: rgba(255,255,255,0.05); }
        .button-bg { background: var(--tg-theme-button-color, #2563eb); color: var(--tg-theme-button-text-color, #ffffff); }
        .button-danger { background: #dc2626; color: #ffffff; }
        .hint-color { color: var(--tg-theme-hint-color, #9ca3af); }

        /* Light theme adaptations */
        body.light-theme .secondary-bg { background: var(--tg-theme-secondary-bg-color, #f5f5f5); }
        body.light-theme .tertiary-bg { background: rgba(0,0,0,0.05); }
        body.light-theme .calendar-day:hover { background: rgba(0,0,0,0.08); }
        body.light-theme .day-separator { background: rgba(255, 255, 255, 0.95); }
        body.light-theme .modal { background: rgba(0,0,0,0.5); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .day-separator {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
            background: rgba(11, 11, 11, 0.95);
        }
        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day:hover { background: rgba(255,255,255,0.1); }
        .calendar-day.selected { background: var(--tg-theme-button-color, #2563eb); }
        .calendar-day.today { border: 2px solid var(--tg-theme-button-color, #2563eb); }
        .calendar-day.has-events { position: relative; }
        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: var(--tg-theme-button-color, #2563eb);
            border-radius: 50%;
        }
        .event-card {
            position: relative;
            overflow: hidden;
        }
        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--tg-theme-button-color, #2563eb);
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="loading" class="modal" style="display:none;"><div class="spinner"></div></div>
    <div id="confirmModal" class="modal" style="display:none;">
        <div class="secondary-bg rounded-3xl p-6 max-w-sm mx-4 shadow-2xl">
            <div id="confirmText" class="text-lg mb-6 text-center"></div>
            <div class="flex gap-3">
                <button id="confirmCancel" class="tertiary-bg px-6 py-3 rounded-2xl flex-1 font-medium">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmOk" class="button-bg px-6 py-3 rounded-2xl flex-1 font-medium">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Version: 2025-10-28-17:30 - Complete rewrite with proper event handling
        const APP_VERSION = '2025-10-28-17:30';
        console.log('WebApp loaded, version:', APP_VERSION);

        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Detect and apply Telegram theme
        function applyTheme() {
            const colorScheme = tg.colorScheme || 'dark';
            if (colorScheme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            console.log('Theme applied:', colorScheme);
        }
        applyTheme();
        tg.onEvent('themeChanged', applyTheme);

        const urlParams = new URLSearchParams(window.location.search);
        const userId = tg.initDataUnsafe?.user?.id || urlParams.get('user_id');

        if (!userId) {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2>
                    <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</p>
                    <p>–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üìÖ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"</p>
                </div>
            `;
            throw new Error('No user ID');
        }

        console.log('User ID:', userId);

        // Translations
        const t = {
            today: '–°–µ–≥–æ–¥–Ω—è', tomorrow: '–ó–∞–≤—Ç—Ä–∞', yesterday: '–í—á–µ—Ä–∞',
            loading: '–ó–∞–≥—Ä—É–∑–∫–∞...', save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancel: '–û—Ç–º–µ–Ω–∞',
            delete: '–£–¥–∞–ª–∏—Ç—å', edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
            newEvent: '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ', editEvent: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ',
            title: '–ù–∞–∑–≤–∞–Ω–∏–µ', date: '–î–∞—Ç–∞', start: '–ù–∞—á–∞–ª–æ', end: '–ö–æ–Ω–µ—Ü',
            location: '–õ–æ–∫–∞—Ü–∏—è', note: '–ó–∞–º–µ—Ç–∫–∞', noEvents: '–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π',
            confirmDelete: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?',
            confirmSave: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
            myEvents: '–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è',
            months: ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"],
            monthsGen: ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"],
            days: ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"]
        };

        // Application state
        const state = {
            view: 'list', // 'list' | 'detail' | 'edit'
            events: [],
            selectedDate: new Date(),
            currentMonth: new Date(),
            showCalendar: false,
            viewEvent: null,
            edit: null
        };

        // Utility functions
        function toDateInputValue(d) {
            return d.toISOString().split('T')[0];
        }

        function toTimeInputValue(d) {
            return d.toISOString().split('T')[1].substring(0,5);
        }

        function fmtTime(d) {
            const date = new Date(d);
            const hh = String(date.getHours()).padStart(2,'0');
            const mm = String(date.getMinutes()).padStart(2,'0');
            return `${hh}:${mm}`;
        }

        function fmtDate(d) {
            const date = new Date(d);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (sameDay(date, today)) return t.today;
            if (sameDay(date, tomorrow)) return t.tomorrow;
            if (sameDay(date, yesterday)) return t.yesterday;

            return `${date.getDate()} ${t.monthsGen[date.getMonth()]}`;
        }

        function sameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        function hasEventsOnDate(date) {
            return state.events.some(e => sameDay(new Date(e.start), date));
        }

        function getMonthDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevMonthLastDay = new Date(year, month, 0);

            const days = [];
            const firstWeekday = (firstDay.getDay() + 6) % 7;

            for (let i = firstWeekday - 1; i >= 0; i--) {
                const date = new Date(prevMonthLastDay);
                date.setDate(date.getDate() - i);
                days.push({ date, current: false });
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                days.push({ date: new Date(year, month, day), current: true });
            }

            const remaining = (7 - (days.length % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                days.push({ date: new Date(year, month + 1, i), current: false });
            }

            return days;
        }

        // Modal functions
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        let confirmCallback = null;

        function showConfirm(text, callback) {
            document.getElementById('confirmText').textContent = text;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = callback;
        }

        function closeConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        async function execConfirm() {
            if (confirmCallback) {
                closeConfirm();
                await confirmCallback();
            }
        }

        // Set up confirm modal buttons
        document.getElementById('confirmCancel').onclick = closeConfirm;
        document.getElementById('confirmOk').onclick = execConfirm;

        // API functions
        async function loadEvents() {
            showLoading();
            try {
                const start = new Date(state.selectedDate);
                start.setDate(start.getDate() - 7);
                const end = new Date(state.selectedDate);
                end.setDate(end.getDate() + 30);

                console.log('Loading events for user:', userId);
                console.log('Date range:', start.toISOString(), 'to', end.toISOString());

                const url = `/api/events/${userId}?start=${start.toISOString()}&end=${end.toISOString()}`;
                console.log('Fetching:', url);

                const res = await fetch(url);
                console.log('Response status:', res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();
                console.log('Loaded events:', data.length);

                state.events = data.map(e => ({
                    ...e,
                    start: new Date(e.start),
                    end: new Date(e.end)
                }));

                render();
            } catch(e) {
                console.error('Error loading events:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        async function saveEvent() {
            try {
                const title = document.getElementById('editTitle')?.value.trim() || 'No title';
                const dateInput = document.getElementById('editDate')?.value;
                const startTimeInput = document.getElementById('editStartTime')?.value;
                const endTimeInput = document.getElementById('editEndTime')?.value;

                if (!dateInput || !startTimeInput || !endTimeInput) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }

                const date = new Date(dateInput);
                const [startHH, startMM] = startTimeInput.split(':');
                const [endHH, endMM] = endTimeInput.split(':');
                const start = new Date(date);
                start.setHours(parseInt(startHH), parseInt(startMM), 0, 0);
                const end = new Date(date);
                end.setHours(parseInt(endHH), parseInt(endMM), 0, 0);

                const event = {
                    title,
                    start: start.toISOString(),
                    end: end.toISOString(),
                    location: document.getElementById('editLocation')?.value || '',
                    description: document.getElementById('editNote')?.value || '',
                    color: 'blue'
                };

                console.log('Saving event:', event);

                showConfirm(t.confirmSave, async () => {
                    showLoading();
                    try {
                        const url = state.edit.id
                            ? `/api/events/${userId}/${state.edit.id}`
                            : `/api/events/${userId}`;
                        const method = state.edit.id ? 'PUT' : 'POST';

                        console.log(`${method} ${url}`);

                        const response = await fetch(url, {
                            method,
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(event)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }

                        console.log('Event saved successfully');

                        state.edit = null;
                        state.viewEvent = null;
                        state.view = 'list';
                        state.selectedDate = new Date(start);
                        state.selectedDate.setHours(0, 0, 0, 0);

                        await loadEvents();
                    } catch(e) {
                        console.error('Error saving event:', e);
                        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message);
                    } finally {
                        hideLoading();
                    }
                });
            } catch(e) {
                console.error('Error in saveEvent:', e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function deleteEvent(id) {
            console.log('Delete event:', id);

            showConfirm(t.confirmDelete, async () => {
                showLoading();
                try {
                    const url = `/api/events/${userId}/${id}`;
                    console.log(`DELETE ${url}`);

                    const response = await fetch(url, { method: 'DELETE' });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    console.log('Event deleted successfully');

                    state.edit = null;
                    state.viewEvent = null;
                    state.view = 'list';

                    await loadEvents();
                } catch(e) {
                    console.error('Error deleting event:', e);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
                } finally {
                    hideLoading();
                }
            });
        }

        // Navigation functions - MUST be global
        window.viewEvent = function(id) {
            console.log('viewEvent called:', id);
            const event = state.events.find(e => e.id === id);
            if (!event) {
                console.error('Event not found:', id);
                return;
            }
            state.viewEvent = event;
            state.view = 'detail';
            render();
        };

        window.openEdit = function(id = null) {
            console.log('openEdit called:', id);
            if (id) {
                const e = state.events.find(ev => ev.id === id);
                if (!e) {
                    console.error('Event not found for editing:', id);
                    return;
                }
                state.edit = { ...e, start: new Date(e.start), end: new Date(e.end) };
            } else {
                const now = new Date(state.selectedDate);
                now.setHours(9,0,0,0);
                const end = new Date(now);
                end.setHours(10,0,0,0);
                state.edit = { id: null, title: '', start: now, end, location: '', description: '', color: 'blue' };
            }
            state.view = 'edit';
            render();
        };

        window.closeEdit = function() {
            state.edit = null;
            state.view = 'list';
            render();
        };

        window.closeDetail = function() {
            state.viewEvent = null;
            state.view = 'list';
            render();
        };

        window.toggleCalendar = function() {
            state.showCalendar = !state.showCalendar;
            render();
        };

        window.selectDate = function(timestamp) {
            state.selectedDate = new Date(timestamp);
            state.showCalendar = false;
            render();
        };

        window.prevMonth = function() {
            state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
            render();
        };

        window.nextMonth = function() {
            state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
            render();
        };

        window.goToToday = function() {
            state.selectedDate = new Date();
            state.currentMonth = new Date();
            state.showCalendar = false;
            render();
        };

        window.saveEvent = saveEvent;
        window.deleteEvent = deleteEvent;

        function groupEventsByDay(events, fromDate, daysCount = 30) {
            const grouped = {};
            const currentDate = new Date(fromDate);
            for (let i = 0; i < daysCount; i++) {
                const dateKey = toDateInputValue(currentDate);
                grouped[dateKey] = [];
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const sorted = events
                .filter(e => e.start >= fromDate)
                .sort((a,b) => a.start - b.start);

            sorted.forEach(e => {
                const dateKey = toDateInputValue(e.start);
                if (grouped[dateKey]) {
                    grouped[dateKey].push(e);
                }
            });

            return grouped;
        }

        function render() {
            const app = document.getElementById('app');

            if (state.view === 'list') {
                const fromDate = new Date(state.selectedDate);
                fromDate.setHours(0,0,0,0);
                const grouped = groupEventsByDay(state.events, fromDate, 30);
                const dateKeys = Object.keys(grouped);

                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="secondary-bg p-4 sticky top-0 z-20 shadow-lg">
                            <h1 class="text-2xl font-bold mb-3">${t.myEvents}</h1>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleCalendar()" class="tertiary-bg px-4 py-2 rounded-xl flex-1 text-left flex items-center justify-between">
                                    <span>${fmtDate(state.selectedDate)}</span>
                                    <span class="text-xl">üìÖ</span>
                                </button>
                                <button onclick="goToToday()" class="tertiary-bg px-4 py-2 rounded-xl">${t.today}</button>
                            </div>
                        </div>

                        ${state.showCalendar ? `
                            <div class="secondary-bg p-4 border-t border-gray-800">
                                <div class="flex items-center justify-between mb-4">
                                    <button onclick="prevMonth()" class="tertiary-bg w-10 h-10 rounded-xl">‚Üê</button>
                                    <div class="font-semibold">${t.months[state.currentMonth.getMonth()]} ${state.currentMonth.getFullYear()}</div>
                                    <button onclick="nextMonth()" class="tertiary-bg w-10 h-10 rounded-xl">‚Üí</button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 mb-2">
                                    ${t.days.map(d => `<div class="text-center text-xs hint-color py-1">${d}</div>`).join('')}
                                </div>
                                <div class="grid grid-cols-7 gap-1">
                                    ${getMonthDays(state.currentMonth.getFullYear(), state.currentMonth.getMonth()).map(d => {
                                        const isToday = sameDay(d.date, new Date());
                                        const isSelected = sameDay(d.date, state.selectedDate);
                                        const hasEvents = hasEventsOnDate(d.date);
                                        return `
                                            <div
                                                onclick="selectDate(${d.date.getTime()})"
                                                class="calendar-day ${isSelected ? 'selected' : ''} ${isToday ? 'today' : ''} ${hasEvents ? 'has-events' : ''} ${!d.current ? 'opacity-30' : ''}"
                                            >
                                                ${d.date.getDate()}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="p-4">
                            <button onclick="openEdit()" class="button-bg w-full py-3 rounded-2xl mb-4 font-medium shadow-lg">
                                + ${t.newEvent}
                            </button>

                            ${dateKeys.map(dateKey => {
                                const dayEvents = grouped[dateKey];
                                const dayDate = new Date(dateKey);
                                return `
                                    <div class="mb-6">
                                        <div class="day-separator px-2 py-2 mb-2">
                                            <div class="font-semibold text-lg">${fmtDate(dayDate)}</div>
                                            <div class="hint-color text-sm">${t.days[(dayDate.getDay() + 6) % 7]}</div>
                                        </div>
                                        ${dayEvents.length === 0 ? `
                                            <div class="text-center hint-color py-4 text-sm">${t.noEvents}</div>
                                        ` : `
                                            <div class="space-y-2">
                                                ${dayEvents.map(e => `
                                                    <div onclick="viewEvent('${e.id}')" class="event-card secondary-bg p-4 rounded-2xl cursor-pointer hover:opacity-80 transition pl-6">
                                                        <div class="flex items-start justify-between">
                                                            <div class="flex-1">
                                                                <div class="font-semibold mb-1">${e.title}</div>
                                                                <div class="hint-color text-sm">${fmtTime(e.start)} ‚Äì ${fmtTime(e.end)}</div>
                                                                ${e.location ? `<div class="hint-color text-sm mt-1">üìç ${e.location}</div>` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (state.view === 'detail' && state.viewEvent) {
                const e = state.viewEvent;
                app.innerHTML = `
                    <div class="min-h-screen p-4">
                        <button onclick="closeDetail()" class="mb-4 hint-color flex items-center gap-2">
                            <span class="text-xl">‚Üê</span> ${t.cancel}
                        </button>
                        <div class="secondary-bg p-6 rounded-3xl shadow-xl">
                            <h2 class="text-2xl font-bold mb-4">${e.title}</h2>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìÖ</span>
                                    <div>
                                        <div class="font-medium">${fmtDate(e.start)}</div>
                                        <div class="hint-color text-sm">${fmtTime(e.start)} ‚Äì ${fmtTime(e.end)}</div>
                                    </div>
                                </div>
                                ${e.location ? `
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">üìç</span>
                                        <div class="font-medium">${e.location}</div>
                                    </div>
                                ` : ''}
                                ${e.description ? `
                                    <div class="flex items-start gap-3 mt-4">
                                        <span class="text-2xl">üìù</span>
                                        <div class="flex-1">${e.description}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-6 flex gap-3">
                            <button onclick="openEdit('${e.id}')" class="button-bg flex-1 py-4 rounded-2xl font-medium shadow-lg">
                                ${t.edit}
                            </button>
                            <button onclick="deleteEvent('${e.id}')" class="button-danger flex-1 py-4 rounded-2xl font-medium shadow-lg">
                                ${t.delete}
                            </button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'edit') {
                app.innerHTML = `
                    <div class="min-h-screen p-4">
                        <button onclick="closeEdit()" class="mb-4 hint-color flex items-center gap-2">
                            <span class="text-xl">‚Üê</span> ${t.cancel}
                        </button>
                        <h2 class="text-2xl font-bold mb-6">${state.edit.id ? t.editEvent : t.newEvent}</h2>
                        <div class="space-y-4">
                            <label class="block">
                                <span class="text-sm hint-color mb-2 block">${t.title}</span>
                                <input id="editTitle" value="${state.edit.title||''}"
                                    class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base"
                                    placeholder="${t.title}"/>
                            </label>
                            <label class="block">
                                <span class="text-sm hint-color mb-2 block">${t.date}</span>
                                <input id="editDate" type="date" value="${toDateInputValue(state.edit.start)}"
                                    class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base"/>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.start}</span>
                                    <input id="editStartTime" type="time" value="${toTimeInputValue(state.edit.start)}"
                                        class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base"/>
                                </label>
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.end}</span>
                                    <input id="editEndTime" type="time" value="${toTimeInputValue(state.edit.end)}"
                                        class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base"/>
                                </label>
                            </div>
                            <label class="block">
                                <span class="text-sm hint-color mb-2 block">${t.location}</span>
                                <input id="editLocation" value="${state.edit.location||''}"
                                    class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base"
                                    placeholder="${t.location}"/>
                            </label>
                            <label class="block">
                                <span class="text-sm hint-color mb-2 block">${t.note}</span>
                                <textarea id="editNote" rows="4"
                                    class="secondary-bg w-full px-4 py-3 rounded-2xl outline-none text-base resize-none"
                                    placeholder="${t.note}">${state.edit.description||''}</textarea>
                            </label>
                            <div class="flex gap-3 mt-6 pt-4">
                                <button onclick="closeEdit()" class="tertiary-bg flex-1 py-4 rounded-2xl font-medium">
                                    ${t.cancel}
                                </button>
                                <button onclick="saveEvent()" class="button-bg flex-1 py-4 rounded-2xl font-medium shadow-lg">
                                    ${t.save}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize
        loadEvents();
    </script>
</body>
</html>
