<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –¥–µ–ª</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .add-todo-form {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .add-todo-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .add-todo-button {
            padding: 12px 24px;
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .add-todo-button:hover {
            opacity: 0.9;
        }

        .add-todo-button:active {
            opacity: 0.7;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-button {
            padding: 8px 16px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-button.active {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-button-color, #0088cc);
        }

        .todos-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 8px;
            gap: 12px;
            transition: opacity 0.2s;
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .todo-title {
            font-size: 16px;
        }

        .todo-title.completed {
            text-decoration: line-through;
        }

        .todo-meta {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }

        .todo-delete {
            padding: 8px 12px;
            background-color: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        .todo-delete:active {
            opacity: 0.7;
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--tg-theme-hint-color, #999);
        }

        .loading {
            text-align: center;
            padding: 24px;
            color: var(--tg-theme-hint-color, #999);
        }

        .error {
            padding: 12px;
            background-color: #ff3b30;
            color: white;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .priority-high {
            background-color: #ff3b30;
            color: white;
        }

        .priority-medium {
            background-color: #ff9500;
            color: white;
        }

        .priority-low {
            background-color: #34c759;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù –°–ø–∏—Å–æ–∫ –¥–µ–ª</h1>
    </div>

    <div class="add-todo-form">
        <input
            type="text"
            class="add-todo-input"
            id="newTodoInput"
            placeholder="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É..."
            autocomplete="off"
        >
        <button class="add-todo-button" id="addTodoButton">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="filters">
        <button class="filter-button active" data-filter="all">–í—Å–µ</button>
        <button class="filter-button" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="filter-button" data-filter="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>

    <div id="error"></div>
    <div id="loading" class="loading" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="todosList" class="todos-list"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const API_BASE = window.location.origin + '/api';
        let currentFilter = 'all';
        let todos = [];

        // Get user ID from Telegram WebApp
        const userId = tg.initDataUnsafe?.user?.id?.toString();
        if (!userId) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram');
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        // Get init data for authentication
        function getInitData() {
            return tg.initData;
        }

        // Fetch todos from API
        async function fetchTodos() {
            if (!userId) return;

            try {
                document.getElementById('loading').style.display = 'block';

                const url = new URL(`${API_BASE}/todos/${userId}`);
                if (currentFilter === 'active') {
                    url.searchParams.append('completed', 'false');
                } else if (currentFilter === 'completed') {
                    url.searchParams.append('completed', 'true');
                }

                const response = await fetch(url, {
                    headers: {
                        'X-Telegram-Init-Data': getInitData()
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                todos = await response.json();
                renderTodos();
            } catch (error) {
                console.error('Error fetching todos:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Render todos
        function renderTodos() {
            const todosList = document.getElementById('todosList');

            if (todos.length === 0) {
                todosList.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
                return;
            }

            todosList.innerHTML = todos.map(todo => {
                const priorityLabel = {
                    'high': '–í—ã—Å–æ–∫–∏–π',
                    'medium': '–°—Ä–µ–¥–Ω–∏–π',
                    'low': '–ù–∏–∑–∫–∏–π'
                };

                return `
                    <div class="todo-item ${todo.completed ? 'completed' : ''}">
                        <input
                            type="checkbox"
                            class="todo-checkbox"
                            ${todo.completed ? 'checked' : ''}
                            onchange="toggleTodo('${todo.id}')"
                        >
                        <div class="todo-content">
                            <div class="todo-title ${todo.completed ? 'completed' : ''}">
                                ${escapeHtml(todo.title)}
                                <span class="priority-badge priority-${todo.priority}">
                                    ${priorityLabel[todo.priority]}
                                </span>
                            </div>
                            ${todo.notes ? `<div class="todo-meta">${escapeHtml(todo.notes)}</div>` : ''}
                            ${todo.due_date ? `<div class="todo-meta">–°—Ä–æ–∫: ${formatDate(todo.due_date)}</div>` : ''}
                        </div>
                        <button class="todo-delete" onclick="deleteTodo('${todo.id}')">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Toggle todo completion
        async function toggleTodo(todoId) {
            try {
                const response = await fetch(`${API_BASE}/todos/${userId}/${todoId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'X-Telegram-Init-Data': getInitData()
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                await fetchTodos();
            } catch (error) {
                console.error('Error toggling todo:', error);
                showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
                await fetchTodos(); // Refresh to restore state
            }
        }

        // Delete todo
        async function deleteTodo(todoId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/todos/${userId}/${todoId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Telegram-Init-Data': getInitData()
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                await fetchTodos();
            } catch (error) {
                console.error('Error deleting todo:', error);
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
            }
        }

        // Add new todo
        async function addTodo() {
            const input = document.getElementById('newTodoInput');
            const title = input.value.trim();

            if (!title) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/todos/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': getInitData()
                    },
                    body: JSON.stringify({
                        title: title,
                        completed: false,
                        priority: 'medium'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                input.value = '';
                await fetchTodos();
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error('Error adding todo:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // Filter todos
        function setFilter(filter) {
            currentFilter = filter;

            // Update filter buttons
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            fetchTodos();
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long'
            });
        }

        // Event listeners
        document.getElementById('addTodoButton').addEventListener('click', addTodo);
        document.getElementById('newTodoInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.addEventListener('click', () => {
                setFilter(btn.dataset.filter);
            });
        });

        // Make functions global for onclick handlers
        window.toggleTodo = toggleTodo;
        window.deleteTodo = deleteTodo;

        // Initial load
        fetchTodos();
    </script>
</body>
</html>
