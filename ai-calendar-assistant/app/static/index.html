<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calendar Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Custom Properties - Dark theme (default) */
        :root {
            --bg-primary: #0b0b0b;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: rgba(255,255,255,0.05);
            --text-primary: #ffffff;
            --text-hint: #9ca3af;
            --text-debug: #888888;
            --accent-color: #181A20;
            --button-bg: #181A20;
            --button-text: #ffffff;
            --button-danger-bg: #333333;
            --button-danger-text: #ffffff;
            --modal-overlay: rgba(0,0,0,0.85);
            --day-separator-bg: rgba(11, 11, 11, 0.95);
            --calendar-hover: rgba(255,255,255,0.1);
            --spinner-border: rgba(255,255,255,0.3);
            --spinner-top: #ffffff;
            --border-color: #262626;
        }

        /* Light theme overrides */
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: rgba(0,0,0,0.05);
            --text-primary: #000000;
            --text-hint: #6b7280;
            --text-debug: #666666;
            --accent-color: #3b82f6;
            --button-bg: #3b82f6;
            --button-text: #ffffff;
            --button-danger-bg: #ef4444;
            --button-danger-text: #ffffff;
            --modal-overlay: rgba(0,0,0,0.5);
            --day-separator-bg: rgba(255, 255, 255, 0.95);
            --calendar-hover: rgba(0,0,0,0.08);
            --spinner-border: rgba(0,0,0,0.2);
            --spinner-top: #3b82f6;
            --border-color: #e5e5e5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, var(--bg-primary));
            color: var(--tg-theme-text-color, var(--text-primary));
            overscroll-behavior: none;
            touch-action: pan-y;
            padding-bottom: 20px;
        }
        .secondary-bg { background: var(--tg-theme-secondary-bg-color, var(--bg-secondary)); }
        .tertiary-bg { background: var(--bg-tertiary); }
        .button-bg { background: var(--button-bg); color: var(--button-text); }
        .button-danger { background: var(--button-danger-bg); color: var(--button-danger-text); }
        .hint-color { color: var(--tg-theme-hint-color, var(--text-hint)); }
        .border-theme { border-color: var(--border-color); }

        .modal { position: fixed; inset: 0; background: var(--modal-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 3px solid var(--spinner-border); border-top: 3px solid var(--spinner-top); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .day-separator {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
            background: var(--day-separator-bg);
        }
        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day:hover { background: var(--calendar-hover); }
        .calendar-day.selected { background: var(--accent-color); }
        .calendar-day.today { border: 2px solid var(--accent-color); }
        .calendar-day.has-events { position: relative; }
        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: var(--accent-color);
            border-radius: 50%;
        }
        .event-card {
            position: relative;
            overflow: hidden;
        }
        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-color);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="modal" style="display:flex;">
            <div class="spinner"></div>
        </div>
    </div>
    <div id="loading" class="modal" style="display:none;"><div class="spinner"></div></div>
    <div id="confirmModal" class="modal" style="display:none;">
        <div class="secondary-bg rounded-xl p-6 max-w-sm mx-4 shadow-2xl">
            <div id="confirmText" class="text-lg mb-6 text-center"></div>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="tertiary-bg px-6 py-3 rounded-lg flex-1 font-medium"></button>
                <button id="confirmBtn" onclick="execConfirm()" class="button-bg px-6 py-3 rounded-lg flex-1 font-medium"></button>
            </div>
        </div>
    </div>
    <div id="settingsModal" class="modal" style="display:none;">
        <div class="secondary-bg rounded-xl p-6 max-w-sm mx-4 shadow-2xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="closeSettings()" class="hint-color text-2xl">&times;</button>
            </div>
            <div class="space-y-3">
                <button onclick="openSupport()" class="tertiary-bg w-full px-4 py-4 rounded-lg flex items-center gap-3 text-left">
                    <span class="text-2xl">üí¨</span>
                    <div>
                        <div class="font-medium">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</div>
                        <div class="text-sm hint-color">–ü–æ–∂–µ–ª–∞–Ω–∏—è, –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Version: 2025-12-05-v1 - Design System alignment (gray palette, Inter font, reduced border-radius)
        const APP_VERSION = '2026-01-11-v1';

        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;

        if (!tg) {
            console.error('Telegram WebApp SDK not loaded!');
            document.getElementById('app').innerHTML = `
                <div style="padding: 40px; text-align: center; font-family: Arial;">
                    <h2>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                    <p>Telegram WebApp SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                </div>
            `;
        } else {
            tg.ready();
            tg.expand();

            // Wait for WebApp to be ready
            setTimeout(initApp, 100);
        }

        function initApp() {
            console.log('Initializing app...');
            console.log('tg.initDataUnsafe:', tg.initDataUnsafe);

            // Detect and apply Telegram theme
            function applyTheme() {
                const colorScheme = tg.colorScheme || 'dark';
                if (colorScheme === 'light') {
                    document.body.classList.add('light-theme');
                } else {
                    document.body.classList.remove('light-theme');
                }
                console.log('Theme applied:', colorScheme);
            }
            applyTheme();
            tg.onEvent('themeChanged', applyTheme);

            const urlParams = new URLSearchParams(window.location.search);

            // Get userId from Telegram ONLY (no fallback to URL)
            const userId = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : null;

            console.log('User ID:', userId);

            if (!userId) {
                console.error('No user ID found');
                document.getElementById('app').innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: Arial;">
                        <h2>‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
                        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.</p>
                        <p style="margin-top: 20px; font-size: 12px; color: var(--text-debug);">
                            Debug: initDataUnsafe=${JSON.stringify(tg.initDataUnsafe)}<br>
                            initData available: ${tg.initData ? 'Yes' : 'No'}
                        </p>
                    </div>
                `;
                return;
            }

            // Get initData for authentication
            const initData = tg.initData;
            if (!initData) {
                console.error('No initData found - authentication will fail');
            }

            const userLang = urlParams.get('lang') || 'ru';

            // Translations
            const i18n = {
                ru: {
                    today: '–°–µ–≥–æ–¥–Ω—è', tomorrow: '–ó–∞–≤—Ç—Ä–∞', yesterday: '–í—á–µ—Ä–∞', loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                    save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancel: '–û—Ç–º–µ–Ω–∞', delete: '–£–¥–∞–ª–∏—Ç—å', edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                    newEvent: '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ', editEvent: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ',
                    title: '–ù–∞–∑–≤–∞–Ω–∏–µ', date: '–î–∞—Ç–∞', start: '–ù–∞—á–∞–ª–æ', end: '–ö–æ–Ω–µ—Ü',
                    location: '–õ–æ–∫–∞—Ü–∏—è', note: '–ó–∞–º–µ—Ç–∫–∞', color: '–¶–≤–µ—Ç',
                    confirm: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', no: '–ù–µ—Ç', yes: '–î–∞', noEvents: '–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π',
                    confirmDelete: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?', confirmSave: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
                    selectDate: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', myEvents: '–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è',
                    events: '–°–æ–±—ã—Ç–∏—è', todos: '–ó–∞–¥–∞—á–∏', myTodos: '–ú–æ–∏ –∑–∞–¥–∞—á–∏',
                    noTodos: '–ù–µ—Ç –∑–∞–¥–∞—á', completed: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', active: '–ê–∫—Ç–∏–≤–Ω—ã–µ',
                    months: ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"],
                    monthsGen: ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"],
                    days: ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"]
                }
            };

            const t = i18n[userLang] || i18n.ru;

            // State management
            const state = {
                events: [],
                todos: [],
                selectedDate: new Date(),
                currentMonth: new Date(),
                showCalendar: false,
                view: 'list', // 'list' | 'detail' | 'edit' | 'todo-edit'
                viewEvent: null,
                edit: {},
                activeTab: 'events', // 'events' | 'todos'
                editingTodo: null // Currently editing todo
            };

            // Flag to prevent scroll on every render (only scroll on initial load)
            let initialScrollDone = false;

            // Utility functions
            function fmtDate(d) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (sameDay(d, today)) return t.today;
                if (sameDay(d, tomorrow)) return t.tomorrow;
                if (sameDay(d, yesterday)) return t.yesterday;
                return `${d.getDate()} ${t.monthsGen[d.getMonth()]}`;
            }

            function sameDay(d1, d2) {
                return d1.getDate() === d2.getDate() && d1.getMonth() === d2.getMonth() && d1.getFullYear() === d2.getFullYear();
            }

            function fmtTime(d) {
                return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            }

            // XSS protection - escape HTML entities
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // XSS protection for HTML attributes (escapes quotes)
            function escapeAttr(text) {
                if (!text) return '';
                return String(text)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            // SEC-003: Safe ID escaping for onclick handlers
            // Validates UUID format and escapes for use in JS strings
            function safeId(id) {
                if (!id) return '';
                const str = String(id);
                // UUID format validation (basic check for safety)
                if (!/^[\w-]+$/.test(str)) {
                    console.warn('Invalid ID format:', str);
                    return '';
                }
                return escapeAttr(str);
            }

            function toDateInputValue(d) {
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }

            function toTimeInputValue(d) {
                return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            }

            function showLoading() {
                document.getElementById('loading').style.display = 'flex';
            }

            function hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            // API functions
            async function loadEvents() {
                showLoading();
                try {
                    const start = new Date();
                    start.setDate(start.getDate() - 90);
                    start.setHours(0,0,0,0);
                    const end = new Date();
                    end.setDate(end.getDate() + 90);
                    end.setHours(23,59,59,999);

                    const res = await fetch(`/api/events/${userId}?start=${start.toISOString()}&end=${end.toISOString()}`, {
                        headers: {
                            'X-Telegram-Init-Data': initData
                        }
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    state.events = await res.json();
                    console.log('Events loaded:', state.events.length);
                    render();
                } catch(e) {
                    console.error('Error loading events:', e);
                    document.getElementById('app').innerHTML = `
                        <div style="padding: 40px; text-align: center; font-family: Arial;">
                            <h2>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è.</p>
                            <p style="font-size: 12px; color: var(--text-debug); margin-top: 20px;">${e.message}</p>
                            <button onclick="location.reload()" class="button-bg px-6 py-3 rounded-lg mt-4">
                                –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    `;
                } finally {
                    hideLoading();
                }
            }

            async function loadTodos() {
                try {
                    const res = await fetch(`/api/todos/${userId}`, {
                        headers: {
                            'X-Telegram-Init-Data': initData
                        }
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    state.todos = await res.json();
                    console.log('Todos loaded:', state.todos.length);
                    render();
                } catch(e) {
                    console.error('Error loading todos:', e);
                    state.todos = [];
                    render();
                }
            }

            window.viewEvent = function(id) {
                state.viewEvent = state.events.find(e => e.id === id);
                state.view = 'detail';
                render();
            };

            window.openEdit = function(id = null) {
                if (id) {
                    const e = state.events.find(ev => ev.id === id);
                    if (!e) return;
                    state.edit = { ...e, start: new Date(e.start), end: new Date(e.end) };
                } else {
                    const now = new Date(state.selectedDate);
                    now.setHours(12, 0, 0, 0);
                    const end = new Date(now);
                    end.setHours(13, 0, 0, 0);
                    state.edit = { title: '', start: now, end, location: '', description: '', color: 'blue' };
                }
                state.view = 'edit';
                render();
            };

            window.closeEdit = function() {
                state.view = 'list';
                render();
            };

            window.saveEvent = async function() {
                const title = document.getElementById('editTitle').value.trim();
                const dateVal = document.getElementById('editDate').value;
                const startTime = document.getElementById('editStartTime').value;
                const endTime = document.getElementById('editEndTime').value;
                const location = document.getElementById('editLocation').value.trim();
                const description = document.getElementById('editNote').value.trim();

                if (!title) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è');
                    return;
                }

                const start = new Date(`${dateVal}T${startTime}:00`);
                const end = new Date(`${dateVal}T${endTime}:00`);

                const event = {
                    title,
                    start: start.toISOString(),
                    end: end.toISOString(),
                    location,
                    description,
                    color: 'blue'
                };

                showLoading();
                try {
                    let res;
                    if (state.edit.id) {
                        res = await fetch(`/api/events/${userId}/${state.edit.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Telegram-Init-Data': initData
                            },
                            body: JSON.stringify(event)
                        });
                    } else {
                        res = await fetch(`/api/events/${userId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Telegram-Init-Data': initData
                            },
                            body: JSON.stringify(event)
                        });
                    }

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    await loadEvents();
                    state.view = 'list';
                    render();
                } catch(e) {
                    console.error('Save error:', e);
                    tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message);
                } finally {
                    hideLoading();
                }
            };

            window.deleteEvent = function(id) {
                confirmAction(t.confirmDelete, async () => {
                    showLoading();
                    try {
                        const res = await fetch(`/api/events/${userId}/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Telegram-Init-Data': initData
                            }
                        });
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        await loadEvents();
                        state.view = 'list';
                        render();
                    } catch(e) {
                        console.error('Delete error:', e);
                        tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
                    } finally {
                        hideLoading();
                    }
                });
            };

            // Calendar functions
            function groupEventsByDay(events, fromDate, days) {
                const result = {};
                for (let i = 0; i < days; i++) {
                    const d = new Date(fromDate);
                    d.setDate(d.getDate() + i);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    result[key] = events.filter(e => {
                        const eDate = new Date(e.start);
                        return sameDay(eDate, d);
                    }).sort((a, b) => new Date(a.start) - new Date(b.start));
                }
                return result;
            }

            function getMonthDays(year, month) {
                const first = new Date(year, month, 1);
                const last = new Date(year, month + 1, 0);
                const days = [];

                let startDay = first.getDay();
                if (startDay === 0) startDay = 7;
                startDay--;

                for (let i = 0; i < startDay; i++) {
                    const d = new Date(year, month, 1 - (startDay - i));
                    days.push({ date: d, current: false });
                }

                for (let i = 1; i <= last.getDate(); i++) {
                    days.push({ date: new Date(year, month, i), current: true });
                }

                while (days.length % 7 !== 0) {
                    const lastDate = days[days.length - 1].date;
                    days.push({ date: new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate() + 1), current: false });
                }

                return days;
            }

            function hasEventsOnDate(date) {
                return state.events.some(e => sameDay(new Date(e.start), date));
            }

            window.toggleCalendar = function() {
                console.log('toggleCalendar called, showCalendar was:', state.showCalendar);
                state.showCalendar = !state.showCalendar;
                console.log('showCalendar is now:', state.showCalendar);
                render();
            };

            window.selectDate = function(date) {
                state.selectedDate = date;
                state.showCalendar = false;
                render();
            };

            window.goToToday = function() {
                state.selectedDate = new Date();
                state.currentMonth = new Date();
                render();

                // Scroll to today after render
                setTimeout(() => {
                    const today = new Date();
                    const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                    const todaySection = document.querySelector(`[data-date="${todayKey}"]`);
                    if (todaySection) {
                        todaySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 300);
            };

            window.prevMonth = function() {
                state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() - 1, 1);
                render();
            };

            window.nextMonth = function() {
                state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 1);
                render();
            };

            window.switchTab = function(tab) {
                state.activeTab = tab;
                state.view = 'list';
                state.showCalendar = false;
                if (tab === 'todos' && state.todos.length === 0) {
                    loadTodos();
                } else {
                    render();
                }
            };

            window.toggleTodo = async function(todoId) {
                try {
                    const res = await fetch(`/api/todos/${userId}/${todoId}/toggle`, {
                        method: 'POST',
                        headers: {
                            'X-Telegram-Init-Data': initData
                        }
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    await loadTodos();
                } catch(e) {
                    console.error('Error toggling todo:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏');
                }
            };

            window.editTodo = function(todoId) {
                const todo = state.todos.find(t => t.id === todoId);
                if (!todo) return;

                state.editingTodo = { ...todo };
                state.view = 'todo-edit';
                render();
            };

            window.deleteTodo = async function(todoId) {
                confirmAction('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?', async () => {
                    try {
                        const res = await fetch(`/api/todos/${userId}/${todoId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Telegram-Init-Data': initData
                            }
                        });
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        await loadTodos();
                        state.view = 'list';
                        render();
                    } catch(e) {
                        console.error('Error deleting todo:', e);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                    }
                });
            };

            window.updateTodo = async function() {
                try {
                    const res = await fetch(`/api/todos/${userId}/${state.editingTodo.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Telegram-Init-Data': initData
                        },
                        body: JSON.stringify({
                            title: state.editingTodo.title,
                            completed: state.editingTodo.completed,
                            due_date: state.editingTodo.due_date
                        })
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    await loadTodos();
                    state.view = 'list';
                    state.editingTodo = null;
                    render();
                } catch(e) {
                    console.error('Error updating todo:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
            };

            window.cancelTodoEdit = function() {
                state.view = 'list';
                state.editingTodo = null;
                render();
            };

            window.openNewTodo = function() {
                state.editingTodo = { id: null, title: '', completed: false, due_date: null };
                state.view = 'todo-edit';
                render();
            };

            window.createTodo = async function() {
                const title = document.getElementById('editTodoTitle').value.trim();
                if (!title) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                    return;
                }

                const dueDateInput = document.getElementById('editTodoDueDate').value;
                const todoData = {
                    title: title,
                    completed: false,
                    due_date: dueDateInput ? new Date(dueDateInput).toISOString() : null
                };

                showLoading();
                try {
                    const res = await fetch(`/api/todos/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Telegram-Init-Data': initData
                        },
                        body: JSON.stringify(todoData)
                    });

                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }

                    await loadTodos();
                    state.view = 'list';
                    state.editingTodo = null;
                    render();
                } catch(e) {
                    console.error('Error creating todo:', e);
                    tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                } finally {
                    hideLoading();
                }
            };

            // Confirmation modal
            let confirmCallback = null;

            function confirmAction(text, callback) {
                document.getElementById('confirmText').textContent = text;
                document.getElementById('confirmModal').style.display = 'flex';
                confirmCallback = callback;
            }

            window.closeConfirm = function() {
                document.getElementById('confirmModal').style.display = 'none';
                confirmCallback = null;
            };

            window.execConfirm = function() {
                document.getElementById('confirmModal').style.display = 'none';
                if (confirmCallback) confirmCallback();
                confirmCallback = null;
            };

            // Settings functions
            window.openSettings = function() {
                document.getElementById('settingsModal').style.display = 'flex';
            };

            window.closeSettings = function() {
                document.getElementById('settingsModal').style.display = 'none';
            };

            window.openSupport = function() {
                closeSettings();
                // Show message before redirect
                tg.showPopup({
                    title: '–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º',
                    message: '–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –≤–æ–ø—Ä–æ—Å—ã. –ú—ã —Ä–∞–¥—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏!',
                    buttons: [
                        { id: 'open', type: 'default', text: '–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç' },
                        { id: 'cancel', type: 'cancel' }
                    ]
                }, function(buttonId) {
                    if (buttonId === 'open') {
                        if (window.Telegram?.WebApp?.openTelegramLink) {
                            window.Telegram.WebApp.openTelegramLink('https://t.me/iay_pm');
                        } else {
                            window.open('https://t.me/iay_pm', '_blank');
                        }
                    }
                });
            };

            // Render function
            function render() {
                const app = document.getElementById('app');

                if (state.view === 'list') {
                    const fromDate = new Date(state.selectedDate);
                    fromDate.setDate(fromDate.getDate() - 30); // Show 30 days back
                    fromDate.setHours(0,0,0,0);
                    const grouped = groupEventsByDay(state.events, fromDate, 90); // 30 back + 60 forward
                    const dateKeys = Object.keys(grouped);

                    app.innerHTML = `
                        <div class="min-h-screen">
                            <div class="secondary-bg p-4 sticky top-0 z-20 shadow-lg">
                                <!-- Tab switcher -->
                                <div class="flex gap-2 mb-3">
                                    <button
                                        onclick="switchTab('events')"
                                        class="${state.activeTab === 'events' ? 'button-bg' : 'tertiary-bg'} px-6 py-2 rounded-xl flex-1 font-medium"
                                    >
                                        üìÖ ${t.events}
                                    </button>
                                    <button
                                        onclick="switchTab('todos')"
                                        class="${state.activeTab === 'todos' ? 'button-bg' : 'tertiary-bg'} px-6 py-2 rounded-xl flex-1 font-medium"
                                    >
                                        ‚úì ${t.todos}
                                    </button>
                                </div>

                                <div class="flex items-center justify-between mb-3">
                                    <h1 class="text-2xl font-bold">${state.activeTab === 'events' ? t.myEvents : t.myTodos}</h1>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs hint-color px-2 py-1 rounded tertiary-bg">v986</span>
                                        <button onclick="openSettings()" class="tertiary-bg w-8 h-8 rounded-xl flex items-center justify-center">
                                            <span class="text-lg">‚öôÔ∏è</span>
                                        </button>
                                    </div>
                                </div>

                                ${state.activeTab === 'events' ? `
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleCalendar()" class="tertiary-bg px-4 py-2 rounded-xl flex-1 text-left flex items-center justify-between">
                                        <span>${fmtDate(state.selectedDate)}</span>
                                        <span class="text-xl">üìÖ</span>
                                    </button>
                                    <button onclick="goToToday()" class="tertiary-bg px-4 py-2 rounded-xl">${t.today}</button>
                                </div>
                                ` : ''}
                            </div>

                            ${state.showCalendar && state.activeTab === 'events' ? `
                                <div class="secondary-bg p-4 border-t border-theme">
                                    <div class="flex items-center justify-between mb-4">
                                        <button onclick="prevMonth()" class="tertiary-bg w-10 h-10 rounded-xl">‚Üê</button>
                                        <div class="font-semibold">${t.months[state.currentMonth.getMonth()]} ${state.currentMonth.getFullYear()}</div>
                                        <button onclick="nextMonth()" class="tertiary-bg w-10 h-10 rounded-xl">‚Üí</button>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        ${t.days.map(d => `<div class="text-center text-xs hint-color py-1">${d}</div>`).join('')}
                                    </div>
                                    <div class="grid grid-cols-7 gap-1">
                                        ${getMonthDays(state.currentMonth.getFullYear(), state.currentMonth.getMonth()).map(d => {
                                            const isToday = sameDay(d.date, new Date());
                                            const isSelected = sameDay(d.date, state.selectedDate);
                                            const hasEvents = hasEventsOnDate(d.date);
                                            return `
                                                <div
                                                    onclick="selectDate(new Date(${d.date.getTime()}))"
                                                    class="calendar-day ${isSelected ? 'selected' : ''} ${isToday ? 'today' : ''} ${hasEvents ? 'has-events' : ''} ${!d.current ? 'opacity-30' : ''}"
                                                >
                                                    ${d.date.getDate()}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="p-4">
                                ${state.activeTab === 'events' ? `
                                    <button onclick="openEdit()" class="button-bg w-full py-3 rounded-lg mb-4 font-medium shadow-lg">
                                        + ${t.newEvent}
                                    </button>

                                    ${dateKeys.map(dateKey => {
                                        const dayEvents = grouped[dateKey];
                                        const [y, m, d] = dateKey.split('-').map(Number);
                                        const dayDate = new Date(y, m - 1, d);
                                        const isToday = sameDay(dayDate, new Date());

                                        // Skip empty days UNLESS it's today (always show today for scroll)
                                        if (dayEvents.length === 0 && !isToday) return '';

                                        return `
                                            <div class="day-separator py-2 px-2 font-semibold text-sm ${isToday ? 'tertiary-bg rounded-lg' : ''}" data-date="${dateKey}">
                                                ${fmtDate(dayDate)} ${isToday ? '‚Ä¢ –°–µ–≥–æ–¥–Ω—è' : ''} ‚Äî ${dayEvents.length > 0 ? (dayEvents.length + ' ' + (dayEvents.length === 1 ? '—Å–æ–±—ã—Ç–∏–µ' : '—Å–æ–±—ã—Ç–∏–π')) : '—Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç'}
                                            </div>
                                            ${dayEvents.map(e => `
                                                <div onclick="viewEvent('${safeId(e.id)}')" class="event-card secondary-bg p-4 mb-2 rounded-lg cursor-pointer">
                                                    <div class="font-medium text-base mb-1">${escapeHtml(e.title)}</div>
                                                    <div class="hint-color text-sm">
                                                        ${fmtTime(new Date(e.start))} ‚Äî ${fmtTime(new Date(e.end))}
                                                        ${e.location ? ` ¬∑ ${escapeHtml(e.location)}` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        `;
                                    }).join('')}

                                    ${state.events.length === 0 ? `
                                        <div class="text-center py-12 hint-color">
                                            <div class="text-6xl mb-4">üìÖ</div>
                                            <div class="text-lg">${t.noEvents}</div>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <!-- Todos view -->
                                    <button onclick="openNewTodo()" class="button-bg w-full py-3 rounded-lg mb-4 font-medium shadow-lg">
                                        + –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                                    </button>
                                    ${state.todos.length === 0 ? `
                                        <div class="text-center py-12 hint-color">
                                            <div class="text-6xl mb-4">üìã</div>
                                            <div class="text-lg">${t.noTodos}</div>
                                        </div>
                                    ` : `
                                        ${state.todos.filter(todo => !todo.completed).length > 0 ? `
                                            <div class="mb-6">
                                                <div class="text-sm hint-color font-medium mb-2 px-2">${t.active} (${state.todos.filter(todo => !todo.completed).length})</div>
                                                ${state.todos.filter(todo => !todo.completed).map(todo => `
                                                    <div class="secondary-bg p-4 mb-2 rounded-lg flex items-start gap-3">
                                                        <button onclick="event.stopPropagation(); toggleTodo('${safeId(todo.id)}')" class="tertiary-bg w-6 h-6 rounded-lg flex-shrink-0 flex items-center justify-center">
                                                            <span class="text-xs opacity-0">‚úì</span>
                                                        </button>
                                                        <div class="flex-1 cursor-pointer" onclick="editTodo('${safeId(todo.id)}')">
                                                            <div class="font-medium">${escapeHtml(todo.title)}</div>
                                                            ${todo.due_date ? `<div class="text-xs hint-color mt-1">üìÖ ${new Date(todo.due_date).toLocaleDateString('ru-RU')}</div>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}

                                        ${state.todos.filter(todo => todo.completed).length > 0 ? `
                                            <div>
                                                <div class="text-sm hint-color font-medium mb-2 px-2">${t.completed} (${state.todos.filter(todo => todo.completed).length})</div>
                                                ${state.todos.filter(todo => todo.completed).map(todo => `
                                                    <div class="secondary-bg p-4 mb-2 rounded-lg flex items-start gap-3 opacity-60">
                                                        <button onclick="event.stopPropagation(); toggleTodo('${safeId(todo.id)}')" class="button-bg w-6 h-6 rounded-lg flex-shrink-0 flex items-center justify-center">
                                                            <span class="text-xs">‚úì</span>
                                                        </button>
                                                        <div class="flex-1 cursor-pointer" onclick="editTodo('${safeId(todo.id)}')">
                                                            <div class="font-medium line-through">${escapeHtml(todo.title)}</div>
                                                            ${todo.due_date ? `<div class="text-xs hint-color mt-1">üìÖ ${new Date(todo.due_date).toLocaleDateString('ru-RU')}</div>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    `}
                                `}
                            </div>
                        </div>
                    `;
                } else if (state.view === 'detail') {
                    const e = state.viewEvent;
                    app.innerHTML = `
                        <div class="min-h-screen p-4">
                            <button onclick="closeEdit()" class="mb-4 hint-color flex items-center gap-2">
                                <span class="text-xl">‚Üê</span> ${t.cancel}
                            </button>
                            <div class="secondary-bg p-6 rounded-xl">
                                <h2 class="text-2xl font-bold mb-6">${escapeHtml(e.title)}</h2>
                                <div class="space-y-4">
                                    <div class="flex items-start gap-3">
                                        <span class="text-2xl">üìÖ</span>
                                        <div class="flex-1">
                                            <div class="text-sm hint-color mb-1">${t.date}</div>
                                            <div>${fmtDate(new Date(e.start))}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="text-2xl">üïê</span>
                                        <div class="flex-1">
                                            <div class="text-sm hint-color mb-1">${t.start} ‚Äî ${t.end}</div>
                                            <div>${fmtTime(new Date(e.start))} ‚Äî ${fmtTime(new Date(e.end))}</div>
                                        </div>
                                    </div>
                                    ${e.location ? `
                                        <div class="flex items-start gap-3">
                                            <span class="text-2xl">üìç</span>
                                            <div class="flex-1">
                                                <div class="text-sm hint-color mb-1">${t.location}</div>
                                                <div>${escapeHtml(e.location)}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${e.description ? `
                                        <div class="flex items-start gap-3">
                                            <span class="text-2xl">üìù</span>
                                            <div class="flex-1">
                                                <div class="text-sm hint-color mb-1">${t.note}</div>
                                                <div>${escapeHtml(e.description)}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mt-6 flex gap-3">
                                <button data-event-id="${e.id}" class="btn-edit button-bg flex-1 py-4 rounded-lg font-medium shadow-lg">
                                    ${t.edit}
                                </button>
                                <button data-event-id="${e.id}" class="btn-delete button-danger flex-1 py-4 rounded-lg font-medium shadow-lg">
                                    ${t.delete}
                                </button>
                            </div>
                        </div>
                    `;
                } else if (state.view === 'edit') {
                    app.innerHTML = `
                        <div class="min-h-screen p-4">
                            <button onclick="closeEdit()" class="mb-4 hint-color flex items-center gap-2">
                                <span class="text-xl">‚Üê</span> ${t.cancel}
                            </button>
                            <h2 class="text-2xl font-bold mb-6">${state.edit.id ? t.editEvent : t.newEvent}</h2>
                            <div class="space-y-4">
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.title}</span>
                                    <input id="editTitle" value="${escapeAttr(state.edit.title||'')}"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"
                                        placeholder="${t.title}"/>
                                </label>
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.date}</span>
                                    <input id="editDate" type="date" value="${toDateInputValue(state.edit.start)}"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"/>
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="block">
                                        <span class="text-sm hint-color mb-2 block">${t.start}</span>
                                        <input id="editStartTime" type="time" value="${toTimeInputValue(state.edit.start)}"
                                            class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"/>
                                    </label>
                                    <label class="block">
                                        <span class="text-sm hint-color mb-2 block">${t.end}</span>
                                        <input id="editEndTime" type="time" value="${toTimeInputValue(state.edit.end)}"
                                            class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"/>
                                    </label>
                                </div>
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.location}</span>
                                    <input id="editLocation" value="${escapeAttr(state.edit.location||'')}"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"
                                        placeholder="${t.location}"/>
                                </label>
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">${t.note}</span>
                                    <textarea id="editNote" rows="4"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base resize-none"
                                        placeholder="${t.note}">${escapeHtml(state.edit.description||'')}</textarea>
                                </label>
                                <div class="flex gap-3 mt-6 pt-4">
                                    <button onclick="closeEdit()" class="tertiary-bg flex-1 py-4 rounded-lg font-medium">
                                        ${t.cancel}
                                    </button>
                                    <button onclick="saveEvent()" class="button-bg flex-1 py-4 rounded-lg font-medium shadow-lg">
                                        ${t.save}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (state.view === 'todo-edit') {
                    const todo = state.editingTodo;
                    const isNew = !todo.id;
                    app.innerHTML = `
                        <div class="min-h-screen p-4">
                            <button onclick="cancelTodoEdit()" class="mb-4 hint-color flex items-center gap-2">
                                <span class="text-xl">‚Üê</span> –û—Ç–º–µ–Ω–∞
                            </button>
                            <h2 class="text-2xl font-bold mb-6">${isNew ? '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É'}</h2>
                            <div class="space-y-4">
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</span>
                                    <input id="editTodoTitle" value="${escapeAttr(todo.title || '')}"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"
                                        placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"/>
                                </label>
                                <label class="block">
                                    <span class="text-sm hint-color mb-2 block">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                                    <input id="editTodoDueDate" type="date" value="${todo.due_date ? new Date(todo.due_date).toISOString().split('T')[0] : ''}"
                                        class="secondary-bg w-full px-4 py-3 rounded-lg outline-none text-base"/>
                                </label>
                                <div class="flex gap-3 pt-4">
                                    ${isNew ? `
                                        <button onclick="cancelTodoEdit()" class="tertiary-bg flex-1 py-3 rounded-lg font-medium">
                                            –û—Ç–º–µ–Ω–∞
                                        </button>
                                        <button onclick="createTodo()" class="button-bg flex-1 py-3 rounded-lg font-medium">
                                            –°–æ–∑–¥–∞—Ç—å
                                        </button>
                                    ` : `
                                        <button onclick="deleteTodo('${safeId(todo.id)}')" class="button-danger flex-1 py-3 rounded-lg font-medium">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                        <button onclick="
                                            state.editingTodo.title = document.getElementById('editTodoTitle').value;
                                            const dueDateInput = document.getElementById('editTodoDueDate').value;
                                            state.editingTodo.due_date = dueDateInput ? new Date(dueDateInput).toISOString() : null;
                                            updateTodo();
                                        " class="button-bg flex-1 py-3 rounded-lg font-medium">
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Auto-scroll to today's date on FIRST load only (events tab)
                if (state.view === 'list' && state.activeTab === 'events' && !initialScrollDone) {
                    const scrollToToday = () => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                        console.log('Looking for today section:', todayKey);
                        let targetSection = document.querySelector(`[data-date="${todayKey}"]`);

                        // If no exact match for today, find closest FUTURE date (not past)
                        if (!targetSection) {
                            console.log('Today section not found, looking for closest future date');
                            const allSections = Array.from(document.querySelectorAll('[data-date]'));
                            let minDiff = Infinity;

                            allSections.forEach(section => {
                                const dateStr = section.getAttribute('data-date');
                                // Parse date string correctly: YYYY-MM-DD
                                const [y, m, d] = dateStr.split('-').map(Number);
                                const sectionDate = new Date(y, m - 1, d); // month is 0-indexed
                                sectionDate.setHours(0, 0, 0, 0);

                                // Calculate difference (prefer future dates)
                                const diff = sectionDate.getTime() - today.getTime();

                                // Only consider today or future dates, find closest
                                if (diff >= 0 && diff < minDiff) {
                                    minDiff = diff;
                                    targetSection = section;
                                }
                            });

                            // If no future dates found, use closest past date
                            if (!targetSection && allSections.length > 0) {
                                allSections.forEach(section => {
                                    const dateStr = section.getAttribute('data-date');
                                    const [y, m, d] = dateStr.split('-').map(Number);
                                    const sectionDate = new Date(y, m - 1, d);
                                    sectionDate.setHours(0, 0, 0, 0);
                                    const diff = Math.abs(sectionDate.getTime() - today.getTime());
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        targetSection = section;
                                    }
                                });
                            }
                        }

                        if (targetSection) {
                            console.log('Scrolling to section:', targetSection.getAttribute('data-date'));
                            targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            initialScrollDone = true;
                            return true;
                        }
                        console.log('No section found to scroll to');
                        return false;
                    };

                    // Single attempt after DOM ready
                    setTimeout(scrollToToday, 150);
                }
            }

            // Global event delegation
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-edit') || e.target.closest('.btn-edit')) {
                    const btn = e.target.classList.contains('btn-edit') ? e.target : e.target.closest('.btn-edit');
                    const eventId = btn.getAttribute('data-event-id');
                    e.preventDefault();
                    e.stopPropagation();
                    openEdit(eventId);
                    return;
                }

                if (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete')) {
                    const btn = e.target.classList.contains('btn-delete') ? e.target : e.target.closest('.btn-delete');
                    const eventId = btn.getAttribute('data-event-id');
                    e.preventDefault();
                    e.stopPropagation();
                    deleteEvent(eventId);
                    return;
                }
            });

            // Start the app
            loadEvents();
        }
    </script>
</body>
</html>
