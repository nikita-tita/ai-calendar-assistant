<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Report - AI Calendar Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0b0b0b;
            color: #ffffff;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header-actions { display: flex; gap: 12px; align-items: center; }

        /* Buttons */
        .btn {
            background: #181A20;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:hover { background: #252830; }
        .btn-outline {
            background: transparent;
            border: 1px solid #333;
        }
        .btn-outline:hover { background: #1a1a1a; }
        .btn-danger { background: #333; }
        .btn-danger:hover { background: #444; }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: #1a1a1a;
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
        }
        .login-card h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 32px;
            text-align: center;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            background: #0b0b0b;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-family: inherit;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #555;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }
        .summary-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .summary-card .label {
            font-size: 14px;
            color: #9ca3af;
        }

        /* Filters */
        .filters {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-group label {
            font-size: 14px;
            color: #9ca3af;
        }
        .filter-group select {
            background: #0b0b0b;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: inherit;
            font-size: 14px;
        }
        .filter-group select:focus { outline: none; border-color: #555; }

        /* User Cards */
        .users-list { display: flex; flex-direction: column; gap: 16px; }
        .user-card {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
        }
        .user-card.inactive { opacity: 0.6; }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-header:hover { background: #222; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #181A20;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .user-name { font-weight: 600; font-size: 15px; }
        .user-id { font-size: 13px; color: #9ca3af; font-family: monospace; }
        .user-stats {
            display: flex;
            gap: 16px;
        }
        .user-stat {
            text-align: right;
        }
        .user-stat .count { font-weight: 600; font-size: 15px; }
        .user-stat .label { font-size: 12px; color: #9ca3af; }

        /* User Details */
        .user-details {
            display: none;
            border-top: 1px solid #2a2a2a;
        }
        .user-details.expanded { display: block; }
        .details-tabs {
            display: flex;
            border-bottom: 1px solid #2a2a2a;
        }
        .details-tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #9ca3af;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .details-tab:hover { color: #fff; }
        .details-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        .details-content { padding: 16px 20px; }

        /* Items List */
        .items-list { display: flex; flex-direction: column; gap: 8px; }
        .item-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: #0b0b0b;
            border-radius: 8px;
        }
        .item-row.completed { opacity: 0.5; }
        .item-row.past { opacity: 0.7; }
        .item-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #444;
            border-radius: 6px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .item-checkbox.checked {
            background: #181A20;
            border-color: #181A20;
        }
        .item-checkbox.checked::after {
            content: '‚úì';
            font-size: 12px;
        }
        .item-time {
            font-size: 13px;
            color: #9ca3af;
            width: 80px;
            flex-shrink: 0;
        }
        .item-title { font-size: 14px; flex: 1; }
        .item-date {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.visible { display: flex; }

        /* Hide Button */
        .hide-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .hide-btn:hover { background: #252830; color: #fff; }
        .hide-btn.hidden-user { color: #555; }
        .user-card.is-hidden { opacity: 0.4; }
        .user-card.is-hidden .user-name { text-decoration: line-through; }

        /* Global Toggle */
        .toggle-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #333;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        .toggle-btn:hover { background: #1a1a1a; color: #fff; }
        .toggle-btn.active { background: #181A20; border-color: #181A20; color: #fff; }

        /* Responsive */
        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .user-stats { display: none; }
            .filters { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <h2>User Report</h2>
        <form id="loginForm">
            <div class="form-group">
                <label>–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password1" required>
            </div>
            <div class="form-group">
                <label>–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password2" required>
            </div>
            <div class="form-group">
                <label>–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password3" required>
            </div>
            <button type="submit" class="btn" style="width:100%;margin-top:16px;">–í–æ–π—Ç–∏</button>
        </form>
        <div id="loginError" style="display:none;margin-top:16px;padding:12px;background:#331a1a;border-radius:8px;color:#ff6b6b;font-size:14px;"></div>
    </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" style="display:none;">
    <header class="header">
        <div style="display:flex;align-items:center;gap:12px;">
            <h1>User Report</h1>
            <span id="loadingProgress" class="loading-progress" style="display:none;font-size:13px;color:#9ca3af;"></span>
        </div>
        <div class="header-actions">
            <button onclick="toggleShowHidden()" id="showHiddenToggle" class="toggle-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">üëÅ</button>
            <button onclick="refreshReport()" class="btn btn-outline">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <a href="/static/admin.html" class="btn btn-outline">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="container">
        <!-- Summary -->
        <div class="summary-grid" id="summaryGrid">
            <div class="summary-card">
                <div class="value" id="totalUsers">-</div>
                <div class="label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="summary-card">
                <div class="value" id="activeUsers">-</div>
                <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö <span id="loadedCount" style="font-size:12px;color:#666;"></span></div>
            </div>
            <div class="summary-card">
                <div class="value" id="inactiveUsers">-</div>
                <div class="label">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                <select id="filterActivity" onchange="applyFilters()">
                    <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–°–æ–±—ã—Ç–∏—è:</label>
                <select id="filterEvents" onchange="applyFilters()">
                    <option value="all">–í—Å–µ</option>
                    <option value="future">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</option>
                    <option value="past">–ü—Ä–æ—à–µ–¥—à–∏–µ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–ó–∞–¥–∞—á–∏:</label>
                <select id="filterTodos" onchange="applyFilters()">
                    <option value="all">–í—Å–µ</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
        </div>

        <!-- Users List -->
        <div id="usersList" class="users-list">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = '/api/admin';
const STORAGE_KEY = 'admin_session_token';
const HIDDEN_USERS_KEY = 'admin_hidden_users';
const CACHE_KEY = 'admin_report_cache';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

let sessionToken = null;
let reportData = null;
let hiddenUsers = new Set();
let showHiddenUsers = false;

// Cache functions
function saveToCache() {
    if (!reportData) return;
    const cacheData = {
        timestamp: Date.now(),
        data: reportData
    };
    try {
        sessionStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
    } catch (e) {
        console.warn('Cache save failed:', e);
    }
}

function loadFromCache() {
    try {
        const cached = sessionStorage.getItem(CACHE_KEY);
        if (!cached) return null;

        const { timestamp, data } = JSON.parse(cached);

        // Check TTL
        if (Date.now() - timestamp > CACHE_TTL_MS) {
            sessionStorage.removeItem(CACHE_KEY);
            return null;
        }

        return data;
    } catch (e) {
        return null;
    }
}

function clearCache() {
    sessionStorage.removeItem(CACHE_KEY);
}

// Background loading configuration
const LOADING_CONFIG = {
    CONCURRENT_TODOS: 4,      // Todos are fast (local files)
    CONCURRENT_EVENTS: 2,     // Events are slow (CalDAV HTTP)
    DELAY_BETWEEN_MS: 150,    // Pause between batches
    REQUEST_TIMEOUT_MS: 15000 // Request timeout
};

// Loading state
let loadingState = {
    isRunning: false,
    phase: 'idle', // 'idle' | 'todos' | 'events' | 'done'
    loaded: 0,
    total: 0,
    aborted: false
};

// Load hidden users from localStorage
function loadHiddenUsers() {
    try {
        const saved = localStorage.getItem(HIDDEN_USERS_KEY);
        hiddenUsers = saved ? new Set(JSON.parse(saved)) : new Set();
    } catch (e) {
        hiddenUsers = new Set();
    }
}

// Save hidden users to localStorage
function saveHiddenUsers() {
    localStorage.setItem(HIDDEN_USERS_KEY, JSON.stringify([...hiddenUsers]));
}

// Toggle user visibility
function toggleUserHidden(e, userId) {
    e.stopPropagation();
    if (hiddenUsers.has(userId)) {
        hiddenUsers.delete(userId);
    } else {
        hiddenUsers.add(userId);
    }
    saveHiddenUsers();
    renderUsers();
    updateSummary();  // Update stats when hiding user
}

// Toggle global show hidden
function toggleShowHidden() {
    showHiddenUsers = !showHiddenUsers;
    const btn = document.getElementById('showHiddenToggle');
    if (showHiddenUsers) {
        btn.classList.add('active');
        btn.textContent = 'üëÅ‚Äçüó®';
        btn.title = '–°–∫—Ä—ã—Ç—å —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
    } else {
        btn.classList.remove('active');
        btn.textContent = 'üëÅ';
        btn.title = '–ü–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
    }
    renderUsers();
    updateSummary();  // Update stats when toggling hidden
}

// Check if user is hidden
function isUserHidden(userId) {
    return hiddenUsers.has(userId);
}

// Restore session
async function restoreSession() {
    loadHiddenUsers(); // Load hidden users on startup
    const savedToken = localStorage.getItem(STORAGE_KEY);
    if (savedToken) {
        try {
            const res = await fetch(`${API_BASE}/stats`, {
                headers: { 'Authorization': `Bearer ${savedToken}` }
            });
            if (res.ok) {
                sessionToken = savedToken;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadReport();
            } else {
                localStorage.removeItem(STORAGE_KEY);
            }
        } catch (e) {
            localStorage.removeItem(STORAGE_KEY);
        }
    }
}

// Login
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const pwd1 = document.getElementById('password1').value;
    const pwd2 = document.getElementById('password2').value;
    const pwd3 = document.getElementById('password3').value;

    try {
        const res = await fetch(`${API_BASE}/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password1: pwd1, password2: pwd2, password3: pwd3 })
        });
        const data = await res.json();

        if (res.ok && data.valid) {
            sessionToken = data.token;
            localStorage.setItem(STORAGE_KEY, data.token);
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadReport();
        } else {
            showLoginError(data.error || '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–æ–ª–∏');
        }
    } catch (e) {
        showLoginError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
});

function showLoginError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.style.display = 'block';
}

function logout() {
    sessionToken = null;
    localStorage.removeItem(STORAGE_KEY);
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('password1').value = '';
    document.getElementById('password2').value = '';
    document.getElementById('password3').value = '';
}

// Load report
async function loadReport() {
    try {
        // Try to load from cache first
        const cached = loadFromCache();
        if (cached) {
            reportData = cached;
            updateSummary();
            renderUsers();

            // Check if there are users without loaded data
            const hasUnloaded = reportData.users.some(u => u.todos === null || u.events === null);
            if (hasUnloaded) {
                startBackgroundLoading();
            }
            return;
        }

        // No cache ‚Äî load from server
        const res = await fetch(`${API_BASE}/report?days_back=90&days_forward=90`, {
            headers: { 'Authorization': `Bearer ${sessionToken}` }
        });

        if (res.status === 401) {
            logout();
            return;
        }

        reportData = await res.json();
        updateSummary();
        renderUsers();

        // Start background loading of todos and events
        startBackgroundLoading();
    } catch (e) {
        console.error('Error loading report:', e);
        document.getElementById('usersList').innerHTML = `
            <div class="empty-state">
                <div class="icon">‚ö†Ô∏è</div>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
        `;
    }
}

function refreshReport() {
    // Clear cache
    clearCache();

    // Stop any running background loading
    stopBackgroundLoading();

    // Reset all user data
    if (reportData && reportData.users) {
        reportData.users.forEach(u => {
            u.todos = null;
            u.events = null;
            u.todos_count = null;
            u.events_count = null;
            u.todos_active = undefined;
            u.events_future = undefined;
        });
    }

    // Reset reportData to force fresh load
    reportData = null;

    document.getElementById('usersList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    updateLoadingProgress(0, 0, 'idle');
    loadReport();
}

// Stop background loading
function stopBackgroundLoading() {
    loadingState.aborted = true;
    loadingState.isRunning = false;
}

// Update loading progress in header
function updateLoadingProgress(loaded, total, phase) {
    loadingState.loaded = loaded;
    loadingState.total = total;
    loadingState.phase = phase;

    const progressEl = document.getElementById('loadingProgress');
    if (!progressEl) return;

    if (phase === 'idle' || phase === 'done') {
        progressEl.style.display = 'none';
    } else {
        progressEl.style.display = 'inline';
        const phaseLabel = phase === 'todos' ? '–∑–∞–¥–∞—á–∏' : '—Å–æ–±—ã—Ç–∏—è';
        progressEl.textContent = `‚è≥ ${phaseLabel}: ${loaded}/${total}`;
    }
}

// Background loading - main function
async function startBackgroundLoading() {
    if (loadingState.isRunning) return;

    loadingState.isRunning = true;
    loadingState.aborted = false;

    // Get users to load (exclude test users)
    const usersToLoad = reportData.users.filter(u => !TEST_USERNAMES.includes(u.username));
    const total = usersToLoad.length;

    if (total === 0) {
        loadingState.isRunning = false;
        updateLoadingProgress(0, 0, 'done');
        return;
    }

    // Phase 1: Load todos (fast, local files)
    updateLoadingProgress(0, total, 'todos');
    await loadDataInBatches(usersToLoad, 'todos', LOADING_CONFIG.CONCURRENT_TODOS);

    if (loadingState.aborted) {
        loadingState.isRunning = false;
        return;
    }

    // Phase 2: Load events (slow, CalDAV)
    updateLoadingProgress(0, total, 'events');
    await loadDataInBatches(usersToLoad, 'events', LOADING_CONFIG.CONCURRENT_EVENTS);

    loadingState.isRunning = false;
    updateLoadingProgress(total, total, 'done');
}

// Load data in batches with concurrency control
async function loadDataInBatches(users, type, concurrency) {
    let loaded = 0;

    for (let i = 0; i < users.length; i += concurrency) {
        if (loadingState.aborted) return;

        const batch = users.slice(i, i + concurrency);
        const promises = batch.map(user => loadSingleUserData(user, type));

        await Promise.all(promises);

        loaded += batch.length;
        updateLoadingProgress(loaded, users.length, type);

        // Small delay between batches to not overload server
        if (i + concurrency < users.length) {
            await sleep(LOADING_CONFIG.DELAY_BETWEEN_MS);
        }
    }
}

// Load single user's todos or events
async function loadSingleUserData(user, type) {
    if (loadingState.aborted) return;

    const userId = user.user_id;
    const endpoint = type === 'todos'
        ? `${API_BASE}/users/${userId}/todos`
        : `${API_BASE}/users/${userId}/events`;

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), LOADING_CONFIG.REQUEST_TIMEOUT_MS);

        const res = await fetch(endpoint, {
            headers: { 'Authorization': `Bearer ${sessionToken}` },
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) return;

        const data = await res.json();

        // Update user data in reportData
        const userIndex = reportData.users.findIndex(u => u.user_id === userId);
        if (userIndex === -1) return;

        const now = new Date();

        if (type === 'todos') {
            reportData.users[userIndex].todos = data;
            reportData.users[userIndex].todos_count = data.length;
            reportData.users[userIndex].todos_active = data.filter(t => !t.completed).length;
        } else {
            reportData.users[userIndex].events = data;
            reportData.users[userIndex].events_count = data.length;
            reportData.users[userIndex].events_future = data.filter(e => new Date(e.start) >= now).length;
        }

        // Update UI for this user
        updateUserCardStats(userId);
        updateSummary();

        // Save to cache after each user loaded
        saveToCache();

    } catch (e) {
        if (e.name === 'AbortError') {
            console.log(`Timeout loading ${type} for user ${userId}`);
        } else {
            console.error(`Error loading ${type} for user ${userId}:`, e);
        }
    }
}

// Update stats in a single user card without re-rendering everything
function updateUserCardStats(userId) {
    const userIndex = reportData.users.findIndex(u => u.user_id === userId);
    if (userIndex === -1) return;

    const user = reportData.users[userIndex];

    // Find the card in DOM by user_id
    const card = document.querySelector(`[data-user-id="${userId}"]`);
    if (!card) return;

    // Update todos stat
    const todosActive = user.todos_active !== undefined ? user.todos_active : '‚Äî';
    const todosCount = user.todos_count !== null ? user.todos_count : '‚Äî';
    const statTodos = card.querySelector('[id^="stat-todos-"]');
    if (statTodos) {
        statTodos.innerHTML = `<div class="count">${todosActive}/${todosCount}</div><div class="label">–ó–∞–¥–∞—á</div>`;
    }

    // Update events stat
    const eventsFuture = user.events_future !== undefined ? user.events_future : '‚Äî';
    const eventsCount = user.events_count !== null ? user.events_count : '‚Äî';
    const statEvents = card.querySelector('[id^="stat-events-"]');
    if (statEvents) {
        statEvents.innerHTML = `<div class="count">${eventsFuture}/${eventsCount}</div><div class="label">–°–æ–±—ã—Ç–∏–π</div>`;
    }
}

// Helper: sleep
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Test users to exclude from stats
const TEST_USERNAMES = ['aibroker_bot'];

function updateSummary() {
    if (!reportData) return;

    // Filter out test users and hidden users from stats
    const visibleUsers = reportData.users.filter(u => {
        // Exclude test users by username
        if (TEST_USERNAMES.includes(u.username)) return false;
        // Exclude hidden users
        if (isUserHidden(u.user_id) && !showHiddenUsers) return false;
        return true;
    });

    document.getElementById('totalUsers').textContent = visibleUsers.length;

    // Count users with fully loaded data (both todos and events)
    const loadedUsers = visibleUsers.filter(u => u.todos !== null && u.events !== null);
    const loadedCount = loadedUsers.length;
    const totalCount = visibleUsers.length;

    // Active = has future events OR has active (incomplete) todos
    const active = loadedUsers.filter(u =>
        (u.events_future > 0) || (u.todos_active > 0)
    ).length;

    // Inactive = no future events AND no active todos
    const inactive = loadedUsers.filter(u =>
        u.events_future === 0 && u.todos_active === 0
    ).length;

    // Show counts with loading progress
    const loadedCountEl = document.getElementById('loadedCount');
    if (loadedCount < totalCount) {
        loadedCountEl.textContent = `(${loadedCount}/${totalCount})`;
        document.getElementById('activeUsers').textContent = loadedCount > 0 ? active : '‚Äî';
        document.getElementById('inactiveUsers').textContent = loadedCount > 0 ? inactive : '‚Äî';
    } else {
        loadedCountEl.textContent = '';
        document.getElementById('activeUsers').textContent = active;
        document.getElementById('inactiveUsers').textContent = inactive;
    }
}

function applyFilters() {
    renderUsers();
}

function getFilteredUsers() {
    if (!reportData) return [];

    const activityFilter = document.getElementById('filterActivity').value;

    return reportData.users.filter(user => {
        // Exclude test users (aibroker_bot)
        if (TEST_USERNAMES.includes(user.username)) return false;

        // Hidden users filter
        const isHidden = isUserHidden(user.user_id);
        if (isHidden && !showHiddenUsers) return false;

        // Activity filter (only works for users with fully loaded data)
        if (activityFilter !== 'all' && (user.todos === null || user.events === null)) {
            // Data not loaded yet - show all users
            return true;
        }

        // Active = has future events OR has active (incomplete) todos
        const isActive = (user.events_future > 0) || (user.todos_active > 0);

        if (activityFilter === 'active' && !isActive) return false;
        if (activityFilter === 'inactive' && isActive) return false;

        return true;
    });
}

function renderUsers() {
    const users = getFilteredUsers();
    const container = document.getElementById('usersList');

    if (users.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">üìã</div>
                <div>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</div>
            </div>
        `;
        return;
    }

    container.innerHTML = users.map((user, index) => renderUserCard(user, index)).join('');
}

function renderUserCard(user, index) {
    const name = user.username ? `@${user.username}` :
                 (user.first_name || user.last_name) ? `${user.first_name || ''} ${user.last_name || ''}`.trim() :
                 `User ${user.user_id}`;

    const initial = name.charAt(0) === '@' ? name.charAt(1).toUpperCase() : name.charAt(0).toUpperCase();
    const isHidden = isUserHidden(user.user_id);
    const hiddenClass = isHidden ? 'is-hidden' : '';
    const hideBtnClass = isHidden ? 'hidden-user' : '';
    const hideIcon = isHidden ? 'üëÅ‚Äçüó®' : 'üëÅ';

    // Show counts only if loaded
    const todosCount = user.todos_count !== null ? user.todos_count : '‚Äî';
    const eventsCount = user.events_count !== null ? user.events_count : '‚Äî';
    const todosActive = user.todos_active !== undefined ? user.todos_active : '‚Äî';
    const eventsFuture = user.events_future !== undefined ? user.events_future : '‚Äî';

    return `
        <div class="user-card ${hiddenClass}" id="user-${index}" data-user-id="${user.user_id}">
            <div class="user-header" onclick="toggleUser(${index})">
                <div class="user-info">
                    <div class="user-avatar">${initial}</div>
                    <div>
                        <div class="user-name">${escapeHtml(name)}</div>
                        <div class="user-id">${user.user_id}</div>
                    </div>
                </div>
                <div class="user-stats">
                    <div class="user-stat" id="stat-todos-${index}">
                        <div class="count">${todosActive}/${todosCount}</div>
                        <div class="label">–ó–∞–¥–∞—á</div>
                    </div>
                    <div class="user-stat" id="stat-events-${index}">
                        <div class="count">${eventsFuture}/${eventsCount}</div>
                        <div class="label">–°–æ–±—ã—Ç–∏–π</div>
                    </div>
                    <button class="hide-btn ${hideBtnClass}" onclick="toggleUserHidden(event, '${user.user_id}')" title="${isHidden ? '–ü–æ–∫–∞–∑–∞—Ç—å' : '–°–∫—Ä—ã—Ç—å'}">
                        ${hideIcon}
                    </button>
                </div>
            </div>
            <div class="user-details" id="details-${index}">
                <div class="details-tabs">
                    <div class="details-tab active" onclick="switchTab(event, ${index}, 'todos')">–ó–∞–¥–∞—á–∏</div>
                    <div class="details-tab" onclick="switchTab(event, ${index}, 'events')">–°–æ–±—ã—Ç–∏—è</div>
                </div>
                <div class="details-content" id="content-${index}">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    `;
}

async function toggleUser(index) {
    const details = document.getElementById(`details-${index}`);
    const isExpanding = !details.classList.contains('expanded');
    details.classList.toggle('expanded');

    if (isExpanding) {
        const user = getFilteredUsers()[index];
        const content = document.getElementById(`content-${index}`);

        if (!user) return;

        if (user.todos !== null && user.events !== null) {
            // Data already loaded ‚Äî render immediately without loader
            content.innerHTML = renderTodos(user);
        } else {
            // Data not loaded ‚Äî show loader and load
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            await loadUserData(index, user.user_id);
        }
    }
}

// Load todos and events for a user
async function loadUserData(index, userId) {
    const content = document.getElementById(`content-${index}`);

    // Check if data already loaded
    const userIndex = reportData.users.findIndex(u => u.user_id === userId);
    if (userIndex !== -1 && reportData.users[userIndex].todos !== null && reportData.users[userIndex].events !== null) {
        // Data already loaded ‚Äî just render
        content.innerHTML = renderTodos(reportData.users[userIndex]);
        return;
    }

    // Show loader only if data not loaded
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
        // Load todos and events in parallel
        const [todosRes, eventsRes] = await Promise.all([
            fetch(`${API_BASE}/users/${userId}/todos`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            }),
            fetch(`${API_BASE}/users/${userId}/events`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            })
        ]);

        const todos = todosRes.ok ? await todosRes.json() : [];
        const events = eventsRes.ok ? await eventsRes.json() : [];

        // Update user data in reportData
        const userIndex = reportData.users.findIndex(u => u.user_id === userId);
        if (userIndex !== -1) {
            const now = new Date();
            reportData.users[userIndex].todos = todos;
            reportData.users[userIndex].events = events;
            reportData.users[userIndex].todos_count = todos.length;
            reportData.users[userIndex].todos_active = todos.filter(t => !t.completed).length;
            reportData.users[userIndex].todos_completed = todos.filter(t => t.completed).length;
            reportData.users[userIndex].events_count = events.length;
            reportData.users[userIndex].events_past = events.filter(e => new Date(e.start) < now).length;
            reportData.users[userIndex].events_future = events.filter(e => new Date(e.start) >= now).length;

            // Update stats in header
            const todosActive = reportData.users[userIndex].todos_active;
            const todosCount = reportData.users[userIndex].todos_count;
            const eventsFuture = reportData.users[userIndex].events_future;
            const eventsCount = reportData.users[userIndex].events_count;

            const statTodos = document.getElementById(`stat-todos-${index}`);
            const statEvents = document.getElementById(`stat-events-${index}`);
            if (statTodos) statTodos.innerHTML = `<div class="count">${todosActive}/${todosCount}</div><div class="label">–ó–∞–¥–∞—á</div>`;
            if (statEvents) statEvents.innerHTML = `<div class="count">${eventsFuture}/${eventsCount}</div><div class="label">–°–æ–±—ã—Ç–∏–π</div>`;

            // Update global summary after loading user data
            updateSummary();
        }

        // Render todos by default
        const user = reportData.users.find(u => u.user_id === userId);
        content.innerHTML = renderTodos(user);

    } catch (e) {
        console.error('Error loading user data:', e);
        content.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div></div>';
    }
}

function switchTab(e, index, tab) {
    e.stopPropagation();
    const user = getFilteredUsers()[index];
    const tabs = document.querySelectorAll(`#user-${index} .details-tab`);
    tabs.forEach(t => t.classList.remove('active'));
    e.target.classList.add('active');

    const content = document.getElementById(`content-${index}`);
    content.innerHTML = tab === 'todos' ? renderTodos(user) : renderEvents(user);
}

function renderTodos(user) {
    try {
        const todosFilter = document.getElementById('filterTodos').value;
        let todos = user.todos || [];

        if (todosFilter === 'active') {
            todos = todos.filter(t => !t.completed);
        } else if (todosFilter === 'completed') {
            todos = todos.filter(t => t.completed);
        }

        if (todos.length === 0) {
            return '<div class="empty-state"><div class="icon">‚úì</div><div>–ù–µ—Ç –∑–∞–¥–∞—á</div></div>';
        }

        return `
            <div class="items-list">
                ${todos.map(todo => `
                    <div class="item-row ${todo.completed ? 'completed' : ''}">
                        <div class="item-checkbox ${todo.completed ? 'checked' : ''}"></div>
                        <div style="flex:1">
                            <div class="item-title">${escapeHtml(todo.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
                            ${todo.due_date ? `<div class="item-date">–°—Ä–æ–∫: ${formatDate(todo.due_date)}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (e) {
        console.error('renderTodos error:', e);
        return '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</div></div>';
    }
}

function renderEvents(user) {
    try {
        const eventsFilter = document.getElementById('filterEvents').value;
        const now = new Date();
        let events = user.events || [];

        if (eventsFilter === 'future') {
            events = events.filter(e => new Date(e.start) >= now);
        } else if (eventsFilter === 'past') {
            events = events.filter(e => new Date(e.start) < now);
        }

        // Sort by date
        events.sort((a, b) => new Date(a.start) - new Date(b.start));

        if (events.length === 0) {
            return '<div class="empty-state"><div class="icon">üìÖ</div><div>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div></div>';
        }

        return `
            <div class="items-list">
                ${events.map(event => {
                    const start = new Date(event.start);
                    const isPast = start < now;
                    return `
                        <div class="item-row ${isPast ? 'past' : ''}">
                            <div class="item-time">${formatTime(start)}</div>
                            <div style="flex:1">
                                <div class="item-title">${escapeHtml(event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
                                <div class="item-date">${formatDate(event.start)}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    } catch (e) {
        console.error('renderEvents error:', e);
        return '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</div></div>';
    }
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatTime(d) {
    return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// Expose functions to window for onclick handlers
window.toggleUser = toggleUser;
window.loadUserData = loadUserData;
window.switchTab = switchTab;
window.toggleUserHidden = toggleUserHidden;
window.toggleShowHidden = toggleShowHidden;
window.applyFilters = applyFilters;

// Init
restoreSession();
</script>

</body>
</html>
