<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AI Calendar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --bg-primary: #0b0b0b;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #181A20;
            --border-color: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #ffffff;
        }
        body {font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary);}
        .stat-card {background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; transition: all 0.2s; cursor: pointer;}
        .stat-card:hover {transform: translateY(-2px); border-color: #444; box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);}
        .chart-wrapper {position: relative; height: 300px; width: 100%;}
        @media (max-width: 768px) {.chart-wrapper {height: 250px;}}
        .badge-test {background: #333; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;}
        .clickable-row {cursor: pointer; transition: background 0.2s;}
        .clickable-row:hover {background: var(--bg-tertiary) !important;}
        /* Override Tailwind colors */
        .bg-slate-800, .bg-slate-900 {background: var(--bg-secondary) !important;}
        .bg-slate-700 {background: var(--bg-tertiary) !important;}
        .border-slate-700, .border-slate-600 {border-color: var(--border-color) !important;}
        .text-slate-400, .text-slate-500 {color: var(--text-secondary) !important;}
        .bg-red-600 {background: #333 !important;}
        .bg-red-600:hover, .hover\:bg-red-700:hover {background: #444 !important;}
        .bg-blue-600 {background: var(--bg-tertiary) !important;}
        .bg-blue-600:hover, .hover\:bg-blue-700:hover {background: #222 !important;}
        .focus\:ring-blue-500:focus {--tw-ring-color: #444 !important;}
        .text-blue-400 {color: var(--text-primary) !important;}
        .text-green-400 {color: #a0a0a0 !important;}
        .text-purple-400 {color: #c0c0c0 !important;}
        .text-yellow-400 {color: #d0d0d0 !important;}
        .text-red-400 {color: #888 !important;}
        .text-orange-400 {color: #b0b0b0 !important;}
        .divide-slate-700 > :not([hidden]) ~ :not([hidden]) {border-color: var(--border-color) !important;}
        .from-slate-800, .to-slate-900, .from-blue-400, .to-purple-400 {--tw-gradient-from: var(--bg-secondary); --tw-gradient-to: var(--bg-primary);}
        .bg-gradient-to-br, .bg-gradient-to-r {background: var(--bg-secondary) !important;}
        .bg-clip-text {-webkit-background-clip: text; background-clip: text; color: var(--text-primary) !important; -webkit-text-fill-color: var(--text-primary) !important;}
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md">
        <h1 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Admin Panel</h1>
        <form id="loginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">–õ–æ–≥–∏–Ω</label>
                <input type="text" id="username" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="admin" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
            </div>
            <div id="totpField" class="hidden">
                <label class="block text-sm font-medium mb-2">2FA –∫–æ–¥ (Google Authenticator)</label>
                <input type="text" id="totpCode" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="123456" maxlength="6" pattern="[0-9]{6}">
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors">–í–æ–π—Ç–∏</button>
        </form>
        <div id="loginError" class="hidden mt-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-sm"></div>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl md:text-2xl font-bold">AI Calendar Admin</h1>
                    <button onclick="showDashboard()" id="backBtn" class="hidden px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
                <div class="flex items-center gap-3">
                    <select id="periodSelector" onchange="changePeriod(this.value)" class="bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm">
                        <option value="7">7 –¥–Ω–µ–π</option>
                        <option value="30" selected>30 –¥–Ω–µ–π</option>
                        <option value="60">60 –¥–Ω–µ–π</option>
                    </select>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            <!-- Tab Navigation -->
            <div class="flex gap-1 -mb-px" id="tabNav">
                <button onclick="showTab('overview')" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium transition-colors bg-slate-700 text-white" data-tab="overview">üìä –û–±–∑–æ—Ä</button>
                <button onclick="showTab('users')" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium transition-colors bg-slate-900 text-slate-400 hover:text-white" data-tab="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button onclick="showTab('llm')" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium transition-colors bg-slate-900 text-slate-400 hover:text-white" data-tab="llm">ü§ñ LLM</button>
                <button onclick="showTab('errors')" class="tab-btn px-4 py-2 rounded-t-lg text-sm font-medium transition-colors bg-slate-900 text-slate-400 hover:text-white" data-tab="errors">‚ùå –û—à–∏–±–∫–∏</button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-7xl">

        <!-- Tab: Overview -->
        <div id="overviewTab" class="tab-content">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card" onclick="filterByType('users')">
                    <div class="text-3xl font-bold text-blue-400" id="totalUsers">0</div>
                    <div class="text-sm text-slate-400 mt-1">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('events')">
                    <div class="text-3xl font-bold text-green-400" id="totalEvents">0</div>
                    <div class="text-sm text-slate-400 mt-1">üìÖ –°–æ–±—ã—Ç–∏–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('messages')">
                    <div class="text-3xl font-bold text-purple-400" id="totalMessages">0</div>
                    <div class="text-sm text-slate-400 mt-1">üí¨ –°–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('errors')">
                    <div class="text-3xl font-bold text-red-400" id="totalErrors">0</div>
                    <div class="text-sm text-slate-400 mt-1">‚ùå –û—à–∏–±–æ–∫</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="chart-wrapper"><canvas id="activityChart"></canvas></div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π</h3>
                    <div class="chart-wrapper"><canvas id="distributionChart"></canvas></div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden mb-6">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–±—ã—Ç–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–æ–±—â–µ–Ω–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody id="actionsTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Broadcast Section -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden mt-6">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h3>
                    <button onclick="toggleBroadcast()" id="broadcastToggle" class="text-sm text-blue-400 hover:text-blue-300">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
                </div>
                <div id="broadcastPanel" class="hidden p-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (HTML)</label>
                        <textarea id="broadcastMessage" rows="4" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="üîÑ <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞!</b>&#10;&#10;–ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" id="broadcastButtonText" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="üöÄ –û–±–Ω–æ–≤–∏—Ç—å">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–∫–∏</label>
                            <select id="broadcastButtonAction" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">–ë–µ–∑ –∫–Ω–æ–ø–∫–∏</option>
                                <option value="start">–í—ã–∑–≤–∞—Ç—å /start</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="broadcastTestOnly" class="w-4 h-4 rounded bg-slate-900 border-slate-600 text-blue-500 focus:ring-blue-500">
                            <span class="text-sm">–¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–±–µ)</span>
                        </label>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="sendBroadcast()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                        <button onclick="previewBroadcast()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
                            üëÅ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </div>
                    <div id="broadcastResult" class="hidden p-4 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Users -->
        <div id="usersTab" class="tab-content hidden">
            <!-- DAU/MAU Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-blue-400" id="dauToday">0</div>
                    <div class="text-sm text-slate-400 mt-1">DAU —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-green-400" id="mauTotal">0</div>
                    <div class="text-sm text-slate-400 mt-1">MAU –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-400" id="dauMauRatio">0%</div>
                    <div class="text-sm text-slate-400 mt-1">DAU/MAU</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-yellow-400" id="newUsersCount">0</div>
                    <div class="text-sm text-slate-400 mt-1">–ù–æ–≤—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">DAU –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-wrapper"><canvas id="dauChart"></canvas></div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–°–µ–≥–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="chart-wrapper"><canvas id="segmentsChart"></canvas></div>
                    <div id="segmentsLegend" class="mt-4 text-sm"></div>
                </div>
            </div>

            <!-- Retention -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-3">Retention</h3>
                    <div class="flex gap-4">
                        <div class="flex-1 bg-slate-900 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-400" id="retentionDay1">0%</div>
                            <div class="text-xs text-slate-400 mt-1">Day 1</div>
                        </div>
                        <div class="flex-1 bg-slate-900 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="retentionDay7">0%</div>
                            <div class="text-xs text-slate-400 mt-1">Day 7</div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-3">–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-slate-400">–°—Ä–µ–¥–Ω–∏–π DAU:</span><span id="avgDau" class="font-medium">0</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è:</span><span id="activeToday" class="font-medium text-green-400">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Top Users Table -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">#</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–±—ã—Ç–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–æ–±—â–µ–Ω–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">LLM ‚ÇΩ</th>
                            </tr>
                        </thead>
                        <tbody id="topUsersTable" class="divide-y divide-slate-700">
                            <tr><td colspan="6" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: LLM Costs -->
        <div id="llmTab" class="tab-content hidden">
            <!-- LLM Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-green-400" id="llmTotalCost">0 ‚ÇΩ</div>
                    <div class="text-sm text-slate-400 mt-1">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-blue-400" id="llmTotalTokens">0</div>
                    <div class="text-sm text-slate-400 mt-1">–¢–æ–∫–µ–Ω–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-400" id="llmTotalRequests">0</div>
                    <div class="text-sm text-slate-400 mt-1">–ó–∞–ø—Ä–æ—Å–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-yellow-400" id="llmAvgCostPerDay">0 ‚ÇΩ</div>
                    <div class="text-sm text-slate-400 mt-1">–°—Ä–µ–¥–Ω–∏–π –∑–∞ –¥–µ–Ω—å</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–†–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-wrapper"><canvas id="llmCostChart"></canvas></div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–ü–æ –º–æ–¥–µ–ª—è–º</h3>
                    <div class="chart-wrapper"><canvas id="llmModelsChart"></canvas></div>
                </div>
            </div>

            <!-- LLM by User Table -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–†–∞—Å—Ö–æ–¥—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ó–∞–ø—Ä–æ—Å–æ–≤</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–¢–æ–∫–µ–Ω–æ–≤</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="llmUsersTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Errors -->
        <div id="errorsTab" class="tab-content hidden">
            <!-- Error Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-red-400" id="errorsTotal">0</div>
                    <div class="text-sm text-slate-400 mt-1">–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-yellow-400" id="errorsToday">0</div>
                    <div class="text-sm text-slate-400 mt-1">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-orange-400" id="errorsLLM">0</div>
                    <div class="text-sm text-slate-400 mt-1">LLM –æ—à–∏–±–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-400" id="errorsOther">0</div>
                    <div class="text-sm text-slate-400 mt-1">–ü—Ä–æ—á–∏–µ</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–û—à–∏–±–∫–∏ –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-wrapper"><canvas id="errorsTimelineChart"></canvas></div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–ü–æ —Ç–∏–ø–∞–º</h3>
                    <div class="chart-wrapper"><canvas id="errorsTypesChart"></canvas></div>
                </div>
            </div>

            <!-- Errors Table -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–¢–∏–ø</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- User Profile View -->
        <div id="userView" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span id="userIdTitle" class="font-mono text-blue-400"></span></h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-400" id="userEventsCount">0</div>
                        <div class="text-sm text-slate-400">üìÖ –°–æ–±—ã—Ç–∏—è</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-400" id="userMessagesCount">0</div>
                        <div class="text-sm text-slate-400">üí¨ –¢–µ–∫—Å—Ç</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-400" id="userVoiceCount">0</div>
                        <div class="text-sm text-slate-400">üé§ –ì–æ–ª–æ—Å</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-red-400" id="userErrorsCount">0</div>
                        <div class="text-sm text-slate-400">‚ùå –û—à–∏–±–∫–∏</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-yellow-400" id="userActionsCount">0</div>
                        <div class="text-sm text-slate-400">üìä –í—Å–µ–≥–æ</div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="userActionsTable" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Filtered View -->
        <div id="filteredView" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4" id="filterTitle"></h2>
                <div class="text-sm text-slate-400" id="filterSubtitle"></div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody id="filteredTable" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const API_BASE = '/api/admin';
const API_V2 = '/api/admin/v2';
let activityChart = null;
let distributionChart = null;
let refreshInterval = null;
let currentView = 'main';
let allActions = [];
let errorsData = { errors: [], stats: { total: 0, by_type: {} } };
let requires2FA = false;

// New analytics state
let currentTab = 'overview';
let currentPeriod = 30;
let dauChart = null;
let segmentsChart = null;
let llmCostChart = null;
let llmModelsChart = null;
let errorsTimelineChart = null;
let errorsTypesChart = null;
let tabDataCache = {};

// XSS protection - escape HTML entities
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// XSS protection for HTML attributes (escapes quotes)
function escapeAttr(text) {
    if (!text) return '';
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

// Restore session - check if already authenticated via httpOnly cookie
async function restoreSession() {
    console.log('[Admin] restoreSession() called');
    try {
        // Check auth status via /me endpoint (uses httpOnly cookie)
        const response = await fetch(`${API_V2}/me`, {
            credentials: 'include'
        });
        console.log('[Admin] /me response status:', response.status);

        if (response.ok) {
            const user = await response.json();
            console.log('[Admin] Session valid! User:', user.username);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboard();
            refreshInterval = setInterval(() => { if (currentView === 'main') loadDashboard(); }, 30000);
        } else {
            console.log('[Admin] No valid session, showing login form');
        }
    } catch (e) {
        console.error('[Admin] Error checking session:', e);
    }
}

// Get language from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const userLang = urlParams.get('lang') || 'ru';

// Translations object
const translations = {
    ru: {
        adminPanel: 'Admin Panel',
        firstPassword: '–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å',
        secondPassword: '–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å',
        thirdPassword: '–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–æ–ª—å',
        login: '–í–æ–π—Ç–∏',
        logout: '–í—ã–π—Ç–∏',
        back: '‚Üê –ù–∞–∑–∞–¥',
        users: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        events: '–°–æ–±—ã—Ç–∏–π',
        messages: '–°–æ–æ–±—â–µ–Ω–∏–π',
        errors: '–û—à–∏–±–æ–∫',
        userActivity: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        actionDistribution: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π',
        recentUsers: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        userId: 'User ID',
        lastActivity: '–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        userDetails: '–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        created: '–°–æ–∑–¥–∞–Ω',
        totalActions: '–í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π',
        text: '–¢–µ–∫—Å—Ç',
        voice: '–ì–æ–ª–æ—Å',
        actionsHistory: '–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π',
        time: '–í—Ä–µ–º—è',
        action: '–î–µ–π—Å—Ç–≤–∏–µ',
        details: '–î–µ—Ç–∞–ª–∏',
        status: '–°—Ç–∞—Ç—É—Å',
        invalidPassword: '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–æ–ª–∏',
        connectionError: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º'
    },
    en: {
        adminPanel: 'Admin Panel',
        firstPassword: 'First Password',
        secondPassword: 'Second Password',
        thirdPassword: 'Third Password',
        login: 'Login',
        logout: 'Logout',
        back: '‚Üê Back',
        users: 'Users',
        events: 'Events',
        messages: 'Messages',
        errors: 'Errors',
        userActivity: 'User Activity',
        actionDistribution: 'Action Distribution',
        recentUsers: 'Recent Users',
        userId: 'User ID',
        lastActivity: 'Last Activity',
        loading: 'Loading...',
        userDetails: 'User Details',
        created: 'Created',
        totalActions: 'Total Actions',
        text: 'Text',
        voice: 'Voice',
        actionsHistory: 'Actions History',
        time: 'Time',
        action: 'Action',
        details: 'Details',
        status: 'Status',
        invalidPassword: 'Invalid passwords',
        connectionError: 'Server connection error'
    },
    es: {
        adminPanel: 'Panel de Administraci√≥n',
        firstPassword: 'Primera Contrase√±a',
        secondPassword: 'Segunda Contrase√±a',
        login: 'Ingresar',
        logout: 'Salir',
        back: '‚Üê Atr√°s',
        users: 'Usuarios',
        events: 'Eventos',
        messages: 'Mensajes',
        errors: 'Errores',
        userActivity: 'Actividad de Usuarios',
        actionDistribution: 'Distribuci√≥n de Acciones',
        recentUsers: 'Usuarios Recientes',
        userId: 'ID de Usuario',
        lastActivity: '√öltima Actividad',
        loading: 'Cargando...',
        userDetails: 'Detalles del Usuario',
        created: 'Creado',
        totalActions: 'Acciones Totales',
        text: 'Texto',
        voice: 'Voz',
        actionsHistory: 'Historial de Acciones',
        time: 'Hora',
        action: 'Acci√≥n',
        details: 'Detalles',
        status: 'Estado',
        invalidPassword: 'Contrase√±as inv√°lidas',
        connectionError: 'Error de conexi√≥n con el servidor'
    },
    ar: {
        adminPanel: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
        firstPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ£ŸàŸÑŸâ',
        secondPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ´ÿßŸÜŸäÿ©',
        login: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
        logout: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
        back: '‚Üí ÿ±ÿ¨Ÿàÿπ',
        users: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ',
        events: 'ÿßŸÑÿ£ÿ≠ÿØÿßÿ´',
        messages: 'ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ',
        errors: 'ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°',
        userActivity: 'ŸÜÿ¥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ',
        actionDistribution: 'ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        recentUsers: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑÿ£ÿÆŸäÿ±ŸàŸÜ',
        userId: 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        lastActivity: 'ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑',
        loading: 'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',
        userDetails: 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        created: 'ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°',
        totalActions: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        text: 'ŸÜÿµ',
        voice: 'ÿµŸàÿ™',
        actionsHistory: 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        time: 'ÿßŸÑŸàŸÇÿ™',
        action: 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°',
        details: 'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ',
        status: 'ÿßŸÑÿ≠ÿßŸÑÿ©',
        invalidPassword: 'ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©',
        connectionError: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ'
    }
};

// Translation helper function
function t(key) {
    return translations[userLang]?.[key] || translations['ru'][key] || key;
}

const actionLabels = {
    'user_start': 'üöÄ ' + t('text'),
    'event_create': '‚ûï ' + (userLang === 'ru' ? '–°–æ–∑–¥–∞–Ω–∏–µ' : userLang === 'en' ? 'Create' : userLang === 'es' ? 'Crear' : 'ÿ•ŸÜÿ¥ÿßÿ°'),
    'event_update': '‚úèÔ∏è ' + (userLang === 'ru' ? '–ò–∑–º–µ–Ω–µ–Ω–∏–µ' : userLang === 'en' ? 'Update' : userLang === 'es' ? 'Actualizar' : 'ÿ™ÿ≠ÿØŸäÿ´'),
    'event_delete': 'üóëÔ∏è ' + (userLang === 'ru' ? '–£–¥–∞–ª–µ–Ω–∏–µ' : userLang === 'en' ? 'Delete' : userLang === 'es' ? 'Eliminar' : 'ÿ≠ÿ∞ŸÅ'),
    'event_query': 'üîç ' + (userLang === 'ru' ? '–ü–æ–∏—Å–∫' : userLang === 'en' ? 'Search' : userLang === 'es' ? 'Buscar' : 'ÿ®ÿ≠ÿ´'),
    'text_message': 'üí¨ ' + t('messages'),
    'voice_message': 'üé§ ' + t('voice'),
    'error': '‚ùå ' + (userLang === 'ru' ? '–û—à–∏–±–∫–∞' : userLang === 'en' ? 'Error' : userLang === 'es' ? 'Error' : 'ÿÆÿ∑ÿ£'),
    // Error types for detailed tracking
    'llm_error': 'ü§ñ‚ùå LLM API',
    'llm_parse_error': 'üìù‚ùå JSON Parse',
    'llm_timeout': '‚è±Ô∏è‚ùå Timeout',
    'calendar_error': 'üìÖ‚ùå Calendar',
    'stt_error': 'üé§‚ùå STT',
    'intent_unclear': '‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ'
};

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const totpCode = document.getElementById('totpCode')?.value || '';

    try {
        const response = await fetch(`${API_V2}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({
                username: username,
                password: password,
                totp_code: totpCode || null
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Login successful
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboard();
            refreshInterval = setInterval(() => { if (currentView === 'main') loadDashboard(); }, 30000);
        } else if (response.status === 400 && data.detail?.includes('2FA')) {
            // 2FA required - show TOTP field
            document.getElementById('totpField').classList.remove('hidden');
            showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Google Authenticator');
        } else {
            showError(data.detail || t('invalidPassword'));
        }
    } catch (err) {
        showError(t('connectionError'));
    }
});

function showError(message) {
    const errorEl = document.getElementById('loginError');
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
}

async function logout() {
    try {
        await fetch(`${API_V2}/logout`, {
            method: 'POST',
            credentials: 'include'
        });
    } catch (e) {
        console.error('[Admin] Logout error:', e);
    }
    if (refreshInterval) clearInterval(refreshInterval);
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('totpCode').value = '';
    document.getElementById('totpField').classList.add('hidden');
    document.getElementById('loginError').classList.add('hidden');
}

async function fetchAPI(endpoint) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            credentials: 'include'
        });
        if (!response.ok) {
            if (response.status === 401) {
                // Session expired - redirect to login
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                if (refreshInterval) clearInterval(refreshInterval);
            }
            throw new Error(`API error: ${response.status}`);
        }
        return response.json();
    } catch (e) {
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
            console.error('[Admin] Network error:', e.message);
            throw new Error(t('connectionError'));
        }
        throw e;
    }
}

async function loadDashboard() {
    try {
        // Use correct API endpoints that match admin.py
        const stats = await fetchAPI('/stats');
        document.getElementById('totalUsers').textContent = stats.total_users;
        document.getElementById('totalEvents').textContent = stats.total_events_created;
        document.getElementById('totalMessages').textContent = stats.total_messages;

        // Load errors from new endpoint
        let errorsCount = 0;
        try {
            errorsData = await fetchAPI('/errors?hours=24&limit=100');
            errorsCount = errorsData.stats?.total || 0;
        } catch (e) {
            console.log('Errors endpoint not available:', e);
            errorsData = { errors: [], stats: { total: 0, by_type: {} } };
        }
        document.getElementById('totalErrors').textContent = errorsCount;

        // Timeline - use new endpoint
        try {
            const timeline = await fetchAPI('/timeline?hours=24');
            updateActivityChart(timeline);
        } catch (e) {
            console.log('Timeline not available:', e);
            updateActivityChart([]);
        }

        // Users list
        const users = await fetchAPI('/users');
        updateUsersTable(users.slice(0, 10));

        // Actions - use new endpoint
        try {
            allActions = await fetchAPI('/actions?limit=200');
            updateActionsTable(allActions.slice(0, 10));
        } catch (e) {
            console.log('Actions not available:', e);
            allActions = [];
            updateActionsTable([]);
        }

        // Distribution chart with available data (including errors)
        updateDistributionChart({
            total_events: stats.total_events_created,
            total_messages: stats.total_messages,
            total_errors: errorsCount
        });
    } catch (err) {
        console.error('Failed to load dashboard:', err);
    }
}

function updateActivityChart(data) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    if (activityChart) activityChart.destroy();

    const maxPoints = 24;
    const labels = data.slice(-maxPoints).map(d => new Date(d.timestamp).getHours() + ':00');
    const values = data.slice(-maxPoints).map(d => d.value);

    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–î–µ–π—Å—Ç–≤–∏—è',
                data: values,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {display: false}},
            scales: {
                y: {beginAtZero: true, ticks: {color: '#888'}, grid: {color: '#2a2a2a'}},
                x: {ticks: {color: '#888'}, grid: {color: '#2a2a2a'}}
            }
        }
    });
}

function updateDistributionChart(stats) {
    const ctx = document.getElementById('distributionChart').getContext('2d');
    if (distributionChart) distributionChart.destroy();

    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['–°–æ–±—ã—Ç–∏—è', '–°–æ–æ–±—â–µ–Ω–∏—è', '–û—à–∏–±–∫–∏'],
            datasets: [{
                data: [stats.total_events, stats.total_messages, stats.total_errors],
                backgroundColor: ['#4ade80', '#a78bfa', '#f87171'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {position: 'bottom', labels: {color: '#888'}}}
        }
    });
}

function updateUsersTable(users) {
    const tbody = document.getElementById('usersTable');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(u => {
        const lastSeen = u.last_seen ? new Date(u.last_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        }) : '-';

        // Build user display name and Telegram link (XSS-safe)
        let userName = escapeHtml(u.user_id);
        let tgLink = '';
        if (u.username) {
            userName = `@${escapeHtml(u.username)}`;
            tgLink = ` <a href="https://t.me/${escapeAttr(u.username)}" target="_blank" class="text-blue-400 hover:text-blue-300">üîó</a>`;
        } else if (u.first_name || u.last_name) {
            userName = [u.first_name, u.last_name].filter(Boolean).map(escapeHtml).join(' ');
        }

        const userDisplay = `<div class="font-mono text-blue-400">${escapeHtml(u.user_id)}</div>
                             <div class="text-xs text-slate-500">${userName}${tgLink}</div>`;

        // Use fields from UserDetail model
        const totalEvents = u.total_actions || 0;
        const totalMessages = u.actions_today || 0;

        return `
            <tr class="clickable-row" onclick="showUserProfile('${u.user_id}')">
                <td class="px-4 py-3 text-sm">${userDisplay}</td>
                <td class="px-4 py-3 text-sm">${totalEvents}</td>
                <td class="px-4 py-3 text-sm">${totalMessages}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${lastSeen}</td>
            </tr>
        `;
    }).join('');
}

function updateActionsTable(actions) {
    const tbody = document.getElementById('actionsTable');
    if (actions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = actions.map(a => {
        const time = new Date(a.timestamp).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const rawDetails = (a.details || '').substring(0, 50) + (a.details?.length > 50 ? '...' : '');
        const details = escapeHtml(rawDetails);
        const testBadge = a.is_test ? '<span class="badge-test ml-2">–¢–ï–°–¢</span>' : '';
        return `
            <tr class="clickable-row" onclick="showUserProfile('${escapeAttr(a.user_id)}')">
                <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                <td class="px-4 py-3 text-sm font-mono text-blue-400">${escapeHtml(a.user_id)}</td>
                <td class="px-4 py-3 text-sm">${escapeHtml(actionLabels[a.action_type] || a.action_type)}${testBadge}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${details}</td>
            </tr>
        `;
    }).join('');
}

async function showUserProfile(userId) {
    currentView = 'user';
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('userView').classList.remove('hidden');
    document.getElementById('filteredView').classList.add('hidden');
    document.getElementById('backBtn').classList.remove('hidden');

    document.getElementById('userIdTitle').textContent = userId;

    try {
        // Use correct endpoint: /users/{id}/dialog
        const actions = await fetchAPI(`/users/${userId}/dialog?limit=500`);

        const events = actions.filter(a => ['event_create', 'event_update', 'event_delete'].includes(a.action_type)).length;
        const messages = actions.filter(a => a.action_type === 'text_message').length;
        const voice = actions.filter(a => a.action_type === 'voice_message').length;
        const errors = actions.filter(a => a.action_type === 'error').length;

        document.getElementById('userEventsCount').textContent = events;
        document.getElementById('userMessagesCount').textContent = messages;
        document.getElementById('userVoiceCount').textContent = voice;
        document.getElementById('userErrorsCount').textContent = errors;
        document.getElementById('userActionsCount').textContent = actions.length;

        const tbody = document.getElementById('userActionsTable');
        tbody.innerHTML = actions.map(a => {
            const time = new Date(a.timestamp).toLocaleString('ru-RU', {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            const testBadge = a.is_test ? ' <span class="badge-test">–¢–ï–°–¢</span>' : '';
            const statusIcon = a.success ? '‚úÖ' : '‚ùå';
            return `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                    <td class="px-4 py-3 text-sm">${actionLabels[a.action_type] || a.action_type}${testBadge}</td>
                    <td class="px-4 py-3 text-sm text-slate-400">${a.details || '-'}</td>
                    <td class="px-4 py-3 text-sm text-center">${statusIcon}</td>
                </tr>
            `;
        }).join('');
    } catch (err) {
        console.error('Failed to load user profile:', err);
    }
}

async function filterByType(type) {
    currentView = 'filter';
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('userView').classList.add('hidden');
    document.getElementById('filteredView').classList.remove('hidden');
    document.getElementById('backBtn').classList.remove('hidden');

    let filtered = [];
    let title = '';
    let subtitle = '';

    if (type === 'events') {
        title = 'üìÖ –í—Å–µ —Å–æ–±—ã—Ç–∏—è';
        filtered = allActions.filter(a => ['event_create', 'event_update', 'event_delete'].includes(a.action_type));
        subtitle = `–°–æ–∑–¥–∞–Ω–æ: ${filtered.filter(a => a.action_type === 'event_create').length}, –ò–∑–º–µ–Ω–µ–Ω–æ: ${filtered.filter(a => a.action_type === 'event_update').length}, –£–¥–∞–ª–µ–Ω–æ: ${filtered.filter(a => a.action_type === 'event_delete').length}`;
    } else if (type === 'messages') {
        title = 'üí¨ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
        filtered = allActions.filter(a => ['text_message', 'voice_message'].includes(a.action_type));
        subtitle = `–¢–µ–∫—Å—Ç–æ–≤—ã—Ö: ${filtered.filter(a => a.action_type === 'text_message').length}, –ì–æ–ª–æ—Å–æ–≤—ã—Ö: ${filtered.filter(a => a.action_type === 'voice_message').length}`;
    } else if (type === 'errors') {
        title = '‚ùå –û—à–∏–±–∫–∏ –∑–∞ 24 —á–∞—Å–∞';
        // Use errors from dedicated endpoint
        if (errorsData.errors && errorsData.errors.length > 0) {
            // Build subtitle with error breakdown
            const byType = errorsData.stats?.by_type || {};
            const typeBreakdown = Object.entries(byType)
                .map(([type, count]) => `${actionLabels[type] || type}: ${count}`)
                .join(', ');
            subtitle = `–í—Å–µ–≥–æ: ${errorsData.stats?.total || 0}` + (typeBreakdown ? ` | ${typeBreakdown}` : '');

            // Show errors table (XSS-safe)
            const tbody = document.getElementById('filteredTable');
            tbody.innerHTML = errorsData.errors.map(e => {
                const time = new Date(e.timestamp).toLocaleString('ru-RU', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const userName = e.username ? `@${escapeHtml(e.username)}` : escapeHtml(e.first_name || e.user_id);
                const rawErrorMsg = e.error_message ? e.error_message.substring(0, 100) + (e.error_message.length > 100 ? '...' : '') : '';
                const errorMsg = rawErrorMsg ? `<div class="text-xs text-red-400 mt-1">${escapeHtml(rawErrorMsg)}</div>` : '';
                return `
                    <tr class="clickable-row text-red-300" onclick="showUserProfile('${escapeAttr(e.user_id)}')">
                        <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-mono text-blue-400">${escapeHtml(e.user_id)}</div>
                            <div class="text-xs text-slate-500">${userName}</div>
                        </td>
                        <td class="px-4 py-3 text-sm">${escapeHtml(actionLabels[e.action_type] || e.action_type)}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="text-slate-400">${escapeHtml(e.details || '-')}</div>
                            ${errorMsg}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('filterTitle').textContent = title;
            document.getElementById('filterSubtitle').textContent = subtitle;
            return;
        } else {
            // Fallback to allActions if errors endpoint not available
            filtered = allActions.filter(a => a.action_type === 'error' || !a.success);
            subtitle = `–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${filtered.length}`;
        }
    } else if (type === 'users') {
        try {
            const users = await fetchAPI('/users');
            showUsersDetailed(users);
            return;
        } catch (err) {
            console.error('Failed to load users:', err);
            return;
        }
    }

    document.getElementById('filterTitle').textContent = title;
    document.getElementById('filterSubtitle').textContent = subtitle;

    const tbody = document.getElementById('filteredTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(a => {
        const time = new Date(a.timestamp).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const testBadge = a.is_test ? ' <span class="badge-test">–¢–ï–°–¢</span>' : '';
        const errorClass = (a.action_type === 'error' || !a.success) ? 'text-red-400' : '';
        return `
            <tr class="clickable-row ${errorClass}" onclick="showUserProfile('${escapeAttr(a.user_id)}')">
                <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                <td class="px-4 py-3 text-sm font-mono text-blue-400">${escapeHtml(a.user_id)}</td>
                <td class="px-4 py-3 text-sm">${escapeHtml(actionLabels[a.action_type] || a.action_type)}${testBadge}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${escapeHtml(a.details || '-')}</td>
            </tr>
        `;
    }).join('');
}

function showUsersDetailed(users) {
    document.getElementById('filterTitle').textContent = 'üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
    document.getElementById('filterSubtitle').textContent = `–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`;

    const tbody = document.getElementById('filteredTable');
    tbody.innerHTML = users.map(u => {
        const firstSeen = new Date(u.first_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric'
        });
        const lastSeen = new Date(u.last_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        // Build user name (XSS-safe)
        let userName = escapeHtml(u.user_id);
        let tgLink = '';
        if (u.username) {
            userName = `@${escapeHtml(u.username)}`;
            tgLink = ` <a href="https://t.me/${escapeAttr(u.username)}" target="_blank" class="text-blue-400 hover:text-blue-300">üîó</a>`;
        } else if (u.first_name || u.last_name) {
            userName = [u.first_name, u.last_name].filter(Boolean).map(escapeHtml).join(' ');
        }

        const userDisplay = `<div class="font-mono text-blue-400">${escapeHtml(u.user_id)}</div>
                             <div class="text-xs text-slate-500">${userName}${tgLink}</div>`;

        return `
            <tr class="clickable-row" onclick="showUserProfile('${escapeAttr(u.user_id)}')">
                <td class="px-4 py-3 text-sm">${firstSeen}</td>
                <td class="px-4 py-3 text-sm">${userDisplay}</td>
                <td class="px-4 py-3 text-sm">–°–æ–±—ã—Ç–∏—è: ${u.total_events}, –°–æ–æ–±—â–µ–Ω–∏—è: ${u.total_messages}, –û—à–∏–±–∫–∏: ${u.total_errors}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${lastSeen}</td>
            </tr>
        `;
    }).join('');
}

// ============ TAB NAVIGATION ============

function showTab(tabName) {
    currentTab = tabName;

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

    // Show selected tab
    const tabEl = document.getElementById(tabName + 'Tab');
    if (tabEl) tabEl.classList.remove('hidden');

    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.remove('bg-slate-900', 'text-slate-400');
            btn.classList.add('bg-slate-700', 'text-white');
        } else {
            btn.classList.remove('bg-slate-700', 'text-white');
            btn.classList.add('bg-slate-900', 'text-slate-400');
        }
    });

    // Hide user/filtered views when switching tabs
    document.getElementById('userView').classList.add('hidden');
    document.getElementById('filteredView').classList.add('hidden');
    document.getElementById('backBtn').classList.add('hidden');
    currentView = 'main';

    // Load tab data
    if (tabName === 'overview') {
        loadDashboard();
    } else if (tabName === 'users') {
        loadUsersTab();
    } else if (tabName === 'llm') {
        loadLLMTab();
    } else if (tabName === 'errors') {
        loadErrorsTab();
    }
}

function changePeriod(days) {
    currentPeriod = parseInt(days);
    tabDataCache = {}; // Clear cache when period changes
    showTab(currentTab); // Reload current tab
}

// ============ USERS TAB ============

async function loadUsersTab() {
    try {
        // Load metrics and top users in parallel
        const [metricsRes, topUsersRes] = await Promise.all([
            fetch(`${API_V2}/users/metrics?days=${currentPeriod}`, { credentials: 'include' }),
            fetch(`${API_V2}/users/top?days=${currentPeriod}&limit=10`, { credentials: 'include' })
        ]);

        if (!metricsRes.ok) {
            console.error('metrics failed:', metricsRes.status, await metricsRes.text());
            throw new Error('Failed to load metrics');
        }
        if (!topUsersRes.ok) {
            console.error('topUsers failed:', topUsersRes.status, await topUsersRes.text());
            throw new Error('Failed to load top users');
        }

        const metrics = await metricsRes.json();
        const topUsersData = await topUsersRes.json();
        const topUsers = topUsersData.users || [];

        console.log('Users tab loaded:', { metrics, topUsers });

        // Update cards
        const todayDau = metrics.dau?.length > 0 ? metrics.dau[metrics.dau.length - 1].count : 0;
        document.getElementById('dauToday').textContent = todayDau;
        document.getElementById('mauTotal').textContent = metrics.mau || 0;
        document.getElementById('dauMauRatio').textContent = (metrics.dau_mau_ratio * 100).toFixed(1) + '%';
        document.getElementById('newUsersCount').textContent = metrics.new_users?.this_month || 0;
        document.getElementById('avgDau').textContent = (metrics.avg_dau || 0).toFixed(1);
        document.getElementById('activeToday').textContent = todayDau;
        document.getElementById('retentionDay1').textContent = (metrics.retention?.day_1 * 100 || 0).toFixed(0) + '%';
        document.getElementById('retentionDay7').textContent = (metrics.retention?.day_7 * 100 || 0).toFixed(0) + '%';

        // DAU Chart
        updateDauChart(metrics.dau || []);

        // Segments Chart
        updateSegmentsChart(metrics.segments || {});

        // Top Users Table
        updateTopUsersTable(topUsers);

    } catch (err) {
        console.error('Failed to load users tab:', err);
        // Show error in table
        document.getElementById('topUsersTable').innerHTML =
            `<tr><td colspan="6" class="px-4 py-3 text-center text-red-400">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</td></tr>`;
    }
}

function updateDauChart(data) {
    const ctx = document.getElementById('dauChart').getContext('2d');
    if (dauChart) dauChart.destroy();

    const labels = data.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const values = data.map(d => d.count);

    dauChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'DAU',
                data: values,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#2a2a2a' } },
                x: { ticks: { color: '#888', maxRotation: 45 }, grid: { color: '#2a2a2a' } }
            }
        }
    });
}

function updateSegmentsChart(segments) {
    const ctx = document.getElementById('segmentsChart').getContext('2d');
    if (segmentsChart) segmentsChart.destroy();

    const labels = ['Power Users', 'Regular', 'Casual', 'Dormant'];
    const data = [
        segments.power_users || 0,
        segments.regular_users || 0,
        segments.casual_users || 0,
        segments.dormant_users || 0
    ];
    const colors = ['#60a5fa', '#4ade80', '#facc15', '#6b7280'];

    segmentsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }
        }
    });

    // Update legend text
    document.getElementById('segmentsLegend').innerHTML = `
        <div class="grid grid-cols-2 gap-2 text-xs">
            <div><span style="color:#60a5fa">‚óè</span> Power (50+ –¥–µ–π—Å—Ç–≤–∏–π): ${segments.power_users || 0}</div>
            <div><span style="color:#4ade80">‚óè</span> Regular (10-49): ${segments.regular_users || 0}</div>
            <div><span style="color:#facc15">‚óè</span> Casual (1-9): ${segments.casual_users || 0}</div>
            <div><span style="color:#6b7280">‚óè</span> Dormant (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ): ${segments.dormant_users || 0}</div>
        </div>
    `;
}

function updateTopUsersTable(users) {
    const tbody = document.getElementById('topUsersTable');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = users.map((u, i) => {
        const userName = u.username ? `@${escapeHtml(u.username)}` : escapeHtml(u.first_name || u.user_id);
        const tgLink = u.username ? ` <a href="https://t.me/${escapeAttr(u.username)}" target="_blank" class="text-blue-400 hover:text-blue-300">üîó</a>` : '';
        const cost = u.llm_cost ? u.llm_cost.toFixed(2) + ' ‚ÇΩ' : '0 ‚ÇΩ';

        return `
            <tr class="clickable-row" onclick="showUserProfile('${escapeAttr(u.user_id)}')">
                <td class="px-4 py-3 text-sm text-slate-400">${i + 1}</td>
                <td class="px-4 py-3 text-sm">
                    <div class="font-mono text-blue-400">${escapeHtml(u.user_id)}</div>
                    <div class="text-xs text-slate-500">${userName}${tgLink}</div>
                </td>
                <td class="px-4 py-3 text-sm font-medium">${u.total_actions || 0}</td>
                <td class="px-4 py-3 text-sm">${u.events || 0}</td>
                <td class="px-4 py-3 text-sm">${u.messages || 0}</td>
                <td class="px-4 py-3 text-sm text-green-400">${cost}</td>
            </tr>
        `;
    }).join('');
}

// ============ LLM TAB ============

async function loadLLMTab() {
    try {
        const response = await fetch(`${API_V2}/llm/costs?days=${currentPeriod}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load LLM data');

        const data = await response.json();

        // Update cards
        const totalCost = data.totals?.cost_rub || 0;
        const totalTokens = data.totals?.tokens || 0;
        const totalRequests = data.totals?.requests || 0;
        const daysCount = data.daily_costs?.length || 1;

        document.getElementById('llmTotalCost').textContent = totalCost.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('llmTotalTokens').textContent = formatNumber(totalTokens);
        document.getElementById('llmTotalRequests').textContent = totalRequests;
        document.getElementById('llmAvgCostPerDay').textContent = (totalCost / daysCount).toFixed(2) + ' ‚ÇΩ';

        // Cost chart
        updateLLMCostChart(data.daily_costs || []);

        // Models chart - convert object to array
        const modelArray = Object.entries(data.by_model || {}).map(([model, info]) => ({
            model: model,
            cost: info.cost_rub || 0,
            tokens: info.tokens || 0,
            requests: info.requests || 0
        }));
        updateLLMModelsChart(modelArray);

        // Users table
        updateLLMUsersTable(data.by_user || []);

    } catch (err) {
        console.error('Failed to load LLM tab:', err);
    }
}

function updateLLMCostChart(data) {
    const ctx = document.getElementById('llmCostChart').getContext('2d');
    if (llmCostChart) llmCostChart.destroy();

    const labels = data.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const costs = data.map(d => d.cost_rub || 0);
    const tokens = data.map(d => d.tokens || 0);

    llmCostChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',
                data: costs,
                backgroundColor: '#4ade80',
                yAxisID: 'y'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#2a2a2a' } },
                x: { ticks: { color: '#888', maxRotation: 45 }, grid: { color: '#2a2a2a' } }
            }
        }
    });
}

function updateLLMModelsChart(data) {
    const ctx = document.getElementById('llmModelsChart').getContext('2d');
    if (llmModelsChart) llmModelsChart.destroy();

    const labels = data.map(d => d.model || 'unknown');
    const values = data.map(d => d.cost || 0);
    const colors = ['#60a5fa', '#a78bfa', '#22d3ee', '#fb923c'];

    llmModelsChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }
        }
    });
}

function updateLLMUsersTable(users) {
    const tbody = document.getElementById('llmUsersTable');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    // Sort by cost descending
    users.sort((a, b) => (b.cost_rub || 0) - (a.cost_rub || 0));

    tbody.innerHTML = users.slice(0, 15).map(u => {
        const userName = u.username ? `@${escapeHtml(u.username)}` : escapeHtml(u.first_name || u.user_id);
        return `
            <tr class="clickable-row" onclick="showUserProfile('${escapeAttr(u.user_id)}')">
                <td class="px-4 py-3 text-sm">
                    <div class="font-mono text-blue-400">${escapeHtml(u.user_id)}</div>
                    <div class="text-xs text-slate-500">${userName}</div>
                </td>
                <td class="px-4 py-3 text-sm">${u.requests || 0}</td>
                <td class="px-4 py-3 text-sm">${formatNumber(u.tokens || 0)}</td>
                <td class="px-4 py-3 text-sm text-green-400">${(u.cost_rub || 0).toFixed(2)} ‚ÇΩ</td>
            </tr>
        `;
    }).join('');
}

// ============ ERRORS TAB ============

async function loadErrorsTab() {
    try {
        // Load errors for the selected period
        const hours = currentPeriod * 24;
        const response = await fetch(`${API_BASE}/errors?hours=${hours}&limit=100`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load errors');

        const data = await response.json();

        // Update cards
        const total = data.stats?.total || 0;
        const byType = data.stats?.by_type || {};
        const llmErrors = (byType.llm_error || 0) + (byType.llm_parse_error || 0) + (byType.llm_timeout || 0);
        const todayCount = data.errors?.filter(e => {
            const d = new Date(e.timestamp);
            const today = new Date();
            return d.toDateString() === today.toDateString();
        }).length || 0;

        document.getElementById('errorsTotal').textContent = total;
        document.getElementById('errorsToday').textContent = todayCount;
        document.getElementById('errorsLLM').textContent = llmErrors;
        document.getElementById('errorsOther').textContent = total - llmErrors;

        // Group errors by day for chart
        const byDay = {};
        (data.errors || []).forEach(e => {
            const date = new Date(e.timestamp).toISOString().split('T')[0];
            byDay[date] = (byDay[date] || 0) + 1;
        });

        updateErrorsTimelineChart(byDay);
        updateErrorsTypesChart(byType);
        updateErrorsTable(data.errors || []);

    } catch (err) {
        console.error('Failed to load errors tab:', err);
    }
}

function updateErrorsTimelineChart(byDay) {
    const ctx = document.getElementById('errorsTimelineChart').getContext('2d');
    if (errorsTimelineChart) errorsTimelineChart.destroy();

    const sortedDates = Object.keys(byDay).sort();
    const labels = sortedDates.map(d => {
        const date = new Date(d);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const values = sortedDates.map(d => byDay[d]);

    errorsTimelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–û—à–∏–±–∫–∏',
                data: values,
                borderColor: '#f87171',
                backgroundColor: 'rgba(248, 113, 113, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#2a2a2a' } },
                x: { ticks: { color: '#888', maxRotation: 45 }, grid: { color: '#2a2a2a' } }
            }
        }
    });
}

function updateErrorsTypesChart(byType) {
    const ctx = document.getElementById('errorsTypesChart').getContext('2d');
    if (errorsTypesChart) errorsTypesChart.destroy();

    const labels = Object.keys(byType).map(k => actionLabels[k] || k);
    const values = Object.values(byType);
    const colors = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#22d3ee'];

    errorsTypesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }
        }
    });
}

function updateErrorsTable(errors) {
    const tbody = document.getElementById('errorsTable');
    if (!errors || errors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –æ—à–∏–±–æ–∫</td></tr>';
        return;
    }

    tbody.innerHTML = errors.slice(0, 50).map(e => {
        const time = new Date(e.timestamp).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const userName = e.username ? `@${escapeHtml(e.username)}` : escapeHtml(e.first_name || e.user_id);
        const rawErrorMsg = e.error_message ? e.error_message.substring(0, 80) + (e.error_message.length > 80 ? '...' : '') : e.details || '-';
        const errorMsg = escapeHtml(rawErrorMsg);

        return `
            <tr class="clickable-row text-red-300" onclick="showUserProfile('${escapeAttr(e.user_id)}')">
                <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                <td class="px-4 py-3 text-sm">
                    <div class="font-mono text-blue-400">${escapeHtml(e.user_id)}</div>
                    <div class="text-xs text-slate-500">${userName}</div>
                </td>
                <td class="px-4 py-3 text-sm">${escapeHtml(actionLabels[e.action_type] || e.action_type)}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${errorMsg}</td>
            </tr>
        `;
    }).join('');
}

// ============ HELPERS ============

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

function showDashboard() {
    currentView = 'main';
    showTab('overview');
}

// Broadcast functions
function toggleBroadcast() {
    const panel = document.getElementById('broadcastPanel');
    const toggle = document.getElementById('broadcastToggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº';
    }
}

function previewBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    const buttonText = document.getElementById('broadcastButtonText').value;
    const buttonAction = document.getElementById('broadcastButtonAction').value;

    if (!message.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }

    let preview = `<div class="bg-slate-900 p-4 rounded-lg">
        <div class="text-sm text-slate-400 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
        <div class="bg-slate-800 p-3 rounded">${message.replace(/\n/g, '<br>')}</div>`;

    if (buttonText && buttonAction) {
        preview += `<div class="mt-3"><span class="inline-block bg-blue-600 px-4 py-2 rounded text-sm">${buttonText}</span></div>`;
    }
    preview += '</div>';

    const resultEl = document.getElementById('broadcastResult');
    resultEl.innerHTML = preview;
    resultEl.className = 'p-4 rounded-lg';
    resultEl.classList.remove('hidden');
}

async function sendBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    const buttonText = document.getElementById('broadcastButtonText').value;
    const buttonAction = document.getElementById('broadcastButtonAction').value;
    const testOnly = document.getElementById('broadcastTestOnly').checked;

    if (!message.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }

    const confirmMsg = testOnly
        ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–µ–±–µ?'
        : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?';

    if (!confirm(confirmMsg)) return;

    const resultEl = document.getElementById('broadcastResult');
    resultEl.innerHTML = '<div class="text-yellow-400">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...</div>';
    resultEl.className = 'p-4 rounded-lg bg-slate-900';
    resultEl.classList.remove('hidden');

    try {
        const response = await fetch(`${API_BASE}/broadcast`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                message: message,
                button_text: buttonText || null,
                button_action: buttonAction || null,
                test_only: testOnly
            })
        });

        const data = await response.json();

        if (response.ok) {
            if (data.status === 'completed') {
                resultEl.innerHTML = `
                    <div class="text-green-400 font-medium">‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
                    <div class="text-sm text-slate-400 mt-2">
                        –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent} | –û—à–∏–±–æ–∫: ${data.failed} | –í—Å–µ–≥–æ: ${data.total}
                    </div>
                    ${data.failed_users?.length ? `<div class="text-xs text-red-400 mt-2">–û—à–∏–±–∫–∏: ${data.failed_users.map(u => u.user_id).join(', ')}</div>` : ''}
                `;
            } else if (data.status === 'fake_mode') {
                resultEl.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è Fake mode - —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>';
            } else {
                resultEl.innerHTML = `<div class="text-yellow-400">‚ö†Ô∏è ${data.status}</div>`;
            }
        } else {
            resultEl.innerHTML = `<div class="text-red-400">‚ùå –û—à–∏–±–∫–∞: ${data.detail || response.statusText}</div>`;
        }
    } catch (e) {
        resultEl.innerHTML = `<div class="text-red-400">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}</div>`;
    }
}

// Initialize translations on page load
function initTranslations() {
    // Set page title
    document.title = t('adminPanel') + ' - AI Calendar';

    // Login screen
    document.querySelector('h1').textContent = t('adminPanel');
    const labels = document.querySelectorAll('label');
    if (labels[0]) labels[0].textContent = t('firstPassword');
    if (labels[1]) labels[1].textContent = t('secondPassword');
    if (labels[2]) labels[2].textContent = t('thirdPassword');
    document.querySelector('button[type="submit"]').textContent = t('login');

    // Dashboard header
    document.querySelector('#dashboard button[onclick="logout()"]').textContent = t('logout');
    document.querySelector('#backBtn').textContent = t('back');

    // Stat cards
    const statCards = document.querySelectorAll('.stat-card .text-sm');
    if (statCards[0]) statCards[0].textContent = 'üë• ' + t('users');
    if (statCards[1]) statCards[1].textContent = 'üìÖ ' + t('events');
    if (statCards[2]) statCards[2].textContent = 'üí¨ ' + t('messages');
    if (statCards[3]) statCards[3].textContent = '‚ùå ' + t('errors');

    // Chart titles
    const chartTitles = document.querySelectorAll('.bg-slate-800 h3');
    if (chartTitles[0]) chartTitles[0].textContent = t('userActivity');
    if (chartTitles[1]) chartTitles[1].textContent = t('actionDistribution');
    if (chartTitles[2]) chartTitles[2].textContent = t('recentUsers');

    // Table headers - Recent Users (safe access)
    const usersTableEl = document.getElementById('usersTable');
    if (usersTableEl?.parentElement?.previousElementSibling) {
        const userTableHeaders = usersTableEl.parentElement.previousElementSibling.querySelectorAll('th');
        if (userTableHeaders[0]) userTableHeaders[0].textContent = t('userId');
        if (userTableHeaders[1]) userTableHeaders[1].textContent = t('events');
        if (userTableHeaders[2]) userTableHeaders[2].textContent = t('messages');
        if (userTableHeaders[3]) userTableHeaders[3].textContent = t('lastActivity');
    }

    // User details section
    const userDetailHeaders = document.querySelectorAll('#userView .text-sm.text-slate-400');
    if (userDetailHeaders[0]) userDetailHeaders[0].textContent = 'üìÖ ' + t('created');
    if (userDetailHeaders[1]) userDetailHeaders[1].textContent = 'üí¨ ' + t('text');
    if (userDetailHeaders[2]) userDetailHeaders[2].textContent = 'üé§ ' + t('voice');
    if (userDetailHeaders[3]) userDetailHeaders[3].textContent = '‚ùå ' + t('errors');
    if (userDetailHeaders[4]) userDetailHeaders[4].textContent = 'üìä ' + t('totalActions');

    // Actions history table headers (safe access)
    const actionsTableEl = document.getElementById('userActionsTable');
    if (actionsTableEl?.parentElement?.previousElementSibling) {
        const actionsHeaders = actionsTableEl.parentElement.previousElementSibling.querySelectorAll('th');
        if (actionsHeaders[0]) actionsHeaders[0].textContent = t('time');
        if (actionsHeaders[1]) actionsHeaders[1].textContent = t('action');
        if (actionsHeaders[2]) actionsHeaders[2].textContent = t('details');
        if (actionsHeaders[3]) actionsHeaders[3].textContent = t('status');
    }
}

// Run restore session FIRST, then translations
async function initPage() {
    // CRITICAL: Restore session first AND WAIT for it to complete
    await restoreSession();

    // Then try translations (with error handling so it doesn't break anything)
    try {
        initTranslations();
    } catch (e) {
        console.warn('[Admin] initTranslations error (non-critical):', e.message);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => initPage());
} else {
    initPage();
}
</script>

</body>
</html>
