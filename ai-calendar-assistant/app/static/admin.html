<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AI Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0;}
        .stat-card {background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; border-radius: 12px; padding: 20px; transition: all 0.2s; cursor: pointer;}
        .stat-card:hover {transform: translateY(-2px); border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);}
        .chart-wrapper {position: relative; height: 300px; width: 100%;}
        @media (max-width: 768px) {.chart-wrapper {height: 250px;}}
        .badge-test {background: #fbbf24; color: #78350f; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;}
        .clickable-row {cursor: pointer; transition: background 0.2s;}
        .clickable-row:hover {background: #1e293b !important;}
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md">
        <h1 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Admin Panel</h1>
        <form id="loginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password1" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password2" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="password3" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors">–í–æ–π—Ç–∏</button>
        </form>
        <div id="loginError" class="hidden mt-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-sm"></div>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl md:text-2xl font-bold">AI Calendar Admin</h1>
                <a href="/static/admin_report.html" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors">üìã User Report</a>
                <button onclick="showDashboard()" id="backBtn" class="hidden px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-7xl">

        <!-- Main Dashboard View -->
        <div id="mainView">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card" onclick="filterByType('users')">
                    <div class="text-3xl font-bold text-blue-400" id="totalUsers">0</div>
                    <div class="text-sm text-slate-400 mt-1">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('events')">
                    <div class="text-3xl font-bold text-green-400" id="totalEvents">0</div>
                    <div class="text-sm text-slate-400 mt-1">üìÖ –°–æ–±—ã—Ç–∏–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('messages')">
                    <div class="text-3xl font-bold text-purple-400" id="totalMessages">0</div>
                    <div class="text-sm text-slate-400 mt-1">üí¨ –°–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card" onclick="filterByType('errors')">
                    <div class="text-3xl font-bold text-red-400" id="totalErrors">0</div>
                    <div class="text-sm text-slate-400 mt-1">‚ùå –û—à–∏–±–æ–∫</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="chart-wrapper"><canvas id="activityChart"></canvas></div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
                    <h3 class="text-lg font-semibold mb-4">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π</h3>
                    <div class="chart-wrapper"><canvas id="distributionChart"></canvas></div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden mb-6">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–±—ã—Ç–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°–æ–æ–±—â–µ–Ω–∏—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody id="actionsTable" class="divide-y divide-slate-700">
                            <tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Broadcast Section -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden mt-6">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h3>
                    <button onclick="toggleBroadcast()" id="broadcastToggle" class="text-sm text-blue-400 hover:text-blue-300">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</button>
                </div>
                <div id="broadcastPanel" class="hidden p-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (HTML)</label>
                        <textarea id="broadcastMessage" rows="4" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="üîÑ <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞!</b>&#10;&#10;–ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" id="broadcastButtonText" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="üöÄ –û–±–Ω–æ–≤–∏—Ç—å">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–î–µ–π—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–∫–∏</label>
                            <select id="broadcastButtonAction" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">–ë–µ–∑ –∫–Ω–æ–ø–∫–∏</option>
                                <option value="start">–í—ã–∑–≤–∞—Ç—å /start</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="broadcastTestOnly" class="w-4 h-4 rounded bg-slate-900 border-slate-600 text-blue-500 focus:ring-blue-500">
                            <span class="text-sm">–¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–±–µ)</span>
                        </label>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="sendBroadcast()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                        <button onclick="previewBroadcast()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
                            üëÅ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </div>
                    <div id="broadcastResult" class="hidden p-4 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- User Profile View -->
        <div id="userView" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span id="userIdTitle" class="font-mono text-blue-400"></span></h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-400" id="userEventsCount">0</div>
                        <div class="text-sm text-slate-400">üìÖ –°–æ–±—ã—Ç–∏—è</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-400" id="userMessagesCount">0</div>
                        <div class="text-sm text-slate-400">üí¨ –¢–µ–∫—Å—Ç</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-400" id="userVoiceCount">0</div>
                        <div class="text-sm text-slate-400">üé§ –ì–æ–ª–æ—Å</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-red-400" id="userErrorsCount">0</div>
                        <div class="text-sm text-slate-400">‚ùå –û—à–∏–±–∫–∏</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-2xl font-bold text-yellow-400" id="userActionsCount">0</div>
                        <div class="text-sm text-slate-400">üìä –í—Å–µ–≥–æ</div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="p-4 border-b border-slate-700"><h3 class="text-lg font-semibold">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="userActionsTable" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Filtered View -->
        <div id="filteredView" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4" id="filterTitle"></h2>
                <div class="text-sm text-slate-400" id="filterSubtitle"></div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium">–í—Ä–µ–º—è</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">User ID</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium">–î–µ—Ç–∞–ª–∏</th>
                            </tr>
                        </thead>
                        <tbody id="filteredTable" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const API_BASE = '/api/admin';
const STORAGE_KEY = 'admin_session_token';
let sessionToken = null;
let activityChart = null;
let distributionChart = null;
let refreshInterval = null;
let currentView = 'main';
let allActions = [];
let errorsData = { errors: [], stats: { total: 0, by_type: {} } };

// Restore session from localStorage on page load
async function restoreSession() {
    console.log('[Admin] restoreSession() called');
    const savedToken = localStorage.getItem(STORAGE_KEY);
    console.log('[Admin] Saved token exists:', !!savedToken);

    if (savedToken) {
        try {
            console.log('[Admin] Validating token with /api/admin/stats...');
            const statsResponse = await fetch(`${API_BASE}/stats`, {
                headers: {'Authorization': `Bearer ${savedToken}`}
            });
            console.log('[Admin] Stats response status:', statsResponse.status);

            if (statsResponse.ok) {
                console.log('[Admin] Token valid! Restoring session...');
                sessionToken = savedToken;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadDashboard();
                refreshInterval = setInterval(() => { if (currentView === 'main') loadDashboard(); }, 30000);
            } else {
                console.log('[Admin] Token invalid (status ' + statsResponse.status + '), clearing...');
                localStorage.removeItem(STORAGE_KEY);
            }
        } catch (e) {
            console.error('[Admin] Error validating token:', e);
            localStorage.removeItem(STORAGE_KEY);
        }
    } else {
        console.log('[Admin] No saved token, showing login form');
    }
}

// Save session to localStorage
function saveSession(token) {
    console.log('[Admin] saveSession() - saving token');
    sessionToken = token;
    localStorage.setItem(STORAGE_KEY, token);
}

// Clear session from localStorage
function clearSession() {
    console.log('[Admin] clearSession() - removing token');
    sessionToken = null;
    localStorage.removeItem(STORAGE_KEY);
}

// Get language from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const userLang = urlParams.get('lang') || 'ru';

// Translations object
const translations = {
    ru: {
        adminPanel: 'Admin Panel',
        firstPassword: '–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å',
        secondPassword: '–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å',
        thirdPassword: '–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–æ–ª—å',
        login: '–í–æ–π—Ç–∏',
        logout: '–í—ã–π—Ç–∏',
        back: '‚Üê –ù–∞–∑–∞–¥',
        users: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        events: '–°–æ–±—ã—Ç–∏–π',
        messages: '–°–æ–æ–±—â–µ–Ω–∏–π',
        errors: '–û—à–∏–±–æ–∫',
        userActivity: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        actionDistribution: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π',
        recentUsers: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        userId: 'User ID',
        lastActivity: '–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        userDetails: '–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        created: '–°–æ–∑–¥–∞–Ω',
        totalActions: '–í—Å–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π',
        text: '–¢–µ–∫—Å—Ç',
        voice: '–ì–æ–ª–æ—Å',
        actionsHistory: '–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π',
        time: '–í—Ä–µ–º—è',
        action: '–î–µ–π—Å—Ç–≤–∏–µ',
        details: '–î–µ—Ç–∞–ª–∏',
        status: '–°—Ç–∞—Ç—É—Å',
        invalidPassword: '–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–æ–ª–∏',
        connectionError: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º'
    },
    en: {
        adminPanel: 'Admin Panel',
        firstPassword: 'First Password',
        secondPassword: 'Second Password',
        thirdPassword: 'Third Password',
        login: 'Login',
        logout: 'Logout',
        back: '‚Üê Back',
        users: 'Users',
        events: 'Events',
        messages: 'Messages',
        errors: 'Errors',
        userActivity: 'User Activity',
        actionDistribution: 'Action Distribution',
        recentUsers: 'Recent Users',
        userId: 'User ID',
        lastActivity: 'Last Activity',
        loading: 'Loading...',
        userDetails: 'User Details',
        created: 'Created',
        totalActions: 'Total Actions',
        text: 'Text',
        voice: 'Voice',
        actionsHistory: 'Actions History',
        time: 'Time',
        action: 'Action',
        details: 'Details',
        status: 'Status',
        invalidPassword: 'Invalid passwords',
        connectionError: 'Server connection error'
    },
    es: {
        adminPanel: 'Panel de Administraci√≥n',
        firstPassword: 'Primera Contrase√±a',
        secondPassword: 'Segunda Contrase√±a',
        login: 'Ingresar',
        logout: 'Salir',
        back: '‚Üê Atr√°s',
        users: 'Usuarios',
        events: 'Eventos',
        messages: 'Mensajes',
        errors: 'Errores',
        userActivity: 'Actividad de Usuarios',
        actionDistribution: 'Distribuci√≥n de Acciones',
        recentUsers: 'Usuarios Recientes',
        userId: 'ID de Usuario',
        lastActivity: '√öltima Actividad',
        loading: 'Cargando...',
        userDetails: 'Detalles del Usuario',
        created: 'Creado',
        totalActions: 'Acciones Totales',
        text: 'Texto',
        voice: 'Voz',
        actionsHistory: 'Historial de Acciones',
        time: 'Hora',
        action: 'Acci√≥n',
        details: 'Detalles',
        status: 'Estado',
        invalidPassword: 'Contrase√±as inv√°lidas',
        connectionError: 'Error de conexi√≥n con el servidor'
    },
    ar: {
        adminPanel: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
        firstPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ£ŸàŸÑŸâ',
        secondPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ´ÿßŸÜŸäÿ©',
        login: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
        logout: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
        back: '‚Üí ÿ±ÿ¨Ÿàÿπ',
        users: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ',
        events: 'ÿßŸÑÿ£ÿ≠ÿØÿßÿ´',
        messages: 'ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ',
        errors: 'ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°',
        userActivity: 'ŸÜÿ¥ÿßÿ∑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ',
        actionDistribution: 'ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        recentUsers: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑÿ£ÿÆŸäÿ±ŸàŸÜ',
        userId: 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        lastActivity: 'ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑',
        loading: 'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',
        userDetails: 'ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        created: 'ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°',
        totalActions: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        text: 'ŸÜÿµ',
        voice: 'ÿµŸàÿ™',
        actionsHistory: 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
        time: 'ÿßŸÑŸàŸÇÿ™',
        action: 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°',
        details: 'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ',
        status: 'ÿßŸÑÿ≠ÿßŸÑÿ©',
        invalidPassword: 'ŸÉŸÑŸÖÿßÿ™ ŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©',
        connectionError: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ'
    }
};

// Translation helper function
function t(key) {
    return translations[userLang]?.[key] || translations['ru'][key] || key;
}

const actionLabels = {
    'user_start': 'üöÄ ' + t('text'),
    'event_create': '‚ûï ' + (userLang === 'ru' ? '–°–æ–∑–¥–∞–Ω–∏–µ' : userLang === 'en' ? 'Create' : userLang === 'es' ? 'Crear' : 'ÿ•ŸÜÿ¥ÿßÿ°'),
    'event_update': '‚úèÔ∏è ' + (userLang === 'ru' ? '–ò–∑–º–µ–Ω–µ–Ω–∏–µ' : userLang === 'en' ? 'Update' : userLang === 'es' ? 'Actualizar' : 'ÿ™ÿ≠ÿØŸäÿ´'),
    'event_delete': 'üóëÔ∏è ' + (userLang === 'ru' ? '–£–¥–∞–ª–µ–Ω–∏–µ' : userLang === 'en' ? 'Delete' : userLang === 'es' ? 'Eliminar' : 'ÿ≠ÿ∞ŸÅ'),
    'event_query': 'üîç ' + (userLang === 'ru' ? '–ü–æ–∏—Å–∫' : userLang === 'en' ? 'Search' : userLang === 'es' ? 'Buscar' : 'ÿ®ÿ≠ÿ´'),
    'text_message': 'üí¨ ' + t('messages'),
    'voice_message': 'üé§ ' + t('voice'),
    'error': '‚ùå ' + (userLang === 'ru' ? '–û—à–∏–±–∫–∞' : userLang === 'en' ? 'Error' : userLang === 'es' ? 'Error' : 'ÿÆÿ∑ÿ£'),
    // Error types for detailed tracking
    'llm_error': 'ü§ñ‚ùå LLM API',
    'llm_parse_error': 'üìù‚ùå JSON Parse',
    'llm_timeout': '‚è±Ô∏è‚ùå Timeout',
    'calendar_error': 'üìÖ‚ùå Calendar',
    'stt_error': 'üé§‚ùå STT',
    'intent_unclear': '‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ'
};

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const password1 = document.getElementById('password1').value;
    const password2 = document.getElementById('password2').value;
    const password3 = document.getElementById('password3')?.value || '';

    try {
        const response = await fetch(`${API_BASE}/verify`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password1: password1, password2: password2, password3: password3})
        });

        const data = await response.json();
        if (response.ok && data.valid) {
            saveSession(data.token);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboard();
            refreshInterval = setInterval(() => { if (currentView === 'main') loadDashboard(); }, 30000);
        } else {
            showError(data.detail || t('invalidPassword'));
        }
    } catch (err) {
        showError(t('connectionError'));
    }
});

function showError(message) {
    const errorEl = document.getElementById('loginError');
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
}

function logout() {
    clearSession();
    if (refreshInterval) clearInterval(refreshInterval);
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('password1').value = '';
    document.getElementById('password2').value = '';
    document.getElementById('password3').value = '';
}

async function fetchAPI(endpoint) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            headers: {'Authorization': `Bearer ${sessionToken}`}
        });
        if (!response.ok) {
            if (response.status === 401) {
                // Token expired or invalid - clear session and redirect to login
                clearSession();
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                if (refreshInterval) clearInterval(refreshInterval);
            }
            throw new Error(`API error: ${response.status}`);
        }
        return response.json();
    } catch (e) {
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
            // Network error - server unreachable
            console.error('[Admin] Network error:', e.message);
            throw new Error(t('connectionError'));
        }
        throw e;
    }
}

async function loadDashboard() {
    try {
        // Use correct API endpoints that match admin.py
        const stats = await fetchAPI('/stats');
        document.getElementById('totalUsers').textContent = stats.total_users;
        document.getElementById('totalEvents').textContent = stats.total_events_created;
        document.getElementById('totalMessages').textContent = stats.total_messages;

        // Load errors from new endpoint
        let errorsCount = 0;
        try {
            errorsData = await fetchAPI('/errors?hours=24&limit=100');
            errorsCount = errorsData.stats?.total || 0;
        } catch (e) {
            console.log('Errors endpoint not available:', e);
            errorsData = { errors: [], stats: { total: 0, by_type: {} } };
        }
        document.getElementById('totalErrors').textContent = errorsCount;

        // Timeline - use new endpoint
        try {
            const timeline = await fetchAPI('/timeline?hours=24');
            updateActivityChart(timeline);
        } catch (e) {
            console.log('Timeline not available:', e);
            updateActivityChart([]);
        }

        // Users list
        const users = await fetchAPI('/users');
        updateUsersTable(users.slice(0, 10));

        // Actions - use new endpoint
        try {
            allActions = await fetchAPI('/actions?limit=200');
            updateActionsTable(allActions.slice(0, 10));
        } catch (e) {
            console.log('Actions not available:', e);
            allActions = [];
            updateActionsTable([]);
        }

        // Distribution chart with available data (including errors)
        updateDistributionChart({
            total_events: stats.total_events_created,
            total_messages: stats.total_messages,
            total_errors: errorsCount
        });
    } catch (err) {
        console.error('Failed to load dashboard:', err);
    }
}

function updateActivityChart(data) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    if (activityChart) activityChart.destroy();

    const maxPoints = 24;
    const labels = data.slice(-maxPoints).map(d => new Date(d.timestamp).getHours() + ':00');
    const values = data.slice(-maxPoints).map(d => d.value);

    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–î–µ–π—Å—Ç–≤–∏—è',
                data: values,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {display: false}},
            scales: {
                y: {beginAtZero: true, ticks: {color: '#94a3b8'}, grid: {color: '#334155'}},
                x: {ticks: {color: '#94a3b8'}, grid: {color: '#334155'}}
            }
        }
    });
}

function updateDistributionChart(stats) {
    const ctx = document.getElementById('distributionChart').getContext('2d');
    if (distributionChart) distributionChart.destroy();

    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['–°–æ–±—ã—Ç–∏—è', '–°–æ–æ–±—â–µ–Ω–∏—è', '–û—à–∏–±–∫–∏'],
            datasets: [{
                data: [stats.total_events, stats.total_messages, stats.total_errors],
                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(168, 85, 247, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {legend: {position: 'bottom', labels: {color: '#e2e8f0'}}}
        }
    });
}

function updateUsersTable(users) {
    const tbody = document.getElementById('usersTable');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(u => {
        const lastSeen = u.last_seen ? new Date(u.last_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        }) : '-';

        // Build user display name and Telegram link
        let userName = u.user_id;
        let tgLink = '';
        if (u.username) {
            userName = `@${u.username}`;
            tgLink = ` <a href="https://t.me/${u.username}" target="_blank" class="text-blue-400 hover:text-blue-300">üîó</a>`;
        } else if (u.first_name || u.last_name) {
            userName = [u.first_name, u.last_name].filter(Boolean).join(' ');
        }

        const userDisplay = `<div class="font-mono text-blue-400">${u.user_id}</div>
                             <div class="text-xs text-slate-500">${userName}${tgLink}</div>`;

        // Use fields from UserDetail model
        const totalEvents = u.total_actions || 0;
        const totalMessages = u.actions_today || 0;

        return `
            <tr class="clickable-row" onclick="showUserProfile('${u.user_id}')">
                <td class="px-4 py-3 text-sm">${userDisplay}</td>
                <td class="px-4 py-3 text-sm">${totalEvents}</td>
                <td class="px-4 py-3 text-sm">${totalMessages}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${lastSeen}</td>
            </tr>
        `;
    }).join('');
}

function updateActionsTable(actions) {
    const tbody = document.getElementById('actionsTable');
    if (actions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = actions.map(a => {
        const time = new Date(a.timestamp).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const details = (a.details || '').substring(0, 50) + (a.details?.length > 50 ? '...' : '');
        const testBadge = a.is_test ? '<span class="badge-test ml-2">–¢–ï–°–¢</span>' : '';
        return `
            <tr class="clickable-row" onclick="showUserProfile('${a.user_id}')">
                <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                <td class="px-4 py-3 text-sm font-mono text-blue-400">${a.user_id}</td>
                <td class="px-4 py-3 text-sm">${actionLabels[a.action_type] || a.action_type}${testBadge}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${details}</td>
            </tr>
        `;
    }).join('');
}

async function showUserProfile(userId) {
    currentView = 'user';
    document.getElementById('mainView').classList.add('hidden');
    document.getElementById('userView').classList.remove('hidden');
    document.getElementById('filteredView').classList.add('hidden');
    document.getElementById('backBtn').classList.remove('hidden');

    document.getElementById('userIdTitle').textContent = userId;

    try {
        // Use correct endpoint: /users/{id}/dialog
        const actions = await fetchAPI(`/users/${userId}/dialog?limit=500`);

        const events = actions.filter(a => ['event_create', 'event_update', 'event_delete'].includes(a.action_type)).length;
        const messages = actions.filter(a => a.action_type === 'text_message').length;
        const voice = actions.filter(a => a.action_type === 'voice_message').length;
        const errors = actions.filter(a => a.action_type === 'error').length;

        document.getElementById('userEventsCount').textContent = events;
        document.getElementById('userMessagesCount').textContent = messages;
        document.getElementById('userVoiceCount').textContent = voice;
        document.getElementById('userErrorsCount').textContent = errors;
        document.getElementById('userActionsCount').textContent = actions.length;

        const tbody = document.getElementById('userActionsTable');
        tbody.innerHTML = actions.map(a => {
            const time = new Date(a.timestamp).toLocaleString('ru-RU', {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            const testBadge = a.is_test ? ' <span class="badge-test">–¢–ï–°–¢</span>' : '';
            const statusIcon = a.success ? '‚úÖ' : '‚ùå';
            return `
                <tr class="hover:bg-slate-900/50">
                    <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                    <td class="px-4 py-3 text-sm">${actionLabels[a.action_type] || a.action_type}${testBadge}</td>
                    <td class="px-4 py-3 text-sm text-slate-400">${a.details || '-'}</td>
                    <td class="px-4 py-3 text-sm text-center">${statusIcon}</td>
                </tr>
            `;
        }).join('');
    } catch (err) {
        console.error('Failed to load user profile:', err);
    }
}

async function filterByType(type) {
    currentView = 'filter';
    document.getElementById('mainView').classList.add('hidden');
    document.getElementById('userView').classList.add('hidden');
    document.getElementById('filteredView').classList.remove('hidden');
    document.getElementById('backBtn').classList.remove('hidden');

    let filtered = [];
    let title = '';
    let subtitle = '';

    if (type === 'events') {
        title = 'üìÖ –í—Å–µ —Å–æ–±—ã—Ç–∏—è';
        filtered = allActions.filter(a => ['event_create', 'event_update', 'event_delete'].includes(a.action_type));
        subtitle = `–°–æ–∑–¥–∞–Ω–æ: ${filtered.filter(a => a.action_type === 'event_create').length}, –ò–∑–º–µ–Ω–µ–Ω–æ: ${filtered.filter(a => a.action_type === 'event_update').length}, –£–¥–∞–ª–µ–Ω–æ: ${filtered.filter(a => a.action_type === 'event_delete').length}`;
    } else if (type === 'messages') {
        title = 'üí¨ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
        filtered = allActions.filter(a => ['text_message', 'voice_message'].includes(a.action_type));
        subtitle = `–¢–µ–∫—Å—Ç–æ–≤—ã—Ö: ${filtered.filter(a => a.action_type === 'text_message').length}, –ì–æ–ª–æ—Å–æ–≤—ã—Ö: ${filtered.filter(a => a.action_type === 'voice_message').length}`;
    } else if (type === 'errors') {
        title = '‚ùå –û—à–∏–±–∫–∏ –∑–∞ 24 —á–∞—Å–∞';
        // Use errors from dedicated endpoint
        if (errorsData.errors && errorsData.errors.length > 0) {
            // Build subtitle with error breakdown
            const byType = errorsData.stats?.by_type || {};
            const typeBreakdown = Object.entries(byType)
                .map(([type, count]) => `${actionLabels[type] || type}: ${count}`)
                .join(', ');
            subtitle = `–í—Å–µ–≥–æ: ${errorsData.stats?.total || 0}` + (typeBreakdown ? ` | ${typeBreakdown}` : '');

            // Show errors table
            const tbody = document.getElementById('filteredTable');
            tbody.innerHTML = errorsData.errors.map(e => {
                const time = new Date(e.timestamp).toLocaleString('ru-RU', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const userName = e.username ? `@${e.username}` : (e.first_name || e.user_id);
                const errorMsg = e.error_message ? `<div class="text-xs text-red-400 mt-1">${e.error_message.substring(0, 100)}${e.error_message.length > 100 ? '...' : ''}</div>` : '';
                return `
                    <tr class="clickable-row text-red-300" onclick="showUserProfile('${e.user_id}')">
                        <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-mono text-blue-400">${e.user_id}</div>
                            <div class="text-xs text-slate-500">${userName}</div>
                        </td>
                        <td class="px-4 py-3 text-sm">${actionLabels[e.action_type] || e.action_type}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="text-slate-400">${e.details || '-'}</div>
                            ${errorMsg}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('filterTitle').textContent = title;
            document.getElementById('filterSubtitle').textContent = subtitle;
            return;
        } else {
            // Fallback to allActions if errors endpoint not available
            filtered = allActions.filter(a => a.action_type === 'error' || !a.success);
            subtitle = `–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${filtered.length}`;
        }
    } else if (type === 'users') {
        try {
            const users = await fetchAPI('/users');
            showUsersDetailed(users);
            return;
        } catch (err) {
            console.error('Failed to load users:', err);
            return;
        }
    }

    document.getElementById('filterTitle').textContent = title;
    document.getElementById('filterSubtitle').textContent = subtitle;

    const tbody = document.getElementById('filteredTable');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(a => {
        const time = new Date(a.timestamp).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const testBadge = a.is_test ? ' <span class="badge-test">–¢–ï–°–¢</span>' : '';
        const errorClass = (a.action_type === 'error' || !a.success) ? 'text-red-400' : '';
        return `
            <tr class="clickable-row ${errorClass}" onclick="showUserProfile('${a.user_id}')">
                <td class="px-4 py-3 text-sm text-slate-400">${time}</td>
                <td class="px-4 py-3 text-sm font-mono text-blue-400">${a.user_id}</td>
                <td class="px-4 py-3 text-sm">${actionLabels[a.action_type] || a.action_type}${testBadge}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${a.details || '-'}</td>
            </tr>
        `;
    }).join('');
}

function showUsersDetailed(users) {
    document.getElementById('filterTitle').textContent = 'üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
    document.getElementById('filterSubtitle').textContent = `–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`;
    
    const tbody = document.getElementById('filteredTable');
    tbody.innerHTML = users.map(u => {
        const firstSeen = new Date(u.first_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric'
        });
        const lastSeen = new Date(u.last_seen).toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        
        // Build user name
        let userName = u.user_id;
        let tgLink = '';
        if (u.username) {
            userName = `@${u.username}`;
            tgLink = ` <a href="https://t.me/${u.username}" target="_blank" class="text-blue-400 hover:text-blue-300">üîó</a>`;
        } else if (u.first_name || u.last_name) {
            userName = [u.first_name, u.last_name].filter(Boolean).join(' ');
        }
        
        const userDisplay = `<div class="font-mono text-blue-400">${u.user_id}</div>
                             <div class="text-xs text-slate-500">${userName}${tgLink}</div>`;
        
        return `
            <tr class="clickable-row" onclick="showUserProfile('${u.user_id}')">
                <td class="px-4 py-3 text-sm">${firstSeen}</td>
                <td class="px-4 py-3 text-sm">${userDisplay}</td>
                <td class="px-4 py-3 text-sm">–°–æ–±—ã—Ç–∏—è: ${u.total_events}, –°–æ–æ–±—â–µ–Ω–∏—è: ${u.total_messages}, –û—à–∏–±–∫–∏: ${u.total_errors}</td>
                <td class="px-4 py-3 text-sm text-slate-400">${lastSeen}</td>
            </tr>
        `;
    }).join('');
}

function showDashboard() {
    currentView = 'main';
    document.getElementById('mainView').classList.remove('hidden');
    document.getElementById('userView').classList.add('hidden');
    document.getElementById('filteredView').classList.add('hidden');
    document.getElementById('backBtn').classList.add('hidden');
    loadDashboard();
}

// Broadcast functions
function toggleBroadcast() {
    const panel = document.getElementById('broadcastPanel');
    const toggle = document.getElementById('broadcastToggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº';
    }
}

function previewBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    const buttonText = document.getElementById('broadcastButtonText').value;
    const buttonAction = document.getElementById('broadcastButtonAction').value;

    if (!message.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }

    let preview = `<div class="bg-slate-900 p-4 rounded-lg">
        <div class="text-sm text-slate-400 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
        <div class="bg-slate-800 p-3 rounded">${message.replace(/\n/g, '<br>')}</div>`;

    if (buttonText && buttonAction) {
        preview += `<div class="mt-3"><span class="inline-block bg-blue-600 px-4 py-2 rounded text-sm">${buttonText}</span></div>`;
    }
    preview += '</div>';

    const resultEl = document.getElementById('broadcastResult');
    resultEl.innerHTML = preview;
    resultEl.className = 'p-4 rounded-lg';
    resultEl.classList.remove('hidden');
}

async function sendBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    const buttonText = document.getElementById('broadcastButtonText').value;
    const buttonAction = document.getElementById('broadcastButtonAction').value;
    const testOnly = document.getElementById('broadcastTestOnly').checked;

    if (!message.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }

    const confirmMsg = testOnly
        ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–µ–±–µ?'
        : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?';

    if (!confirm(confirmMsg)) return;

    const resultEl = document.getElementById('broadcastResult');
    resultEl.innerHTML = '<div class="text-yellow-400">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...</div>';
    resultEl.className = 'p-4 rounded-lg bg-slate-900';
    resultEl.classList.remove('hidden');

    try {
        const response = await fetch(`${API_BASE}/broadcast`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({
                message: message,
                button_text: buttonText || null,
                button_action: buttonAction || null,
                test_only: testOnly
            })
        });

        const data = await response.json();

        if (response.ok) {
            if (data.status === 'completed') {
                resultEl.innerHTML = `
                    <div class="text-green-400 font-medium">‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
                    <div class="text-sm text-slate-400 mt-2">
                        –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent} | –û—à–∏–±–æ–∫: ${data.failed} | –í—Å–µ–≥–æ: ${data.total}
                    </div>
                    ${data.failed_users?.length ? `<div class="text-xs text-red-400 mt-2">–û—à–∏–±–∫–∏: ${data.failed_users.map(u => u.user_id).join(', ')}</div>` : ''}
                `;
            } else if (data.status === 'fake_mode') {
                resultEl.innerHTML = '<div class="text-yellow-400">‚ö†Ô∏è Fake mode - —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>';
            } else {
                resultEl.innerHTML = `<div class="text-yellow-400">‚ö†Ô∏è ${data.status}</div>`;
            }
        } else {
            resultEl.innerHTML = `<div class="text-red-400">‚ùå –û—à–∏–±–∫–∞: ${data.detail || response.statusText}</div>`;
        }
    } catch (e) {
        resultEl.innerHTML = `<div class="text-red-400">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}</div>`;
    }
}

// Initialize translations on page load
function initTranslations() {
    // Set page title
    document.title = t('adminPanel') + ' - AI Calendar';

    // Login screen
    document.querySelector('h1').textContent = t('adminPanel');
    const labels = document.querySelectorAll('label');
    if (labels[0]) labels[0].textContent = t('firstPassword');
    if (labels[1]) labels[1].textContent = t('secondPassword');
    if (labels[2]) labels[2].textContent = t('thirdPassword');
    document.querySelector('button[type="submit"]').textContent = t('login');

    // Dashboard header
    document.querySelector('#dashboard button[onclick="logout()"]').textContent = t('logout');
    document.querySelector('#backBtn').textContent = t('back');

    // Stat cards
    const statCards = document.querySelectorAll('.stat-card .text-sm');
    if (statCards[0]) statCards[0].textContent = 'üë• ' + t('users');
    if (statCards[1]) statCards[1].textContent = 'üìÖ ' + t('events');
    if (statCards[2]) statCards[2].textContent = 'üí¨ ' + t('messages');
    if (statCards[3]) statCards[3].textContent = '‚ùå ' + t('errors');

    // Chart titles
    const chartTitles = document.querySelectorAll('.bg-slate-800 h3');
    if (chartTitles[0]) chartTitles[0].textContent = t('userActivity');
    if (chartTitles[1]) chartTitles[1].textContent = t('actionDistribution');
    if (chartTitles[2]) chartTitles[2].textContent = t('recentUsers');

    // Table headers - Recent Users (safe access)
    const usersTableEl = document.getElementById('usersTable');
    if (usersTableEl?.parentElement?.previousElementSibling) {
        const userTableHeaders = usersTableEl.parentElement.previousElementSibling.querySelectorAll('th');
        if (userTableHeaders[0]) userTableHeaders[0].textContent = t('userId');
        if (userTableHeaders[1]) userTableHeaders[1].textContent = t('events');
        if (userTableHeaders[2]) userTableHeaders[2].textContent = t('messages');
        if (userTableHeaders[3]) userTableHeaders[3].textContent = t('lastActivity');
    }

    // User details section
    const userDetailHeaders = document.querySelectorAll('#userView .text-sm.text-slate-400');
    if (userDetailHeaders[0]) userDetailHeaders[0].textContent = 'üìÖ ' + t('created');
    if (userDetailHeaders[1]) userDetailHeaders[1].textContent = 'üí¨ ' + t('text');
    if (userDetailHeaders[2]) userDetailHeaders[2].textContent = 'üé§ ' + t('voice');
    if (userDetailHeaders[3]) userDetailHeaders[3].textContent = '‚ùå ' + t('errors');
    if (userDetailHeaders[4]) userDetailHeaders[4].textContent = 'üìä ' + t('totalActions');

    // Actions history table headers (safe access)
    const actionsTableEl = document.getElementById('userActionsTable');
    if (actionsTableEl?.parentElement?.previousElementSibling) {
        const actionsHeaders = actionsTableEl.parentElement.previousElementSibling.querySelectorAll('th');
        if (actionsHeaders[0]) actionsHeaders[0].textContent = t('time');
        if (actionsHeaders[1]) actionsHeaders[1].textContent = t('action');
        if (actionsHeaders[2]) actionsHeaders[2].textContent = t('details');
        if (actionsHeaders[3]) actionsHeaders[3].textContent = t('status');
    }
}

// Run restore session FIRST, then translations
async function initPage() {
    // CRITICAL: Restore session first AND WAIT for it to complete
    await restoreSession();

    // Then try translations (with error handling so it doesn't break anything)
    try {
        initTranslations();
    } catch (e) {
        console.warn('[Admin] initTranslations error (non-critical):', e.message);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => initPage());
} else {
    initPage();
}
</script>

</body>
</html>
