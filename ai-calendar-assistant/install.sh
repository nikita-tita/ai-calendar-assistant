#!/bin/bash

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° AI Calendar Bot Ð½Ð° VPS
# ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°: Ubuntu 20.04/22.04

set -e

echo "ðŸ¤– AI Calendar Bot - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð° VPS"
echo "======================================"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root Ð¿Ñ€Ð°Ð²
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root: sudo bash install.sh"
    exit 1
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt-get update -qq
apt-get upgrade -y -qq

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker
if ! command -v docker &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    systemctl enable docker
    systemctl start docker
else
    echo "âœ… Docker ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose..."
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
else
    echo "âœ… Docker Compose ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Git
if ! command -v git &> /dev/null; then
    echo "ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Git..."
    apt-get install -y git
else
    echo "âœ… Git ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
echo "ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð±Ð¾Ñ‚Ð°..."
cd /root
if [ -d "ai-calendar-assistant" ]; then
    echo "ðŸ“‚ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
    cd ai-calendar-assistant
    git pull
else
    git clone https://github.com/nikita-tita/ai-calendar-bot.git ai-calendar-assistant
    cd ai-calendar-assistant
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
echo ""
echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ"
echo "===================================="
echo ""

# Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð¾ÐºÐµÐ½Ð° Telegram
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ TELEGRAM_BOT_TOKEN: " TELEGRAM_BOT_TOKEN
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "âŒ Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
    exit 1
fi

# Ð—Ð°Ð¿Ñ€Ð¾Ñ OpenAI API ÐºÐ»ÑŽÑ‡Ð°
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ OPENAI_API_KEY: " OPENAI_API_KEY
if [ -z "$OPENAI_API_KEY" ]; then
    echo "âŒ API ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
    exit 1
fi

# Ð—Ð°Ð¿Ñ€Ð¾Ñ Radicale URL
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ RADICALE_URL [https://calendar-bot-production-e1ac.up.railway.app]: " RADICALE_URL
RADICALE_URL=${RADICALE_URL:-https://calendar-bot-production-e1ac.up.railway.app}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env
cat > .env << EOF
# Telegram Bot
TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN

# OpenAI
OPENAI_API_KEY=$OPENAI_API_KEY

# Calendar Service
RADICALE_URL=$RADICALE_URL

# Environment
ENVIRONMENT=production
LOG_LEVEL=INFO
EOF

echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ docker-compose.production.yml
cat > docker-compose.production.yml << 'EOF'
version: '3.8'

services:
  telegram-bot:
    container_name: telegram-bot
    build:
      context: .
      dockerfile: Dockerfile.bot
    env_file:
      - .env
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
EOF

echo "âœ… Docker Compose ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
echo ""
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
docker-compose -f docker-compose.production.yml down
docker-compose -f docker-compose.production.yml up -d --build

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°..."
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
if docker ps | grep -q telegram-bot; then
    echo ""
    echo "âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
    echo ""
    echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:"
    docker ps | grep telegram-bot
    echo ""
    echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
    echo "  Ð›Ð¾Ð³Ð¸:        docker logs -f telegram-bot"
    echo "  ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº:  docker restart telegram-bot"
    echo "  ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:   docker stop telegram-bot"
    echo "  Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:      docker ps"
    echo ""
    echo "ðŸŽ‰ Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ 24/7!"
else
    echo ""
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°!"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: docker logs telegram-bot"
    exit 1
fi
