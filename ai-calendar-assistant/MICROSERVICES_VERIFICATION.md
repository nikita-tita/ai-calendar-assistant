# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ - –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û

**–î–∞—Ç–∞:** 2025-10-28
**–ó–∞–ø—Ä–æ—Å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞ –∏ AI –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏

---

## –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: ‚úÖ –î–ê, –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ó–î–ï–õ–ï–ù–û

–í—Å–µ —á—Ç–æ –∏—Ö —Å–≤—è–∑—ã–≤–∞–µ—Ç - —ç—Ç–æ **—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ telegram_handler.py**, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ **—Ä–æ—É—Ç–µ—Ä** –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø—É–Ω–∫—Ç–∞–º

### ‚úÖ 1. AI –∞–≥–µ–Ω—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–¥–µ–ª–µ–Ω—ã

| –ö–∞–ª–µ–Ω–¥–∞—Ä—å | –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å |
|-----------|--------------|
| `llm_agent_yandex.py` | `llm_agent_property.py` |
| –ü—Ä–æ–º–ø—Ç: "calendar assistant" | –ü—Ä–æ–º–ø—Ç: "property search agent" |
| –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä |
| **–ù–ï –∑–Ω–∞–µ—Ç –æ Property** | **–ù–ï –∑–Ω–∞–µ—Ç –æ Calendar** |

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
$ grep -r "property" app/services/llm_agent_yandex.py
‚Üí –ü–£–°–¢–û ‚úÖ

$ grep -r "calendar\|radicale" app/services/property/llm_agent_property.py
‚Üí –ü–£–°–¢–û ‚úÖ
```

### ‚úÖ 2. –ë—ç–∫–µ–Ω–¥—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã

| –ö–∞–ª–µ–Ω–¥–∞—Ä—å | –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å |
|-----------|--------------|
| `calendar_radicale.py` | `property_service.py` |
| `daily_reminders.py` | `property_scoring.py` |
| `event_reminders.py` | `property_handler.py` |
| **–ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç Property** | **–ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç Calendar** |

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
$ grep -r "from app.services.property" app/services/*.py | grep -v telegram_handler
‚Üí –ü–£–°–¢–û ‚úÖ

$ grep -r "from app.services.calendar" app/services/property/
‚Üí –ü–£–°–¢–û ‚úÖ
```

### ‚úÖ 3. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–Ω—ã–µ

**–ö–∞–ª–µ–Ω–¥–∞—Ä—å:**
- **–¢–∏–ø:** CalDAV (Radicale)
- **–§–æ—Ä–º–∞—Ç:** iCalendar (.ics —Ñ–∞–π–ª—ã)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** `/data/collections/{user_id}/calendar_id/events.ics`
- **–¢–∞–±–ª–∏—Ü SQL:** 0

**–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å:**
- **–¢–∏–ø:** SQLAlchemy (SQL –±–∞–∑–∞)
- **–§–æ—Ä–º–∞—Ç:** –†–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- **–¢–∞–±–ª–∏—Ü—ã:** `property_clients`, `property_listings`, `property_selections`, `selection_items`, `selection_feedback`, `user_bot_modes`
- **–§–∞–π–ª–æ–≤ .ics:** 0

### ‚úÖ 4. API endpoints —Ä–∞–∑–Ω—ã–µ

**–ö–∞–ª–µ–Ω–¥–∞—Ä—å:**
```
GET    /api/events
POST   /api/events
PUT    /api/events/{user_id}/{id}
DELETE /api/events/{user_id}/{id}
GET    /api/events/free-slots
```

**–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å:**
```
POST   /api/property/clients
GET    /api/property/clients/{id}
POST   /api/property/listings
POST   /api/property/selections
POST   /api/property/feedback
POST   /api/property/rank
```

### ‚úÖ 5. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ —Å–≤—è–∑–∏ - Router

**–§–∞–π–ª:** `app/services/telegram_handler.py` (—Å—Ç—Ä–æ–∫–∏ 179-194)

```python
# –ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
message = update.message

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º
current_mode = await property_service.get_user_mode(user_id)

# –†–û–£–¢–ò–ù–ì –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
if current_mode == BotMode.PROPERTY:
    # ====> –ú–ò–ö–†–û–°–ï–†–í–ò–° –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò
    await property_handler.handle_property_message(update, user_id, message.text)
else:
    # ====> –ú–ò–ö–†–û–°–ï–†–í–ò–° –ö–ê–õ–ï–ù–î–ê–†–Ø
    await self._handle_text(update, user_id, message.text)
```

**–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- ‚úÖ –û–¥–∏–Ω entry point
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é (user_bot_modes —Ç–∞–±–ª–∏—Ü–∞)
- ‚úÖ –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–Ω–∞—é—Ç –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å 3-–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
                    TELEGRAM HANDLER (Router)
                            ‚îÇ
                            ‚îÇ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∂–∏–º
                            ‚îÇ (user_bot_modes table)
                            ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ                               ‚îÇ
            ‚ñº                               ‚ñº
    CALENDAR SERVICE              PROPERTY SERVICE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê              ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    ü§ñ llm_agent_yandex          ü§ñ llm_agent_property

    üì¶ calendar_radicale         üì¶ property_service
       daily_reminders              property_scoring
       event_reminders              property_handler

    üóÑÔ∏è  Radicale CalDAV          üóÑÔ∏è  SQLAlchemy DB
       (iCalendar .ics)             (SQL tables)

    üåê /api/events               üåê /api/property

    ‚ùå –ù–ï —Å–≤—è–∑–∞–Ω—ã ‚ùå            ‚ùå –ù–ï —Å–≤—è–∑–∞–Ω—ã ‚ùå
```

---

## –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏

–ö–∞–∫ –≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–∞–∑–∞–ª–∏:
> "–µ—Å–ª–∏ –Ω–∞–¥–æ –±—É–¥–µ—Ç –∏—Ö —Å–≤—è–∑–∞—Ç—å –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º, —Ç–æ —Å–¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å"

**–ü—Ä–∏–º–µ—Ä:**
```
app/services/integration/
‚îú‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ property_calendar_sync.py

# –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –û–ë–ê –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞
from app.services.calendar_radicale import calendar_service
from app.services.property.property_service import property_service

# –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π:
# ‚Ä¢ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã" –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
# ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—ã –≤—Å—Ç—Ä–µ—á —Å –∞–≥–µ–Ω—Ç–æ–º
# ‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞—Ö
```

**–í–∞–∂–Ω–æ:** Property –∏ Calendar –≤—Å—ë —Ä–∞–≤–Ω–æ –ù–ï –±—É–¥—É—Ç –∑–Ω–∞—Ç—å –æ Integration Service.
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –ø—É–±–ª–∏—á–Ω—ã–µ API.

---

## –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|----------|--------|----------|
| AI –∞–≥–µ–Ω—Ç—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã | ‚úÖ –î–ê | –†–∞–∑–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã, –Ω–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ |
| –ë—ç–∫–µ–Ω–¥—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã | ‚úÖ –î–ê | –ù–µ—Ç –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ |
| –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–Ω—ã–µ | ‚úÖ –î–ê | CalDAV vs SQL |
| API endpoints —Ä–∞–∑–Ω—ã–µ | ‚úÖ –î–ê | /events vs /property |
| –û–¥–Ω–∞ —Ç–æ—á–∫–∞ —Å–≤—è–∑–∏ | ‚úÖ –î–ê | telegram_handler —Ä–æ—É—Ç–µ—Ä |
| –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é | ‚úÖ –î–ê | –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å 3-–π —Å–µ—Ä–≤–∏—Å |

---

## –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã

üìÑ [MICROSERVICES_SEPARATION_AUDIT.md](MICROSERVICES_SEPARATION_AUDIT.md) - –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞—É–¥–∏—Ç
üìÑ [ARCHITECTURE_DIAGRAM.md](ARCHITECTURE_DIAGRAM.md) - –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–ë—ç–∫–µ–Ω–¥—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–¥–µ–ª–µ–Ω—ã**
‚úÖ **AI –∞–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ**
‚úÖ **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ —Å–≤—è–∑–∏ - —Ä–æ—É—Ç–µ—Ä –≤ telegram_handler**
‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞**

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ!** üéâ

---

**–ü—Ä–æ–≤–µ—Ä–∏–ª:** Claude Code
**–°—Ç–∞—Ç—É—Å:** ‚úÖ VERIFIED
**–î–∞—Ç–∞:** 2025-10-28
