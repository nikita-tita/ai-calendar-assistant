<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ article.title }}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--tg-theme-text-color, #000);
            background-color: var(--tg-theme-bg-color, #fff);
            padding: 16px;
            font-size: 16px;
        }

        .article-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000);
        }

        .article-meta {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 8px;
        }

        .article-meta span {
            margin-right: 12px;
        }

        .category-badge {
            display: inline-block;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #fff);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .article-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 24px;
            max-height: 300px;
            object-fit: cover;
        }

        .article-content {
            margin-bottom: 32px;
        }

        .article-content h1,
        .article-content h2,
        .article-content h3 {
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .article-content h1 { font-size: 22px; }
        .article-content h2 { font-size: 20px; }
        .article-content h3 { font-size: 18px; }

        .article-content p {
            margin-bottom: 16px;
            line-height: 1.7;
        }

        .article-content ul,
        .article-content ol {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .article-content li {
            margin-bottom: 8px;
        }

        .article-content strong {
            font-weight: 600;
            color: var(--tg-theme-text-color, #000);
        }

        .article-content blockquote {
            border-left: 3px solid var(--tg-theme-button-color, #0088cc);
            padding-left: 16px;
            margin: 16px 0;
            font-style: italic;
            color: var(--tg-theme-hint-color, #666);
        }

        .article-content a {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: none;
        }

        .article-content a:hover {
            text-decoration: underline;
        }

        .article-footer {
            padding-top: 24px;
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            text-align: center;
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999);
        }

        .error {
            padding: 20px;
            background: #ffebee;
            color: #c62828;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        @media (prefers-color-scheme: dark) {
            .article-content img {
                opacity: 0.9;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏...</div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Get article slug from URL
        const pathParts = window.location.pathname.split('/');
        const articleSlug = pathParts[pathParts.length - 1];

        // Fetch article data
        async function loadArticle() {
            try {
                const response = await fetch(`/api/blog/articles/slug/${articleSlug}`);

                if (!response.ok) {
                    throw new Error('–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                const article = await response.json();
                renderArticle(article);

            } catch (error) {
                console.error('Error loading article:', error);
                document.getElementById('app').innerHTML = `
                    <div class="error">
                        ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function renderArticle(article) {
            // Format date
            const publishedDate = article.published_at ?
                new Date(article.published_at).toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '';

            // Convert markdown to HTML (basic conversion)
            let content = article.rewritten_content || '';

            // Convert headings
            content = content.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            content = content.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            content = content.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Convert bold
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert paragraphs
            content = content.split('\n\n').map(p => {
                if (!p.startsWith('<h') && !p.startsWith('<ul') && !p.startsWith('<ol')) {
                    return `<p>${p.trim()}</p>`;
                }
                return p;
            }).join('\n');

            // Render HTML
            document.getElementById('app').innerHTML = `
                <div class="article-header">
                    <h1>${article.title}</h1>
                    <div class="article-meta">
                        ${publishedDate ? `<span>üìÖ ${publishedDate}</span>` : ''}
                        ${article.category ? `<span class="category-badge">${article.category.name || article.category}</span>` : ''}
                    </div>
                </div>

                ${article.main_image_url ? `
                    <img src="${article.main_image_url}" alt="${article.title}" class="article-image" onerror="this.style.display='none'">
                ` : ''}

                <div class="article-content">
                    ${content}
                </div>

                ${article.source_url ? `
                    <div class="article-footer">
                        –ò—Å—Ç–æ—á–Ω–∏–∫: ${article.source_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                    </div>
                ` : ''}
            `;
        }

        // Load article on page load
        loadArticle();
    </script>
</body>
</html>
