# Анализ проблемных сценариев взаимодействия
## Период: 10-20 декабря 2025

**Всего за период:** 337 действий от 31 пользователя
**Формальных ошибок (success=0):** 6 (intent_unclear)
**Технических ошибок (error_message):** 19 случаев

---

## ТОП-10 проблемных сценариев

### 1. Yandex GPT отказывается обрабатывать запрос
**Частота:** 11 случаев (8 декабря 2025)
**Пользователь:** 5602113922

**Тест-кейсы:**
```
- "Какие планы на сегодня?"
- "обед в 14"
- "удали бег из календаря"
- "поставь обед на 14"
```

**Ответ LLM:**
> "Я не могу обсуждать эту тему. Давайте поговорим о чём-нибудь ещё."

**Причина:**
Yandex GPT иногда блокирует совершенно безобидные запросы, вероятно из-за:
- Внутренней модерации контента
- Ошибок классификации намерений
- Перегрузки сервиса

**План устранения:**
1. Добавить retry-логику с экспоненциальной задержкой (3 попытки)
2. Реализовать fallback на альтернативную модель (GigaChat или локальную)
3. Логировать случаи блокировки для анализа паттернов
4. Добавить проверку ответа LLM на паттерн отказа и автоматический retry

---

### 2. Создание события без времени (NoneType error)
**Частота:** 7 случаев
**Пользователи:** 6801480360, 2296243

**Тест-кейсы:**
```
- "Начать прозванивать базу по продаже земли" (без времени)
- "Разобрать заявки по продаже"
- "Подъем"
- "Проверить админку"
```

**Ошибка:**
> unsupported operand type(s) for +: 'NoneType' and 'datetime.timedelta'

**Причина:**
При создании события без указания времени, LLM возвращает `null` в поле `start_time`. Код пытается добавить timedelta к None.

**План устранения:**
1. Добавить валидацию `start_time` перед операцией с datetime
2. Если время не указано - создавать как задачу (todo) вместо события
3. Либо спрашивать время у пользователя через clarify

**Файл:** `app/services/calendar_radicale.py` или `app/services/telegram_handler.py`

---

### 3. Краткие запросы без контекста
**Частота:** ~5 случаев
**Пользователи:** разные

**Тест-кейсы:**
```
- "Брокер тур" → бот просит уточнить время
- "Калининград" → бот не понимает что делать
- "12.00" (как ответ) → не связывается с предыдущим контекстом
```

**Причина:**
Пользователи отправляют короткие сообщения, ожидая что бот "помнит" предыдущий контекст.

**План устранения:**
1. Реализовать кратковременную память контекста (последние 2-3 сообщения)
2. При неполном запросе - использовать контекст для дополнения
3. Улучшить промпт LLM для работы с краткими запросами

---

### 4. Комбинированные команды (удалить + создать)
**Частота:** 2 случая
**Пользователь:** 2296243

**Тест-кейсы:**
```
- "удали Звонок с АН Инфинити и поставь на завтра в 14 Звонок с АН Инфинити"
```

**Ошибка:**
> 'CalendarEvent' object has no attribute 'get'

**Причина:**
LLM распознаёт батч-операцию, но код не обрабатывает смешанный тип (delete + create) корректно.

**План устранения:**
1. Улучшить обработку батч-операций разных типов
2. Разбивать сложные команды на последовательные операции
3. Добавить поддержку комбинации delete + create

---

### 5. Указательные местоимения ("эту задачу", "эти задачи")
**Частота:** 2 случая
**Пользователь:** 1149219528

**Тест-кейсы:**
```
- "Эти задачи выполнены" → бот просит уточнить какие именно
- "На завтра поставь эту задачу" → бот просит название
```

**Причина:**
Бот не имеет контекста о каких именно задачах/событиях идёт речь.

**План устранения:**
1. Хранить последние упомянутые задачи/события в сессии
2. При использовании "эту/эти" - подставлять из контекста
3. Показывать список недавних задач для выбора

---

### 6. Жалобы на время/часовой пояс
**Частота:** 3 случая
**Пользователь:** 1149219528

**Тест-кейсы:**
```
- "Календарь у тебя неправильно выставлено время"
- "У тебя сбился календарь какое сегодня число"
- "Сейчас 18 декабря 11:30"
```

**Причина:**
Пользователь думает что у бота неправильное время/дата, но не может его "поправить".

**План устранения:**
1. Добавить команду /timezone для настройки часового пояса пользователя
2. Показывать текущее время бота в ответах на запросы о дате/времени
3. Добавить понятный ответ "Моё время: XX:XX (МСК). Если нужно другое - напишите /timezone"

---

### 7. Неформальные сообщения
**Частота:** ~3 случая

**Тест-кейсы:**
```
- "привет" → бот просит переформулировать
- "как дела?" → бот говорит что вопрос не связан с календарём
- "Ваня гей" (тролль)
```

**Причина:**
Бот слишком строго интерпретирует сообщения, не умеет вести small talk.

**План устранения:**
1. Добавить распознавание приветствий и базовый small talk
2. На "привет" отвечать приветствием + напоминанием о функциях
3. Игнорировать или мягко отклонять троллинг

---

### 8. Пустые результаты поиска без альтернатив
**Частота:** ~10 случаев

**Тест-кейсы:**
```
- "Какие планы на сегодня?" → "На сегодня пусто"
- "Какие планы на завтра?" → "На завтра пусто"
```

**Проблема:**
Пользователь получает "пусто" без понятного следующего шага.

**План устранения:**
1. При пустом результате предлагать создать событие
2. Показывать ближайшие события если на запрошенный день пусто
3. Добавить кнопки быстрых действий

---

### 9. Перенос событий на относительные даты
**Частота:** 1 случай

**Тест-кейсы:**
```
- "нет, завтра" (в ответ на предложение) → бот не понимает
- "перепиши эти события на сегодня" → требует уточнить какие
```

**Причина:**
Относительные даты в ответах ("нет, завтра") не связываются с контекстом.

**План устранения:**
1. Улучшить обработку follow-up сообщений
2. Хранить контекст последней операции
3. Понимать "нет, завтра" как изменение даты в текущей операции

---

### 10. Голосовые сообщения с нераспознанным контентом
**Частота:** ~14 голосовых за 10 дней

**Тест-кейсы:**
Голосовые сообщения логируются как "Voice message received" без деталей транскрипции.

**Потенциальные проблемы:**
- Качество распознавания речи
- Акцент/диалект
- Фоновый шум

**План устранения:**
1. Логировать транскрибированный текст для анализа качества
2. Добавить confidence score в аналитику
3. При низком confidence - просить повторить или написать текстом

---

## Сводка по приоритетам

| Приоритет | Сценарий | Влияние | Сложность |
|-----------|----------|---------|-----------|
| P0 | Yandex GPT блокировка | 11 случаев | Средняя |
| P0 | NoneType при создании события | 7 случаев | Низкая |
| P1 | Комбинированные команды | 2 случая, критичный UX | Средняя |
| P1 | Краткие запросы без контекста | Частое | Высокая |
| P2 | Указательные местоимения | 2 случая | Высокая |
| P2 | Жалобы на время/таймзону | 3 случая | Средняя |
| P3 | Small talk | Низкое влияние | Низкая |
| P3 | Пустые результаты | UX improvement | Низкая |

---

## Рекомендуемый порядок исправлений

### Фаза 1 (Quick wins):
1. Fix NoneType error при создании события без времени
2. Добавить retry для Yandex GPT с fallback
3. Улучшить ответ на пустые результаты

### Фаза 2 (UX improvements):
4. Добавить контекстную память (последние 2-3 сообщения)
5. Улучшить обработку комбинированных команд
6. Добавить распознавание приветствий

### Фаза 3 (Advanced):
7. Реализовать указательные местоимения через контекст
8. Добавить настройку таймзоны
9. Улучшить логирование голосовых сообщений

---

**Дата анализа:** 20 декабря 2025
**Источник данных:** analytics.db (SQLite)
