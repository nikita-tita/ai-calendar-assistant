#!/bin/bash
# ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ¹ ÐŸÐžÐ¡Ð›Ð• ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ llm_agent_yandex.py

# 1. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ telegram_handler.py (Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ import Ð½Ð° ÑÑ‚Ñ€Ð¾ÐºÐµ 9)
sed -i 's/from app.services.llm_agent_openai import llm_agent_openai as llm_agent/from app.services.llm_agent_yandex import llm_agent_yandex as llm_agent/' /root/ai-calendar-assistant/app/services/telegram_handler.py

echo "âœ… telegram_handler.py Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"

# 2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ config.py (Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Yandex GPT Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)
# ÐÐ°Ð¹Ñ‚Ð¸ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ "# Database" Ð¸ Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ´ Ð½ÐµÐ¹
sed -i '/# Database/i\    # Yandex GPT (for regions where Claude\/OpenAI are blocked)\n    yandex_gpt_api_key: Optional[str] = None\n    yandex_gpt_folder_id: Optional[str] = None\n' /root/ai-calendar-assistant/app/config.py

echo "âœ… config.py Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"

# 3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ requirements.txt (Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ requests)
echo "requests>=2.31.0" >> /root/ai-calendar-assistant/requirements.txt

echo "âœ… requirements.txt Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"

# 4. Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Yandex GPT ÐºÐ»ÑŽÑ‡Ð¸ Ð² .env
cat >> /root/ai-calendar-assistant/.env << 'ENDOFENV'

# Yandex GPT (Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¸Ð· Ð Ð¾ÑÑÐ¸Ð¸ Ð±ÐµÐ· VPN)
YANDEX_GPT_API_KEY=YOUR_API_KEY_HERE
YANDEX_GPT_FOLDER_ID=YOUR_FOLDER_ID_HERE
ENDOFENV

echo "âœ… .env Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ (Ð½Ðµ Ð·Ð°Ð±ÑƒÐ´ÑŒ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ YOUR_API_KEY_HERE Ð¸ YOUR_FOLDER_ID_HERE)"

# 5. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°
cd /root/ai-calendar-assistant
docker-compose -f docker-compose.production.yml down
docker-compose -f docker-compose.production.yml up -d --build

echo "â³ Ð–Ð´Ñ‘Ð¼ 5 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
sleep 5

echo "ðŸ“‹ Ð›Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð°:"
docker logs telegram-bot --tail 50

echo ""
echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
echo ""
echo "âš ï¸  Ð’ÐÐ–ÐÐž: ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ API ÐºÐ»ÑŽÑ‡Ð¸ Yandex Cloud Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .env:"
echo "   1. Ð˜Ð´Ð¸ Ð½Ð° https://console.cloud.yandex.ru/"
echo "   2. Ð¡Ð¾Ð·Ð´Ð°Ð¹ Service Account Ñ Ñ€Ð¾Ð»ÑŒÑŽ ai.languageModels.user"
echo "   3. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸ API Key"
echo "   4. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹ Folder ID"
echo "   5. ÐžÐ±Ð½Ð¾Ð²Ð¸ .env: nano /root/ai-calendar-assistant/.env"
echo "   6. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸: docker-compose -f docker-compose.production.yml restart"
