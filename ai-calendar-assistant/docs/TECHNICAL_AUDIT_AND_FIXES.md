# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º –∏ –¢–ó –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–î–∞—Ç–∞:** 20 –¥–µ–∫–∞–±—Ä—è 2025
**–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:** 10-20 –¥–µ–∫–∞–±—Ä—è 2025

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
telegram_handler.py     ‚Üí –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Ä–æ—É—Ç–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π
        ‚Üì
llm_agent_yandex.py     ‚Üí LLM –∞–≥–µ–Ω—Ç (Yandex GPT), –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
        ‚Üì
calendar_radicale.py    ‚Üí CalDAV –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
todos_service.py        ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
```

### –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°–∏–º–≤–æ–ª–æ–≤ | –°—Ç—Ä–æ–∫ |
|-----------|----------|-------|
| base_system_prompt | ~2,800 | ~67 |
| date_context (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π) | ~800 | ~20 |
| json_instruction | ~700 | ~16 |
| function_schema | ~3,000 | ~80 |
| existing_events (–¥–æ 10) | ~1,500 | - |
| dialog_history (–¥–æ 10 msg) | ~5,000 | - |
| **–ò–¢–û–ì–û (–º–∞–∫—Å.)** | **~14,000** | - |

**–í—ã–≤–æ–¥:** –ü—Ä–æ–º–ø—Ç —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–∞–ª—å–Ω–µ–π—à–µ–µ —Å–∂–∞—Ç–∏–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞.

---

## –¢–û–ü-10 –ø—Ä–æ–±–ª–µ–º: –ü—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. Yandex GPT –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

**–°–∏–º–ø—Ç–æ–º:** LLM –æ—Ç–≤–µ—á–∞–µ—Ç "–Ø –Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å —ç—Ç—É —Ç–µ–º—É" –Ω–∞ –±–µ–∑–æ–±–∏–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

**–ß–∞—Å—Ç–æ—Ç–∞:** 11 —Å–ª—É—á–∞–µ–≤ (8 –¥–µ–∫–∞–±—Ä—è)

**–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
```
"–ö–∞–∫–∏–µ –ø–ª–∞–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?" ‚Üí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
"–æ–±–µ–¥ –≤ 14" ‚Üí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
"—É–¥–∞–ª–∏ –±–µ–≥ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è" ‚Üí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
```

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
Yandex GPT –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ò–Ω–æ–≥–¥–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è –ª–æ–∂–Ω–æ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –Ω–∞:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ó–∞–ø—Ä–æ—Å—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ "—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏" —Å–ª–æ–≤–∞–º–∏
- –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏

**–ú–µ—Å—Ç–æ –≤ –∫–æ–¥–µ:**
`app/services/llm_agent_yandex.py:785-831` - HTTP –≤—ã–∑–æ–≤ API

**–†–µ—à–µ–Ω–∏–µ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞):**

```python
# llm_agent_yandex.py:785
# –î–æ–±–∞–≤–∏—Ç—å retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

MAX_RETRIES = 3

for attempt in range(MAX_RETRIES):
    try:
        response = await client.post(...)
        result_text = response_data["result"]["alternatives"][0]["message"]["text"]

        # –î–µ—Ç–µ–∫—Ü–∏—è –æ—Ç–∫–∞–∑–∞
        if self._is_refusal_response(result_text):
            if attempt < MAX_RETRIES - 1:
                await asyncio.sleep(0.5 * (attempt + 1))
                continue
            # –ü–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ - fallback –Ω–∞ TODO
            return self._create_todo_fallback(user_text)
        break
    except Exception:
        ...

def _is_refusal_response(self, text: str) -> bool:
    """Detect Yandex GPT content moderation refusal."""
    refusal_patterns = [
        "–Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å",
        "–¥–∞–≤–∞–π—Ç–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —á—ë–º-–Ω–∏–±—É–¥—å",
        "–Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å —Å —ç—Ç–∏–º",
    ]
    return any(p in text.lower() for p in refusal_patterns)

def _create_todo_fallback(self, user_text: str) -> EventDTO:
    """Create TODO when LLM refuses to process."""
    return EventDTO(
        intent=IntentType.TODO,
        title=user_text.strip(),
        confidence=0.5
    )
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +30 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 2. NoneType + timedelta –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è

**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ `unsupported operand type(s) for +: 'NoneType' and 'datetime.timedelta'`

**–ß–∞—Å—Ç–æ—Ç–∞:** 7 —Å–ª—É—á–∞–µ–≤

**–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
```
"–ù–∞—á–∞—Ç—å –ø—Ä–æ–∑–≤–∞–Ω–∏–≤–∞—Ç—å –±–∞–∑—É –ø–æ –ø—Ä–æ–¥–∞–∂–µ –∑–µ–º–ª–∏" ‚Üí calendar_error
"–†–∞–∑–æ–±—Ä–∞—Ç—å –∑–∞—è–≤–∫–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–µ" ‚Üí calendar_error
"–ü–æ–¥—ä–µ–º" ‚Üí calendar_error
```

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
1. LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `intent=create` –≤–º–µ—Å—Ç–æ `intent=todo` –¥–ª—è –∑–∞–¥–∞—á –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
2. `start_time` = `None`, –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã—á–∏—Å–ª–∏—Ç—å `end_time = start_time + timedelta`

**–ú–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ:**
- `llm_agent_yandex.py:1113-1136` - fallback –¥–ª—è default start_time (—É–∂–µ –µ—Å—Ç—å!)
- `calendar_radicale.py:193-198` - –ø—Ä–æ–≤–µ—Ä–∫–∞ start_time (—É–∂–µ –µ—Å—Ç—å!)
- `telegram_handler.py:1720-1727` - batch_actions –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞ datetime

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ batch_actions:**
```python
# telegram_handler.py:1718-1725
single_event = EventDTO(
    intent=IntentType.CREATE,
    title=action.get("title"),
    start_time=action.get("start_time"),  # ‚Üê –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π ISO –∏–ª–∏ None
    ...
)
```

`action.get("start_time")` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É `"2025-12-20T15:00:00+03:00"`, –Ω–æ Pydantic –æ–∂–∏–¥–∞–µ—Ç `datetime` –æ–±—ä–µ–∫—Ç.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# telegram_handler.py:1714-1740
for action in event_dto.batch_actions:
    try:
        # –ü–∞—Ä—Å–∏–Ω–≥ datetime –∏–∑ —Å—Ç—Ä–æ–∫–∏
        start_time = self._parse_action_datetime(action.get("start_time"))
        end_time = self._parse_action_datetime(action.get("end_time"))

        # Skip –µ—Å–ª–∏ –Ω–µ—Ç start_time - –Ω–µ —Å–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
        if not start_time:
            logger.warning("batch_action_missing_time", title=action.get("title"))
            failed_count += 1
            continue

        single_event = EventDTO(
            intent=IntentType.CREATE,
            title=action.get("title"),
            start_time=start_time,
            end_time=end_time,
            ...
        )
        ...

def _parse_action_datetime(self, dt_value) -> Optional[datetime]:
    """Parse datetime from batch action (can be string, datetime, or None)."""
    if dt_value is None:
        return None
    if isinstance(dt_value, datetime):
        return dt_value
    if isinstance(dt_value, str):
        try:
            return datetime.fromisoformat(dt_value)
        except ValueError:
            return None
    return None
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +25 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 3. –ö—Ä–∞—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä", "12:00".

**–ß–∞—Å—Ç–æ—Ç–∞:** ~5 —Å–ª—É—á–∞–µ–≤

**–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
```
"–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä" ‚Üí "–£—Ç–æ—á–Ω–∏—Ç–µ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è"
"12:00" (–∫–∞–∫ –æ—Ç–≤–µ—Ç) ‚Üí –ù–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
```

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
1. Dialog history –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ LLM, –Ω–æ –ø—Ä–æ–º–ø—Ç –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç –∫–∞–∫ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
2. –ù–µ—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è —á—Ç–æ "12:00" - —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å

**–¢–µ–∫—É—â–∏–π flow:**
```
dialog_history:
  - user: "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä"
  - assistant: "–£—Ç–æ—á–Ω–∏—Ç–µ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è"

conversation_history (clarify_context):
  - user: "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä"
  - assistant: "–£—Ç–æ—á–Ω–∏—Ç–µ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è"

‚Üí LLM –ø–æ–ª—É—á–∞–µ—Ç: "User request: 12:00"
```

**–†–µ—à–µ–Ω–∏–µ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞):**

–î–æ–±–∞–≤–∏—Ç—å –≤ `base_system_prompt` –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 107:

```
# llm_agent_yandex.py –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 107
–û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–û–í –ù–ê –£–¢–û–ß–ù–ï–ù–ò–Ø:
- –ï—Å–ª–∏ –≤ dialog_history –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å "–£—Ç–æ—á–Ω–∏—Ç–µ –≤—Ä–µ–º—è/–¥–∞—Ç—É/–Ω–∞–∑–≤–∞–Ω–∏–µ":
  - –ß–∏—Å–ª–∞ (12:00, 14.00) = —ç—Ç–æ –í–†–ï–ú–Ø –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  - –î–∞—Ç—ã (–∑–∞–≤—Ç—Ä–∞, 25 –¥–µ–∫–∞–±—Ä—è) = —ç—Ç–æ –î–ê–¢–ê –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ö–æ–º–±–∏–Ω–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç + –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
- –ü—Ä–∏–º–µ—Ä: "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä" + "12:00" ‚Üí create, title="–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä", start_time=12:00
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–¥ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞):**

```python
# telegram_handler.py:1262
# –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º LLM - –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

def _enrich_with_context(self, user_text: str, user_id: str) -> str:
    """Enrich short user response with previous context."""
    history = self.conversation_history.get(user_id, [])
    if len(history) < 2:
        return user_text

    last_bot = history[-1]
    prev_user = history[-2]

    # Detect if this is a short answer to clarify question
    if (last_bot.get("role") == "assistant" and
        "—É—Ç–æ—á–Ω–∏—Ç–µ" in last_bot.get("content", "").lower() and
        len(user_text.split()) <= 3):

        # Combine: "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä" + "12:00" ‚Üí "–ë—Ä–æ–∫–µ—Ä —Ç—É—Ä –≤ 12:00"
        prev_request = prev_user.get("content", "")
        return f"{prev_request} –≤ {user_text}"

    return user_text
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +20 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, ~50 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞

---

### 4. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—É–¥–∞–ª–∏—Ç—å + —Å–æ–∑–¥–∞—Ç—å)

**–°–∏–º–ø—Ç–æ–º:** `'CalendarEvent' object has no attribute 'get'`

**–ß–∞—Å—Ç–æ—Ç–∞:** 2 —Å–ª—É—á–∞—è

**–¢–µ—Å—Ç-–∫–µ–π—Å:**
```
"—É–¥–∞–ª–∏ –ó–≤–æ–Ω–æ–∫ —Å –ê–ù –ò–Ω—Ñ–∏–Ω–∏—Ç–∏ –∏ –ø–æ—Å—Ç–∞–≤—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 14 –ó–≤–æ–Ω–æ–∫ —Å –ê–ù –ò–Ω—Ñ–∏–Ω–∏—Ç–∏"
```

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `batch_actions` —Å —Ä–∞–∑–Ω—ã–º–∏ intent (delete + create), –Ω–æ `_handle_batch_confirm` –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ `create`.

**–ú–µ—Å—Ç–æ –≤ –∫–æ–¥–µ:**
`telegram_handler.py:1714-1761` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ create

**–†–µ—à–µ–Ω–∏–µ:**

```python
# telegram_handler.py:1701
async def _handle_batch_confirm(self, update, user_id, event_dto, user_text=None):
    """Handle batch operations (create, delete, or mixed)."""

    for action in event_dto.batch_actions:
        action_intent = action.get("intent", "create")

        if action_intent == "delete":
            # –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ _handle_delete
            event_id = action.get("event_id")
            if event_id and event_id != "none":
                success = await calendar_service.delete_event(user_id, event_id)
                if success:
                    deleted_count += 1
                else:
                    failed_count += 1

        elif action_intent == "create":
            # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
            ...

        elif action_intent == "update":
            # –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ update
            ...
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +30 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 5. –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è ("—ç—Ç—É –∑–∞–¥–∞—á—É")

**–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç "–≠—Ç–∏ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã", "–ù–∞ –∑–∞–≤—Ç—Ä–∞ –ø–æ—Å—Ç–∞–≤—å —ç—Ç—É –∑–∞–¥–∞—á—É"

**–ß–∞—Å—Ç–æ—Ç–∞:** 2 —Å–ª—É—á–∞—è

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
1. `event_context` —Ö—Ä–∞–Ω–∏—Ç ID –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ LLM –¥–ª—è –∑–∞–¥–∞—á (todos)
2. LLM –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–∞–≤–Ω–∏—Ö –∑–∞–¥–∞—á–∞—Ö

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `event_context` ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Å–æ–±—ã—Ç–∏–π (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `recent_context`)
- `todos` ‚Üí –Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**

```python
# telegram_handler.py

# 1. –î–æ–±–∞–≤–∏—Ç—å todos_context (–∞–Ω–∞–ª–æ–≥ event_context)
self.todos_context: LRUDict[str, dict] = LRUDict(max_size=1000)

# 2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ todo - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
async def _handle_create_todo(self, update, user_id, event_dto, user_text=None):
    ...
    if todo_id:
        self._add_to_todos_context(user_id, todo_id, event_dto.title)
    ...

# 3. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ "—ç—Ç–∏ –∑–∞–¥–∞—á–∏" - –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
def _get_todos_context(self, user_id: str) -> list:
    """Get recent todos for context."""
    ...

# 4. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ LLM
recent_todos = self._get_todos_context(user_id)
event_dto = await llm_agent.extract_event(
    ...
    recent_todos=recent_todos  # –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ–º–ø—Ç–µ:**

```
# llm_agent_yandex.py - –¥–æ–±–∞–≤–∏—Ç—å –≤ system prompt
<recent_todos>
–ù–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:
- {todo_title_1}
- {todo_title_2}
</recent_todos>

–í–ê–ñ–ù–û: "—ç—Ç—É –∑–∞–¥–∞—á—É", "—ç—Ç–∏ –∑–∞–¥–∞—á–∏" = –∑–∞–¥–∞—á–∏ –∏–∑ recent_todos
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +40 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, +100 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞

---

### 6. –ñ–∞–ª–æ–±—ã –Ω–∞ —Ç–∞–π–º–∑–æ–Ω—É

**–°–∏–º–ø—Ç–æ–º:** "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É —Ç–µ–±—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è"

**–ß–∞—Å—Ç–æ—Ç–∞:** 3 —Å–ª—É—á–∞—è

**–ü—Ä–∏—á–∏–Ω–∞ (root cause):**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –≤—Ä–µ–º—è –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ /timezone

**–†–µ—à–µ–Ω–∏–µ (UX, –Ω–µ –∫–æ–¥):**

```python
# telegram_handler.py - –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∂–∞–ª–æ–± –Ω–∞ –≤—Ä–µ–º—è
async def _handle_text(self, update, user_id, text, from_voice=False):
    ...
    # Detect timezone complaints
    time_complaint_patterns = [
        "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Ä–µ–º—è", "—Å–±–∏–ª—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "–Ω–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è",
        "–∫–∞–∫–æ–µ —Å–µ–≥–æ–¥–Ω—è —á–∏—Å–ª–æ", "–∫–∞–∫–æ–π —Å–µ–π—á–∞—Å —á–∞—Å"
    ]
    if any(p in text.lower() for p in time_complaint_patterns):
        current_tz = user_preferences.get_timezone(user_id)
        import pytz
        from datetime import datetime
        now = datetime.now(pytz.timezone(current_tz))

        msg = (f"üïê –ú–æ—ë –≤—Ä–µ–º—è: {now.strftime('%H:%M')} ({current_tz})\n\n"
               f"–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å - /timezone")
        await update.message.reply_text(msg)
        return
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +15 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 7. Small talk (–ø—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞)

**–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç "–í–∞—à –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º"

**–ß–∞—Å—Ç–æ—Ç–∞:** ~3 —Å–ª—É—á–∞—è

**–ü—Ä–∏—á–∏–Ω–∞:** LLM –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

**–†–µ—à–µ–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞):**

```python
# telegram_handler.py
GREETING_PATTERNS = ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "hello", "hi"]
SMALL_TALK_PATTERNS = ["–∫–∞–∫ –¥–µ–ª–∞", "–∫–∞–∫ —Ç—ã", "—á—Ç–æ –Ω–æ–≤–æ–≥–æ"]

async def _handle_text(self, update, user_id, text, from_voice=False):
    text_lower = text.lower().strip()

    # Handle greetings
    if any(text_lower.startswith(g) for g in GREETING_PATTERNS):
        await update.message.reply_text(
            "üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\n\n"
            "üìÖ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ: ¬´–í—Å—Ç—Ä–µ—á–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00¬ª\n"
            "üìù –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É: ¬´–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É¬ª"
        )
        return

    # Handle small talk
    if any(p in text_lower for p in SMALL_TALK_PATTERNS):
        await update.message.reply_text(
            "–û—Ç–ª–∏—á–Ω–æ, –≥–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å! üí™\n\n"
            "–ß—Ç–æ –∑–∞–ø–ª–∞–Ω–∏—Ä—É–µ–º?"
        )
        return

    # ... rest of handler
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +20 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 8. –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤

**–°–∏–º–ø—Ç–æ–º:** "–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø—É—Å—Ç–æ" –±–µ–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞

**–ß–∞—Å—Ç–æ—Ç–∞:** ~10 —Å–ª—É—á–∞–µ–≤

**–†–µ—à–µ–Ω–∏–µ:**

```python
# telegram_handler.py:1591 - _handle_query
if not events:
    # Get nearest future event
    future_events = await calendar_service.list_events(
        user_id, now, now + timedelta(days=30)
    )

    if future_events:
        next_event = future_events[0]
        next_date = format_datetime_human(next_event.start, user_tz)
        msg = (f"üì≠ –ù–∞ {query_date} –ø—É—Å—Ç–æ.\n\n"
               f"–ë–ª–∏–∂–∞–π—à–µ–µ —Å–æ–±—ã—Ç–∏–µ: {next_event.summary}\n"
               f"üìÖ {next_date}")
    else:
        msg = (f"üì≠ –ù–∞ {query_date} –ø—É—Å—Ç–æ.\n\n"
               f"–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ? –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
               f"¬´–í—Å—Ç—Ä–µ—á–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 14:00¬ª")

    await update.message.reply_text(msg)
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +15 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–∞

---

### 9. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–°–∏–º–ø—Ç–æ–º:** –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞ STT

**–†–µ—à–µ–Ω–∏–µ:**

```python
# telegram_handler.py:427
logger.info("voice_transcribed",
           user_id=user_id,
           text=text,
           duration_seconds=voice.duration,
           file_size=voice.file_size)

# Analytics
if ANALYTICS_ENABLED and analytics_service:
    analytics_service.log_action(
        user_id=user_id,
        action_type="voice_transcription",
        details=f"Transcribed: {text[:100]}",
        success=True
    )
```

**–†–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:** +10 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

### 10. –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—ã –≤ –æ—Ç–≤–µ—Ç–∞—Ö

**–°–∏–º–ø—Ç–æ–º:** "–Ω–µ—Ç, –∑–∞–≤—Ç—Ä–∞" –Ω–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø.3 (–∫—Ä–∞—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)

---

## –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
| –ü—Ä–æ–±–ª–µ–º–∞ | –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–º–ø—Ç | –°–∏–º–≤–æ–ª–æ–≤ |
|----------|-------------------|----------|
| #3 –ö—Ä–∞—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–æ–≤ | ~150 |
| #5 –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è | –ë–ª–æ–∫ recent_todos | ~100 |
| **–ò–¢–û–ì–û** | | **~250** |

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ |
|----------|------|------------|
| #1 GPT –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | llm_agent_yandex.py | +30 |
| #2 NoneType error | telegram_handler.py | +25 |
| #3 –ö—Ä–∞—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã | telegram_handler.py | +20 |
| #4 –ö–æ–º–±–æ-–∫–æ–º–∞–Ω–¥—ã | telegram_handler.py | +30 |
| #5 "—ç—Ç—É –∑–∞–¥–∞—á—É" | telegram_handler.py, llm_agent | +40 |
| #6 –¢–∞–π–º–∑–æ–Ω–∞ | telegram_handler.py | +15 |
| #7 Small talk | telegram_handler.py | +20 |
| #8 –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã | telegram_handler.py | +15 |
| #9 –ì–æ–ª–æ—Å–æ–≤—ã–µ | telegram_handler.py | +10 |
| **–ò–¢–û–ì–û** | | **~205** |

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: Critical Fixes (1-2 –¥–Ω—è)
1. **#2 NoneType error** - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ñ–∏–∫—Å, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫—Ä—ç—à–∏
2. **#1 GPT –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** - retry + fallback, —É–ª—É—á—à–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

### –§–∞–∑–∞ 2: UX Improvements (2-3 –¥–Ω—è)
3. **#3 –ö—Ä–∞—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã** - –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **#6 –¢–∞–π–º–∑–æ–Ω–∞** - –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∂–∞–ª–æ–±—ã
5. **#7 Small talk** - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –±–æ—Ç
6. **#8 –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** - –ø–æ–ª–µ–∑–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

### –§–∞–∑–∞ 3: Advanced Features (3-5 –¥–Ω–µ–π)
7. **#4 –ö–æ–º–±–æ-–∫–æ–º–∞–Ω–¥—ã** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ delete+create
8. **#5 "—ç—Ç—É –∑–∞–¥–∞—á—É"** - todos context

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–º–ø—Ç—É

### –ß—Ç–æ –ù–ï –º–µ–Ω—è—Ç—å:
- –†–∞–∑–º–µ—Ä base_system_prompt (~2800 —Å–∏–º–≤–æ–ª–æ–≤) - —É–∂–µ –æ–ø—Ç–∏–º–∞–ª–µ–Ω
- –°—Ç—Ä—É–∫—Ç—É—Ä—É JSON –æ—Ç–≤–µ—Ç–∞ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- –ü—Ä–∏–º–µ—Ä—ã intent - –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
- –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É en/es/ar –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí —ç–∫–æ–Ω–æ–º–∏—è ~500 —Å–∏–º–≤–æ–ª–æ–≤
- –£–º–µ–Ω—å—à–∏—Ç—å date_context –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –º–∞–ª–æ ‚Üí –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —ç–∫–æ–Ω–æ–º–∏—è

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –ø—Ä–æ–º–ø—Ç–∞:
–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º —Ä–µ—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **–∫–æ–¥**, –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç:
- Pre-processing –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Post-processing –æ—Ç–≤–µ—Ç–æ–≤ LLM
- Fallback –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

**–í—ã–≤–æ–¥:** 8 –∏–∑ 10 –ø—Ä–æ–±–ª–µ–º —Ä–µ—à–∞—é—Ç—Å—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º ~205 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞. –¢–æ–ª—å–∫–æ 2 –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–π –≤ –ø—Ä–æ–º–ø—Ç (~250 —Å–∏–º–≤–æ–ª–æ–≤).
