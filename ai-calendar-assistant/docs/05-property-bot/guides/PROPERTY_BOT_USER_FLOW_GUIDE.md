# –ì–∞–π–¥ –ø–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Property Bot

## –î–∞—Ç–∞: 2025-10-28

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–í–æ—Ä–æ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞](#–≤–æ—Ä–æ–Ω–∫–∞-–¥–∏–∞–ª–æ–≥–∞)
2. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤](#—Å—Ü–µ–Ω–∞—Ä–∏–∏-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–∑–∞–ø—Ä–æ—Å–æ–≤)
3. [–†–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤](#—Ä–∞–±–æ—Ç–∞-—Å-–±–æ–ª—å—à–∏–º-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
4. [–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —É—Å–ª–æ–≤–∏—è](#—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ-–ø—Ä–æ–≥—Ä–∞–º–º—ã-–∏-—É—Å–ª–æ–≤–∏—è)
5. [–£–º–Ω–æ–µ —Å—É–∂–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∫–∏](#—É–º–Ω–æ–µ-—Å—É–∂–µ–Ω–∏–µ-–≤—ã–±–æ—Ä–∫–∏)

---

## –í–æ—Ä–æ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞

### –≠—Ç–∞–ø 1: –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç)

**–¶–µ–ª—å:** –°–æ–±—Ä–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ must-have –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞

```
–ë–æ—Ç: üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ.

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Å –≥–ª–∞–≤–Ω–æ–≥–æ:

1Ô∏è‚É£ **–ë—é–¥–∂–µ—Ç** - —Å–∫–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å?
   –ü—Ä–∏–º–µ—Ä: "–¥–æ 10 –º–ª–Ω" –∏–ª–∏ "–æ—Ç 8 –¥–æ 12 –º–ª–Ω"

2Ô∏è‚É£ **–ö–æ–º–Ω–∞—Ç—ã** - —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ?
   –ü—Ä–∏–º–µ—Ä: "2 –∫–æ–º–Ω–∞—Ç—ã" –∏–ª–∏ "–¥–≤—É—à–∫–∞"

3Ô∏è‚É£ **–†–∞–π–æ–Ω** - –≥–¥–µ —Ö–æ—Ç–∏—Ç–µ –∂–∏—Ç—å?
   –ü—Ä–∏–º–µ—Ä: "–ë—É—Ç–æ–≤–æ" –∏–ª–∏ "–º–µ—Ç—Ä–æ –ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π"

–ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å—ë –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–ª–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏!
```

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ must-have –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:**
- ‚úÖ `budget_max` (—Ö–æ—Ç—è –±—ã –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞)
- ‚úÖ `rooms_min` / `rooms_max`
- ‚úÖ `districts` –ò–õ–ò `metro_stations` (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω)

**–ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–µ—Ä–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
- ‚úÖ "–î–≤—É—à–∫–∞ –≤ –ë—É—Ç–æ–≤–æ –¥–æ 12 –º–ª–Ω"
- ‚úÖ "3 –∫–æ–º–Ω–∞—Ç—ã, –º–µ—Ç—Ä–æ –ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π, –±—é–¥–∂–µ—Ç 15 –º–∏–ª–ª–∏–æ–Ω–æ–≤"
- ‚úÖ "–ö–≤–∞—Ä—Ç–∏—Ä–∞ –¥–æ 10 –º–ª–Ω, 2-3 –∫–æ–º–Ω–∞—Ç—ã, –Æ–∂–Ω–æ–µ –ë—É—Ç–æ–≤–æ"

**–ü—Ä–∏–º–µ—Ä—ã –ù–ï–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
- ‚ùå "–ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ" (–Ω–µ—Ç –±—é–¥–∂–µ—Ç–∞ –∏ –∫–æ–º–Ω–∞—Ç)
- ‚ùå "–î–≤—É—à–∫–∞ –Ω–µ–¥–æ—Ä–æ–≥–æ" (–±—é–¥–∂–µ—Ç –Ω–µ–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π)
- ‚ùå "–•–æ—á—É –∫–≤–∞—Ä—Ç–∏—Ä—É" (–Ω–∏—á–µ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ)

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```python
# –í llm_agent_property.py
async def extract_search_criteria(user_message: str, conversation_history: List) -> Dict:
    """Extract criteria with validation."""

    result = await self._call_yandex_gpt(messages)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º must-have –ø–æ–ª—è
    criteria = result.get("criteria", {})
    missing_fields = []

    if not criteria.get("budget_max"):
        missing_fields.append("–±—é–¥–∂–µ—Ç")

    if not (criteria.get("rooms_min") or criteria.get("rooms_max")):
        missing_fields.append("–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç")

    if not (criteria.get("districts") or criteria.get("metro_stations")):
        missing_fields.append("—Ä–∞–π–æ–Ω –∏–ª–∏ –º–µ—Ç—Ä–æ")

    # –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    if missing_fields:
        return {
            "intent": "clarify",
            "missing_fields": missing_fields,
            "clarify_question": self._generate_clarification_question(missing_fields, criteria),
            "confidence": 0.3
        }

    # –í—Å—ë –µ—Å—Ç—å - –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å
    return {
        "intent": "search",
        "criteria": criteria,
        "confidence": 0.9
    }

def _generate_clarification_question(self, missing_fields: List[str], partial_criteria: Dict) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è."""

    if len(missing_fields) == 1:
        if "–±—é–¥–∂–µ—Ç" in missing_fields:
            return "–û—Ç–ª–∏—á–Ω–æ! –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –±—é–¥–∂–µ—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä: '–¥–æ 10 –º–ª–Ω' –∏–ª–∏ '–æ—Ç 8 –¥–æ 12 –º–ª–Ω'"
        elif "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç" in missing_fields:
            return "–°—É–ø–µ—Ä! –°–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç –≤–∞–º –Ω—É–∂–Ω–æ? –ù–∞–ø—Ä–∏–º–µ—Ä: '2 –∫–æ–º–Ω–∞—Ç—ã' –∏–ª–∏ '2-3 –∫–æ–º–Ω–∞—Ç—ã'"
        elif "—Ä–∞–π–æ–Ω –∏–ª–∏ –º–µ—Ç—Ä–æ" in missing_fields:
            return "–ü–æ–Ω—è—Ç–Ω–æ! –í –∫–∞–∫–æ–º —Ä–∞–π–æ–Ω–µ –∏–ª–∏ —Ä—è–¥–æ–º —Å –∫–∞–∫–∏–º –º–µ—Ç—Ä–æ —Ö–æ—Ç–∏—Ç–µ –∂–∏—Ç—å?"

    # –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ –ø–æ—Ä—è–¥–∫—É
    return f"–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞: {' –∏ '.join(missing_fields)}"
```

---

### –≠—Ç–∞–ø 2: –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫ –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è must-have –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±–æ—Ç –¥–µ–ª–∞–µ—Ç –ø–æ–∏—Å–∫:

```python
# –í property_handler.py –∏–ª–∏ telegram_handler.py

async def handle_search_request(user_id: str, criteria: Dict) -> Dict:
    """Handle search with smart result analysis."""

    # 1. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
    listings = await property_service.search_listings(
        budget_max=criteria.get("budget_max"),
        rooms_min=criteria.get("rooms_min"),
        rooms_max=criteria.get("rooms_max"),
        districts=criteria.get("districts"),
        metro_stations=criteria.get("metro_stations"),
        limit=500  # –ë–µ—Ä—ë–º –±–æ–ª—å—à–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    )

    # 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    analysis = analyze_search_results(listings, criteria)

    # 3. –†–µ—à–∞–µ–º, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
    if analysis["total_count"] == 0:
        return handle_no_results(criteria, analysis)

    elif analysis["total_count"] < 20:
        # –ú–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å
        return handle_few_results(listings, criteria, user_id)

    elif analysis["total_count"] > 200:
        # –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —É—Ç–æ—á–Ω–∏—Ç—å
        return handle_too_many_results(listings, criteria, analysis)

    else:
        # –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - —Ä–∞–Ω–∂–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø
        return handle_optimal_results(listings, criteria, user_id)
```

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (0)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:** –£–º–Ω–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

```python
def handle_no_results(criteria: Dict, analysis: Dict) -> Dict:
    """Handle zero results - suggest relaxing filters."""

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å
    suggestions = []

    # 1. –ë—é–¥–∂–µ—Ç (—Ä–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ 10%)
    if criteria.get("budget_max"):
        new_budget = int(criteria["budget_max"] * 1.1)
        suggestions.append({
            "type": "budget",
            "message": f"–£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –¥–æ {format_price(new_budget)}?",
            "new_value": new_budget
        })

    # 2. –ö–æ–º–Ω–∞—Ç—ã (–¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ)
    if criteria.get("rooms_min") == criteria.get("rooms_max"):
        rooms = criteria["rooms_min"]
        suggestions.append({
            "type": "rooms",
            "message": f"–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–∫–∂–µ {rooms-1} –∏–ª–∏ {rooms+1} –∫–æ–º–Ω–∞—Ç–Ω—ã–µ?",
            "new_value": {"rooms_min": rooms-1, "rooms_max": rooms+1}
        })

    # 3. –†–∞–π–æ–Ω—ã (—Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–æ—Å–µ–¥–Ω–∏–º–∏)
    if criteria.get("districts"):
        nearby = get_nearby_districts(criteria["districts"])
        suggestions.append({
            "type": "districts",
            "message": f"–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ —Ä–∞–π–æ–Ω—ã: {', '.join(nearby)}?",
            "new_value": criteria["districts"] + nearby
        })

    # 4. –†–µ–º–æ–Ω—Ç (–µ—Å–ª–∏ –±—ã–ª —Ñ–∏–ª—å—Ç—Ä - —É–±—Ä–∞—Ç—å)
    if criteria.get("preferred_renovations"):
        suggestions.append({
            "type": "renovation",
            "message": "–£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–º–æ–Ω—Ç—É?",
            "new_value": None
        })

    return {
        "message": "üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–æ—Å—å.\n\n"
                   "–ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫?",
        "suggestions": suggestions,
        "action": "relax_filters"
    }
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
```
üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–æ—Å—å.

–ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫?

1. –£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –¥–æ 13.2 –º–ª–Ω? (–±—ã–ª–æ 12 –º–ª–Ω)
2. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–∫–∂–µ 1 –∏–ª–∏ 3 –∫–æ–º–Ω–∞—Ç–Ω—ã–µ? (–±—ã–ª–æ —Ç–æ–ª—å–∫–æ 2)
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ —Ä–∞–π–æ–Ω—ã: –ó—é–∑–∏–Ω–æ, –ß–µ—Ä—ë–º—É—à–∫–∏?
4. –£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ –¥–æ–º–∞"?

–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1-20)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∞–ª–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –Ω–æ –æ–Ω–∏ –µ—Å—Ç—å

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å + –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å

```python
async def handle_few_results(listings: List, criteria: Dict, user_id: str) -> Dict:
    """Handle few results - show all + suggest expansion."""

    # –†–∞–Ω–∂–∏—Ä—É–µ–º –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å
    client = await property_service.get_client_by_telegram_id(user_id)
    ranked = property_scoring_service.rank_listings(
        [l.dict() for l in listings],
        client.dict() if client else {},
        top_n=len(listings)  # –ë–µ—Ä—ë–º –≤—Å–µ
    )

    return {
        "message": f"üîç –ù–∞—à—ë–ª {len(listings)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.\n\n"
                   f"–ü–æ–∫–∞–∑—ã–≤–∞—é –≤—Å–µ —á—Ç–æ –µ—Å—Ç—å:",
        "listings": ranked,
        "action": "show_all",
        "suggestion": "–•–æ—Ç–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?"
    }
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
```
üîç –ù–∞—à—ë–ª 8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.

–ü–æ–∫–∞–∑—ã–≤–∞—é –≤—Å–µ —á—Ç–æ –µ—Å—Ç—å:

‚≠ê 1. [–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã]
‚≠ê 2. [–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã]
...
‚≠ê 8. [–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã]

üí° –•–æ—Ç–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?
–ú–æ–≥—É —É–±—Ä–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ä–∞–π–æ–Ω—ã.
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (200-1000+)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ - —Å–ª–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:** –£–º–Ω–æ–µ —Å—É–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é

```python
async def handle_too_many_results(listings: List, criteria: Dict, analysis: Dict) -> Dict:
    """Handle too many results - smart narrowing."""

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –ø–æ –∫–∞–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ä–∞–∑–±—Ä–æ—Å
    diversity = analyze_diversity(listings)

    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É –≤–∞–∂–Ω–æ—Å—Ç–∏
    suggestions = []

    # 1. –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ñ–ö - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ø–æ–≤—ã–µ
    if diversity["unique_buildings"] > 20:
        top_buildings = get_top_buildings_by_popularity(listings, top_n=5)
        suggestions.append({
            "type": "building",
            "message": "üìä –ù–∞—à–ª–æ—Å—å –±–æ–ª–µ–µ 20 –ñ–ö. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-5 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö?",
            "options": [b["name"] for b in top_buildings],
            "data": top_buildings
        })

    # 2. –ï—Å–ª–∏ –±–æ–ª—å—à–æ–π —Ä–∞–∑–±—Ä–æ—Å –ø–æ —Ä–µ–º–æ–Ω—Ç—É - —É—Ç–æ—á–Ω—è–µ–º
    if diversity["renovations"] > 2:
        suggestions.append({
            "type": "renovation",
            "message": "üé® –ö–≤–∞—Ä—Ç–∏—Ä—ã —Å —Ä–∞–∑–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–æ–º. –ß—Ç–æ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?",
            "options": ["–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ (–¥–µ—à–µ–≤–ª–µ)", "–° —á–∏—Å—Ç–æ–≤–æ–π –æ—Ç–¥–µ–ª–∫–æ–π", "–ü–æ–¥ –∫–ª—é—á"],
            "field": "preferred_renovations"
        })

    # 3. –ï—Å–ª–∏ —Ä–∞–∑–±—Ä–æ—Å –ø–æ —Ç–∏–ø—É –∑–¥–∞–Ω–∏—è
    if diversity["building_types"] > 2:
        suggestions.append({
            "type": "building_type",
            "message": "üèó –¢–∏–ø –¥–æ–º–∞ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ?",
            "options": ["–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π", "–ö–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π", "–ü–∞–Ω–µ–ª—å–Ω—ã–π", "–õ—é–±–æ–π"],
            "field": "preferred_building_types"
        })

    # 4. –ï—Å–ª–∏ —Ä–∞–∑–±—Ä–æ—Å –ø–æ —ç—Ç–∞–∂–∞–º
    if diversity["floor_spread"] > 10:
        suggestions.append({
            "type": "floor",
            "message": "üè¢ –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ —ç—Ç–∞–∂—É?",
            "options": [
                "–ù–µ –ø–µ—Ä–≤—ã–π –∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π",
                "–ù–∏–∑–∫–∏–µ —ç—Ç–∞–∂–∏ (2-5)",
                "–°—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏ (6-12)",
                "–í—ã—Å–æ–∫–∏–µ —ç—Ç–∞–∂–∏ (13+)",
                "–õ—é–±–æ–π"
            ],
            "field": "floor_preferences"
        })

    # 5. –î–∞—Ç–∞ —Å–¥–∞—á–∏ (–µ—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏)
    if diversity["handover_dates_spread"] > 12:  # > 1 –≥–æ–¥–∞
        suggestions.append({
            "type": "handover",
            "message": "üìÖ –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞?",
            "options": [
                "–£–∂–µ —Å–¥–∞–Ω / –±–ª–∏–∂–∞–π—à–∏–µ –º–µ—Å—è—Ü—ã",
                "–í —ç—Ç–æ–º –≥–æ–¥—É (2025)",
                "–°–ª–µ–¥—É—é—â–∏–π –≥–æ–¥ (2026)",
                "–ù–µ –≤–∞–∂–Ω–æ"
            ],
            "field": "handover_date"
        })

    return {
        "message": f"üî• –ù–∞—à—ë–ª {len(listings)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ - —ç—Ç–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ!\n\n"
                   f"–î–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–µ–µ:",
        "total_count": len(listings),
        "diversity": diversity,
        "suggestions": suggestions,
        "action": "narrow_down"
    }


def analyze_diversity(listings: List) -> Dict:
    """Analyze diversity of results to suggest narrowing."""

    unique_buildings = len(set(l.building_name for l in listings if l.building_name))
    renovations = len(set(l.renovation for l in listings if l.renovation))
    building_types = len(set(l.building_type for l in listings if l.building_type))

    floors = [l.floor for l in listings if l.floor]
    floor_spread = max(floors) - min(floors) if floors else 0

    handover_dates = []
    for l in listings:
        if l.building_year and l.ready_quarter:
            handover_dates.append(l.building_year * 10 + l.ready_quarter)

    handover_dates_spread = max(handover_dates) - min(handover_dates) if handover_dates else 0

    return {
        "unique_buildings": unique_buildings,
        "renovations": renovations,
        "building_types": building_types,
        "floor_spread": floor_spread,
        "handover_dates_spread": handover_dates_spread
    }
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):**
```
üî• –ù–∞—à—ë–ª 347 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ - —ç—Ç–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ!

–î–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–µ–µ:

üìä 1. –ù–∞—à–ª–æ—Å—å –±–æ–ª–µ–µ 20 –ñ–ö. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-5 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö?
   ‚Ä¢ –ñ–ö "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è" (87 –∫–≤–∞—Ä—Ç–∏—Ä)
   ‚Ä¢ –ñ–ö "NEXT" (64 –∫–≤–∞—Ä—Ç–∏—Ä—ã)
   ‚Ä¢ –ñ–ö "–ù–µ–æ–∫–ª–∞—Å—Å–∏–∫–∞" (52 –∫–≤–∞—Ä—Ç–∏—Ä—ã)
   ‚Ä¢ –ñ–ö "–î–æ—Å—Ç–æ—è–Ω–∏–µ" (41 –∫–≤–∞—Ä—Ç–∏—Ä–∞)
   ‚Ä¢ –ñ–ö "–°–∏–º–≤–æ–ª" (38 –∫–≤–∞—Ä—Ç–∏—Ä)

üé® 2. –ö–≤–∞—Ä—Ç–∏—Ä—ã —Å —Ä–∞–∑–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–æ–º. –ß—Ç–æ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?
   [ –ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ ]  [ –° —á–∏—Å—Ç–æ–≤–æ–π ]  [ –ü–æ–¥ –∫–ª—é—á ]

üèó 3. –¢–∏–ø –¥–æ–º–∞ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ?
   [ –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π ]  [ –ö–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π ]  [ –õ—é–±–æ–π ]

üìÖ 4. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞?
   [ –£–∂–µ —Å–¥–∞–Ω ]  [ –í 2025 ]  [ –í 2026 ]  [ –ù–µ –≤–∞–∂–Ω–æ ]

–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–æ–ø–∫–∏
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–¥–∏–Ω –ñ–ö, –º–Ω–æ–≥–æ –∫–≤–∞—Ä—Ç–∏—Ä (100+ –≤ –æ–¥–Ω–æ–º –ñ–ö)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–¥—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω –ñ–ö, –Ω–æ –≤ –Ω—ë–º 100+ —Ç–∏–ø–æ–≤—ã—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫

**–†–µ—à–µ–Ω–∏–µ:** –£–º–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º

```python
async def handle_single_building_many_flats(listings: List, building_name: str, criteria: Dict) -> Dict:
    """Handle case when one building has many matching flats."""

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–æ–≤—ã–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º
    clusters = cluster_by_layout(listings)

    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
    representatives = []
    for cluster in clusters:
        # –ë–µ—Ä—ë–º —Å–∞–º—ã–π –¥–µ—à—ë–≤—ã–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
        best = min(cluster["flats"], key=lambda x: x.price)
        representatives.append({
            "representative": best,
            "cluster_size": len(cluster["flats"]),
            "price_range": {
                "min": min(f.price for f in cluster["flats"]),
                "max": max(f.price for f in cluster["flats"])
            },
            "floor_range": {
                "min": min(f.floor for f in cluster["flats"] if f.floor),
                "max": max(f.floor for f in cluster["flats"] if f.floor)
            },
            "layout_key": cluster["layout_key"]
        })

    return {
        "message": f"üè¢ –í –ñ–ö '{building_name}' –Ω–∞—à—ë–ª {len(listings)} –∫–≤–∞—Ä—Ç–∏—Ä!\n\n"
                   f"–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º - –≤–æ—Ç {len(representatives)} —Ç–∏–ø–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:",
        "building_name": building_name,
        "total_flats": len(listings),
        "layout_clusters": representatives,
        "action": "show_clusters"
    }


def cluster_by_layout(listings: List) -> List[Dict]:
    """Cluster flats by similar layout."""

    clusters = {}

    for listing in listings:
        # –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
        layout_key = (
            listing.rooms,
            round(listing.area_total / 5) * 5,  # –û–∫—Ä—É–≥–ª—è–µ–º –ø–ª–æ—â–∞–¥—å –¥–æ 5–º¬≤
            listing.balcony_type,
            listing.bathroom_type
        )

        if layout_key not in clusters:
            clusters[layout_key] = {
                "layout_key": layout_key,
                "flats": []
            }

        clusters[layout_key]["flats"].append(listing)

    return list(clusters.values())
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–æ–¥–∏–Ω –ñ–ö, –º–Ω–æ–≥–æ –∫–≤–∞—Ä—Ç–∏—Ä):**
```
üè¢ –í –ñ–ö "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è" –Ω–∞—à—ë–ª 127 –∫–≤–∞—Ä—Ç–∏—Ä!

–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–ª –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º - –≤–æ—Ç 8 —Ç–∏–ø–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

üìê –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ 1 (47 –∫–≤–∞—Ä—Ç–∏—Ä)
   ‚Ä¢ 2 –∫–æ–º–Ω–∞—Ç—ã, 65 –º¬≤, –ª–æ–¥–∂–∏—è, —Ä–∞–∑–¥–µ–ª—å–Ω—ã–π —Å/—É
   ‚Ä¢ –≠—Ç–∞–∂–∏: —Å 3 –ø–æ 18
   ‚Ä¢ –¶–µ–Ω–∞: –æ—Ç 9.2 –¥–æ 11.8 –º–ª–Ω
   [ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã ]

üìê –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ 2 (38 –∫–≤–∞—Ä—Ç–∏—Ä)
   ‚Ä¢ 2 –∫–æ–º–Ω–∞—Ç—ã, 70 –º¬≤, –ª–æ–¥–∂–∏—è + –±–∞–ª–∫–æ–Ω, —Ä–∞–∑–¥–µ–ª—å–Ω—ã–π —Å/—É
   ‚Ä¢ –≠—Ç–∞–∂–∏: —Å 2 –ø–æ 16
   ‚Ä¢ –¶–µ–Ω–∞: –æ—Ç 10.1 –¥–æ 12.5 –º–ª–Ω
   [ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã ]

üìê –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ 3 (22 –∫–≤–∞—Ä—Ç–∏—Ä—ã)
   ‚Ä¢ 2 –∫–æ–º–Ω–∞—Ç—ã, 60 –º¬≤, –ª–æ–¥–∂–∏—è, —Å–æ–≤–º–µ—â—ë–Ω–Ω—ã–π —Å/—É
   ‚Ä¢ –≠—Ç–∞–∂–∏: —Å 4 –ø–æ 19
   ‚Ä¢ –¶–µ–Ω–∞: –æ—Ç 8.7 –¥–æ 10.9 –º–ª–Ω
   [ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã ]

...

üí° –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à—É—é—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É, –ø–æ–∫–∞–∂—É –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ñ–ö (5-15 –ñ–ö)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–¥—Ö–æ–¥–∏—Ç 5+ –ñ–ö, –≤ –∫–∞–∂–¥–æ–º –ø–æ 20-50 –∫–≤–∞—Ä—Ç–∏—Ä

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ñ–ö —Å –ª—É—á—à–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –∏–∑ –∫–∞–∂–¥–æ–≥–æ

```python
async def handle_multiple_buildings(listings: List, criteria: Dict, user_id: str) -> Dict:
    """Handle case with multiple suitable buildings."""

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ñ–ö
    by_building = {}
    for listing in listings:
        building = listing.building_name or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
        if building not in by_building:
            by_building[building] = []
        by_building[building].append(listing)

    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ñ–ö –±–µ—Ä—ë–º —Ç–æ–ø-3 –∫–≤–∞—Ä—Ç–∏—Ä—ã
    building_summaries = []
    client = await property_service.get_client_by_telegram_id(user_id)

    for building_name, flats in by_building.items():
        # –†–∞–Ω–∂–∏—Ä—É–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ —ç—Ç–æ–º –ñ–ö
        ranked = property_scoring_service.rank_listings(
            [f.dict() for f in flats],
            client.dict() if client else {},
            top_n=3
        )

        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ñ–ö
        prices = [f.price for f in flats]
        building_summaries.append({
            "building_name": building_name,
            "total_flats": len(flats),
            "price_range": {"min": min(prices), "max": max(prices)},
            "top_3": ranked[:3],
            "avg_dream_score": sum(r["dream_score"] for r in ranked[:3]) / 3,

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ –æ –ñ–ö
            "developer": flats[0].developer_name,
            "building_type": flats[0].building_type,
            "metro_distance": flats[0].metro_distance_minutes,
            "handover_date": f"{flats[0].ready_quarter}Q {flats[0].building_year}" if flats[0].ready_quarter else None,
            "advantages": flats[0].complex_advantages or [],
        })

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ñ–ö –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É Dream Score
    building_summaries.sort(key=lambda x: x["avg_dream_score"], reverse=True)

    return {
        "message": f"üèò –ù–∞—à—ë–ª {len(by_building)} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ñ–ö!\n\n"
                   f"–°—Ä–∞–≤–Ω–∏–≤–∞—é –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ:",
        "total_buildings": len(by_building),
        "building_summaries": building_summaries,
        "action": "compare_buildings"
    }
```

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ñ–ö):**
```
üèò –ù–∞—à—ë–ª 7 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ñ–ö!

–°—Ä–∞–≤–Ω–∏–≤–∞—é –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ –∫–∞–∂–¥–æ–≥–æ:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚≠ê 1. –ñ–ö "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è" (87 –∫–≤–∞—Ä—Ç–∏—Ä)
Dream Score: 78/100

–¢–æ–ø –≤–∞—Ä–∏–∞–Ω—Ç: 2 –∫–æ–º–Ω, 65 –º¬≤, 9.2 –º–ª–Ω
‚úì –ö–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π, —Å–¥–∞–Ω
‚úì –ú–µ—Ç—Ä–æ –ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π - 10 –º–∏–Ω –ø–µ—à–∫–æ–º
‚úì –ß–∏—Å—Ç–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞
‚úì –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 7 –±–∞–Ω–∫–æ–≤, —Ä–∞—Å—Å—Ä–æ—á–∫–∞

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ñ–ö:
‚Ä¢ –ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è
‚Ä¢ –ü–æ–¥–∑–µ–º–Ω—ã–π –ø–∞—Ä–∫–∏–Ω–≥
‚Ä¢ –î–µ—Ç—Å–∫–∏–π —Å–∞–¥ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏

[ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ 87 –∫–≤–∞—Ä—Ç–∏—Ä ]  [ –°—Ä–∞–≤–Ω–∏—Ç—å ]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚≠ê 2. –ñ–ö "NEXT" (64 –∫–≤–∞—Ä—Ç–∏—Ä—ã)
Dream Score: 75/100

–¢–æ–ø –≤–∞—Ä–∏–∞–Ω—Ç: 2 –∫–æ–º–Ω, 70 –º¬≤, 10.5 –º–ª–Ω
‚úì –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π, —Å–¥–∞–Ω
‚úì –ú–µ—Ç—Ä–æ –í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∞—è - 10 –º–∏–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
‚úì –ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ (–¥–µ—à–µ–≤–ª–µ!)
‚úì –ò–ø–æ—Ç–µ–∫–∞, —Ä–∞—Å—Å—Ä–æ—á–∫–∞, –º–∞—Ç.–∫–∞–ø–∏—Ç–∞–ª

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ñ–ö:
‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è
‚Ä¢ –í–∏–¥–æ–≤—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã
‚Ä¢ –ü–∞—Ä–∫ —Ä—è–¥–æ–º

[ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ 64 –∫–≤–∞—Ä—Ç–∏—Ä—ã ]  [ –°—Ä–∞–≤–Ω–∏—Ç—å ]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

...

üí° –í—ã–±–µ—Ä–∏—Ç–µ –ñ–ö –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ
```

---

## –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —É—Å–ª–æ–≤–∏—è

### –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö

–í—Å–µ –¥–∞–Ω–Ω—ã–µ **–µ—Å—Ç—å –≤ XML-—Ñ–∏–¥–µ**! –í –Ω–∞—à–µ–º feed_mapper —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ä—Å–∏–Ω–≥:

#### 1. –ò–ø–æ—Ç–µ–∫–∞ –∏ –±–∞–Ω–∫–∏

**–ò–∑ —Ñ–∏–¥–∞:**
```xml
<mortgage>true</mortgage>
<approved-banks>
  <bank>–°–±–µ—Ä–±–∞–Ω–∫</bank>
  <bank>–í–¢–ë</bank>
  <bank>–ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫</bank>
  <bank>–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</bank>
  ...
</approved-banks>
```

**–ú–∞–ø–ø–∏–Ω–≥:**
```python
listing.mortgage_available = True  # <mortgage>
listing.approved_banks = ["–°–±–µ—Ä–±–∞–Ω–∫", "–í–¢–ë", "–ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫", ...]
```

#### 2. –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (—Ä–∞—Å—Å—Ä–æ—á–∫–∞, –º–∞—Ç.–∫–∞–ø–∏—Ç–∞–ª)

**–ò–∑ —Ñ–∏–¥–∞:**
```xml
<payment-methods>
  <payment-method>–ò–ø–æ—Ç–µ–∫–∞</payment-method>
  <payment-method>–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª</payment-method>
  <payment-method>–†–∞—Å—Å—Ä–æ—á–∫–∞</payment-method>
</payment-methods>
```

**–ú–∞–ø–ø–∏–Ω–≥:**
```python
listing.payment_methods = ["–ò–ø–æ—Ç–µ–∫–∞", "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª", "–†–∞—Å—Å—Ä–æ—á–∫–∞"]
```

#### 3. –¢–æ—Ä–≥

**–ò–∑ —Ñ–∏–¥–∞:**
```xml
<haggle>true</haggle>
```

**–ú–∞–ø–ø–∏–Ω–≥:**
```python
listing.haggle_allowed = True
```

### –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è

#### –í –∫–∞—Ä—Ç–æ—á–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã:

```python
def format_listing_card(listing: PropertyListingResponse) -> str:
    """Format listing card with financial info."""

    card = f"""
üè† {listing.title}
üí∞ {format_price(listing.price)} —Ä—É–±.

üìä –ü–ª–æ—â–∞–¥—å: {listing.area_total} –º¬≤
üè¢ –≠—Ç–∞–∂: {listing.floor} –∏–∑ {listing.floors_total}
üìç {listing.district}, {listing.metro_station} ({listing.metro_distance_minutes} –º–∏–Ω)

üí≥ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è:
"""

    # –ò–ø–æ—Ç–µ–∫–∞
    if listing.mortgage_available:
        if listing.approved_banks:
            banks_str = ", ".join(listing.approved_banks[:3])
            if len(listing.approved_banks) > 3:
                banks_str += f" –∏ –µ—â—ë {len(listing.approved_banks) - 3}"
            card += f"‚úì –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç {len(listing.approved_banks)} –±–∞–Ω–∫–æ–≤ ({banks_str})\n"
        else:
            card += "‚úì –ò–ø–æ—Ç–µ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞\n"

    # –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
    if listing.payment_methods:
        for method in listing.payment_methods:
            if method == "–†–∞—Å—Å—Ä–æ—á–∫–∞":
                card += "‚úì –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞\n"
            elif method == "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª":
                card += "‚úì –ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª\n"

    # –¢–æ—Ä–≥
    if listing.haggle_allowed:
        card += "‚úì –í–æ–∑–º–æ–∂–µ–Ω —Ç–æ—Ä–≥\n"

    # –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫
    if listing.developer_name:
        card += f"\nüèó –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫: {listing.developer_name}\n"

    return card
```

**–ü—Ä–∏–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏:**
```
üè† 2-–∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞, 65 –º¬≤ –≤ –ñ–ö "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è"
üí∞ 9 200 000 —Ä—É–±.

üìä –ü–ª–æ—â–∞–¥—å: 65 –º¬≤
üè¢ –≠—Ç–∞–∂: 5 –∏–∑ 18
üìç –ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π, –ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π –æ—Å—Ç—Ä–æ–≤ (10 –º–∏–Ω –ø–µ—à–∫–æ–º)

üí≥ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è:
‚úì –ò–ø–æ—Ç–µ–∫–∞ –æ—Ç 7 –±–∞–Ω–∫–æ–≤ (–°–±–µ—Ä–±–∞–Ω–∫, –í–¢–ë, –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫ –∏ –µ—â—ë 4)
‚úì –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞
‚úì –ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª
‚úì –í–æ–∑–º–æ–∂–µ–Ω —Ç–æ—Ä–≥

üèó –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫: –ì–ö –ü–ò–ö
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º

```python
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —è–≤–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å
"–¢–æ–ª—å–∫–æ —Å –∏–ø–æ—Ç–µ–∫–æ–π"          ‚Üí mortgage_required=True
"–° —Ä–∞—Å—Å—Ä–æ—á–∫–æ–π –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞" ‚Üí payment_methods contains "–†–∞—Å—Å—Ä–æ—á–∫–∞"
"–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª"        ‚Üí payment_methods contains "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª"
"–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ"   ‚Üí approved_banks contains "–°–±–µ—Ä–±–∞–Ω–∫"
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
User: "–î–≤—É—à–∫–∞ –¥–æ 10 –º–ª–Ω –≤ –ë—É—Ç–æ–≤–æ, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å —Ä–∞—Å—Å—Ä–æ—á–∫–æ–π"

–ë–æ—Ç –∏–∑–≤–ª–µ–∫–∞–µ—Ç:
{
  "budget_max": 10000000,
  "rooms_min": 2,
  "rooms_max": 2,
  "districts": ["–ë—É—Ç–æ–≤–æ"],
  "payment_methods": ["–†–∞—Å—Å—Ä–æ—á–∫–∞"]  ‚Üê –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
}

–ü–æ–∏—Å–∫:
SELECT * FROM property_listings
WHERE price <= 10000000
  AND rooms = 2
  AND district LIKE '%–ë—É—Ç–æ–≤–æ%'
  AND payment_methods @> '["–†–∞—Å—Å—Ä–æ—á–∫–∞"]'  ‚Üê PostgreSQL JSONB contains
```

---

## –£–º–Ω–æ–µ —Å—É–∂–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∫–∏

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤

–ö–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–Ω–æ–≥–æ (200+), –∑–∞–¥–∞—ë–º –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ:

```python
NARROWING_PRIORITY = [
    # 1. –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ - –ñ–ö (–µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ)
    {
        "condition": lambda analysis: analysis["unique_buildings"] > 15,
        "question_type": "building_selection",
        "impact": "high",  # –°—Ä–∞–∑—É —Å–æ–∫—Ä–∞—Ç–∏—Ç –≤—ã–±–æ—Ä–∫—É –≤ 5-10 —Ä–∞–∑
    },

    # 2. –†–µ–º–æ–Ω—Ç (—Å–∏–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–µ–Ω—É)
    {
        "condition": lambda analysis: analysis["renovations"] > 2,
        "question_type": "renovation",
        "impact": "high",  # –†–∞–∑–Ω–∏—Ü–∞ –≤ —Ü–µ–Ω–µ 15-20%
    },

    # 3. –î–∞—Ç–∞ —Å–¥–∞—á–∏ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
    {
        "condition": lambda analysis: analysis["handover_dates_spread"] > 8,
        "question_type": "handover_date",
        "impact": "medium",  # –°–æ–∫—Ä–∞—Ç–∏—Ç –Ω–∞ 30-50%
    },

    # 4. –¢–∏–ø –∑–¥–∞–Ω–∏—è (–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ)
    {
        "condition": lambda analysis: analysis["building_types"] > 2,
        "question_type": "building_type",
        "impact": "medium",
    },

    # 5. –≠—Ç–∞–∂ (–ª–∏—á–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)
    {
        "condition": lambda analysis: analysis["floor_spread"] > 10,
        "question_type": "floor_preference",
        "impact": "low",  # –°–æ–∫—Ä–∞—Ç–∏—Ç –Ω–∞ 20-30%
    },

    # 6. –§–∏–Ω–∞–Ω—Å—ã (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ —Ä–∞–Ω–µ–µ)
    {
        "condition": lambda criteria: not criteria.get("mortgage_required"),
        "question_type": "financial",
        "impact": "medium",
    },
]
```

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞

```python
# –í telegram_handler.py

def create_narrowing_keyboard(question_type: str, options: List) -> InlineKeyboardMarkup:
    """Create interactive keyboard for narrowing."""

    keyboard = []

    if question_type == "building_selection":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5 –ñ–ö
        for building in options[:5]:
            keyboard.append([
                InlineKeyboardButton(
                    text=f"üè¢ {building['name']} ({building['count']} –∫–≤–∞—Ä—Ç–∏—Ä)",
                    callback_data=f"building:{building['id']}"
                )
            ])
        keyboard.append([
            InlineKeyboardButton("üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ñ–ö", callback_data="buildings:all")
        ])

    elif question_type == "renovation":
        keyboard.append([
            InlineKeyboardButton("–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏", callback_data="reno:none"),
            InlineKeyboardButton("–ß–µ—Ä–Ω–æ–≤–∞—è", callback_data="reno:rough"),
        ])
        keyboard.append([
            InlineKeyboardButton("–ß–∏—Å—Ç–æ–≤–∞—è", callback_data="reno:clean"),
            InlineKeyboardButton("–ü–æ–¥ –∫–ª—é—á", callback_data="reno:turnkey"),
        ])
        keyboard.append([
            InlineKeyboardButton("–õ—é–±–∞—è", callback_data="reno:any"),
        ])

    elif question_type == "handover_date":
        keyboard.append([
            InlineKeyboardButton("–£–∂–µ —Å–¥–∞–Ω", callback_data="date:ready"),
            InlineKeyboardButton("2025", callback_data="date:2025"),
        ])
        keyboard.append([
            InlineKeyboardButton("2026", callback_data="date:2026"),
            InlineKeyboardButton("–ù–µ –≤–∞–∂–Ω–æ", callback_data="date:any"),
        ])

    return InlineKeyboardMarkup(keyboard)
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ

```python
class NarrowingSession:
    """Track narrowing session state."""

    def __init__(self, user_id: str, initial_criteria: Dict, initial_count: int):
        self.user_id = user_id
        self.criteria = initial_criteria.copy()
        self.history = [{
            "step": 0,
            "criteria": initial_criteria,
            "count": initial_count
        }]
        self.current_step = 0

    async def apply_filter(self, filter_type: str, value: Any) -> Dict:
        """Apply filter and recalculate results."""

        # –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏
        if filter_type == "building":
            self.criteria["building_name"] = value
        elif filter_type == "renovation":
            if value != "any":
                self.criteria["preferred_renovations"] = [value]
        elif filter_type == "handover_date":
            if value == "ready":
                self.criteria["building_state"] = "hand-over"
            elif value != "any":
                self.criteria["handover_year_max"] = int(value)

        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        new_results = await property_service.search_listings(**self.criteria, limit=500)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.current_step += 1
        self.history.append({
            "step": self.current_step,
            "filter_applied": {filter_type: value},
            "criteria": self.criteria.copy(),
            "count": len(new_results)
        })

        return {
            "new_count": len(new_results),
            "previous_count": self.history[-2]["count"],
            "reduction": self.history[-2]["count"] - len(new_results),
            "listings": new_results
        }

    async def undo_last_filter(self) -> Dict:
        """Undo last applied filter."""
        if self.current_step == 0:
            return {"error": "Nothing to undo"}

        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥
        self.history.pop()
        self.current_step -= 1
        self.criteria = self.history[-1]["criteria"].copy()

        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
        results = await property_service.search_listings(**self.criteria, limit=500)

        return {
            "reverted_to_step": self.current_step,
            "count": len(results),
            "listings": results
        }
```

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ —É—Ç–æ—á–Ω–µ–Ω–∏—è:**
```
–®–∞–≥ 0: 347 –∫–≤–∞—Ä—Ç–∏—Ä (–º–Ω–æ–≥–æ)
  ‚Üì –í—ã–±—Ä–∞–ª –ñ–ö "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è"
–®–∞–≥ 1: 87 –∫–≤–∞—Ä—Ç–∏—Ä (–≤—Å—ë –µ—â—ë –º–Ω–æ–≥–æ)
  ‚Üì –í—ã–±—Ä–∞–ª "–ß–∏—Å—Ç–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞"
–®–∞–≥ 2: 34 –∫–≤–∞—Ä—Ç–∏—Ä—ã (–Ω–æ—Ä–º)
  ‚Üì –í—ã–±—Ä–∞–ª "–ù–µ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–∂"
–®–∞–≥ 3: 28 –∫–≤–∞—Ä—Ç–∏—Ä (–æ—Ç–ª–∏—á–Ω–æ!)
  ‚Üí –†–∞–Ω–∂–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-12
```

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ system prompt –¥–ª—è LLM-–∞–≥–µ–Ω—Ç–∞

–î–æ–±–∞–≤–ª—è–µ–º –≤ [app/services/property/llm_agent_property.py](app/services/property/llm_agent_property.py):

```python
def _get_enhanced_system_prompt(self, language: str) -> str:
    """Enhanced system prompt with financial and narrowing context."""

    if language == "ru":
        return """–¢—ã - AI-–∞–≥–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫).

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ–∫–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—É–∑–∏—Ç—å –≤—ã–±–æ—Ä.

**–§–ò–ù–ê–ù–°–û–í–´–ï –£–°–õ–û–í–ò–Ø** (–∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤):
- "—Å –∏–ø–æ—Ç–µ–∫–æ–π" ‚Üí mortgage_required: true
- "—Ä–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞" ‚Üí payment_methods: ["–†–∞—Å—Å—Ä–æ—á–∫–∞"]
- "–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª" ‚Üí payment_methods: ["–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª"]
- "–∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –≤ –°–±–µ—Ä–±–∞–Ω–∫–µ" ‚Üí approved_banks: ["–°–±–µ—Ä–±–∞–Ω–∫"]
- "–≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ—Ä–≥" ‚Üí haggle_required: true

**–£–ú–ù–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ–±—â–µ–µ ("–∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –ú–æ—Å–∫–≤–µ –¥–æ 15 –º–ª–Ω") - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!
–ù–ï —Ç—Ä–µ–±—É–π —Å—Ä–∞–∑—É –≤—Å–µ –¥–µ—Ç–∞–ª–∏. –ù–∞—á–Ω–∏ –ø–æ–∏—Å–∫ —Å must-have, –ø–æ—Ç–æ–º —É—Ç–æ—á–Ω–∏.

Must-have –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:
1. –ë—é–¥–∂–µ—Ç (—Ö–æ—Ç—è –±—ã budget_max)
2. –ö–æ–º–Ω–∞—Ç—ã (rooms_min/max)
3. –õ–æ–∫–∞—Ü–∏—è (districts –ò–õ–ò metro_stations)

Nice-to-have (—Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ü–û–°–õ–ï –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –º–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤):
- –¢–∏–ø –∑–¥–∞–Ω–∏—è (building_types)
- –†–µ–º–æ–Ω—Ç (renovations)
- –î–∞—Ç–∞ —Å–¥–∞—á–∏ (handover_year)
- –≠—Ç–∞–∂ (floor preferences)
- –õ–∏—Ñ—Ç, –±–∞–ª–∫–æ–Ω –∏ —Ç.–¥.

**–ü–†–ò–ú–ï–†–´ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**

1. "–î–≤—É—à–∫–∞ –¥–æ 12 –º–ª–Ω –≤ –ë—É—Ç–æ–≤–æ"
   ‚Üí {criteria: {budget_max: 12000000, rooms: 2, districts: ["–ë—É—Ç–æ–≤–æ"]}}
   ‚Üí –•–í–ê–¢–ò–¢ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞! –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ.

2. "–ö–≤–∞—Ä—Ç–∏—Ä–∞ —Å –∏–ø–æ—Ç–µ–∫–æ–π, —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"
   ‚Üí {criteria: {mortgage_required: true, payment_methods: ["–†–∞—Å—Å—Ä–æ—á–∫–∞"]}}

3. "–¢–æ–ª—å–∫–æ –ü–ò–ö, —Å–¥–∞—á–∞ –≤ —ç—Ç–æ–º –≥–æ–¥—É"
   ‚Üí {criteria: {developers: ["–ì–ö –ü–ò–ö"], handover_year_max: 2025}}

**–°–¶–ï–ù–ê–†–ò–ô –£–¢–û–ß–ù–ï–ù–ò–Ø (–µ—Å–ª–∏ –Ω–∞—à–ª–æ—Å—å > 100 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤):**

Bot: "–ù–∞—à—ë–ª 200+ –∫–≤–∞—Ä—Ç–∏—Ä! –î–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω–∏–º:"
User: "–•–æ—á—É –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –¥–æ–º"
‚Üí {intent: "refine", add_filter: {building_types: ["–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π"]}}

User: "–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏, –¥–µ—à–µ–≤–ª–µ"
‚Üí {intent: "refine", add_filter: {renovations: ["–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏"]}}

User: "–ü–æ–∫–∞–∂–∏ —á—Ç–æ –µ—Å—Ç—å"
‚Üí {intent: "show_results"}  # –•–≤–∞—Ç–∏—Ç —É—Ç–æ—á–Ω—è—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø

–û—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
"""
```

---

## –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–∞

```
User: "–î–≤—É—à–∫–∞ –¥–æ 12 –º–ª–Ω –≤ –ë—É—Ç–æ–≤–æ"
  ‚Üì
LLM: Extract {budget_max: 12M, rooms: 2, district: "–ë—É—Ç–æ–≤–æ"}
  ‚Üì
Search: 347 results (TOO MANY)
  ‚Üì
Bot: "–ù–∞—à—ë–ª 347 –∫–≤–∞—Ä—Ç–∏—Ä! –£—Ç–æ—á–Ω–∏–º:"
     1. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø-5 –ñ–ö?
     2. –ö–∞–∫–æ–π —Ä–µ–º–æ–Ω—Ç?
     3. –ö–æ–≥–¥–∞ —Å–¥–∞—á–∞?
  ‚Üì
User: [Clicks "–ñ–ö –ü—Ä–∏–≤–∏–ª–µ–≥–∏—è"]
  ‚Üì
Narrow: building_name = "–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è"
  ‚Üì
Search: 87 results (STILL MANY)
  ‚Üì
Bot: "87 –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ñ–ö –ü—Ä–∏–≤–∏–ª–µ–≥–∏—è. –£—Ç–æ—á–Ω–∏–º:"
     1. –¢–∏–ø –æ—Ç–¥–µ–ª–∫–∏?
     2. –≠—Ç–∞–∂?
  ‚Üì
User: "–ß–∏—Å—Ç–æ–≤–∞—è –æ—Ç–¥–µ–ª–∫–∞"
  ‚Üì
Narrow: renovation = "–ß–∏—Å—Ç–æ–≤–∞—è"
  ‚Üì
Search: 34 results (GOOD!)
  ‚Üì
Bot: "–û—Ç–ª–∏—á–Ω–æ! –ù–∞—à—ë–ª 34 –≤–∞—Ä–∏–∞–Ω—Ç–∞."
     [Shows top 12 ranked by Dream Score]
  ‚Üì
User: [Views, likes, comments]
  ‚Üì
Bot: [Updates taste_weights, re-ranks]
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –¥–∏–∞–ª–æ–≥–∞

### –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–π
- **–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ç–æ—á–Ω–µ–Ω–∏–π –¥–æ –ø–æ–∫–∞–∑–∞**: ‚â§ 3
- **–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤ –æ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π**: < 10%
- **–í—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞**: ‚â§ 2 –º–∏–Ω—É—Ç—ã

### –ö–∞—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **–¢–æ—á–Ω–æ—Å—Ç—å must-have —Ñ–∏–ª—å—Ç—Ä–æ–≤**: 100% (—Å—Ç—Ä–æ–≥–∏–µ)
- **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ç–æ–ø-12**: ‚â• 60% –ª–∞–π–∫–æ–≤
- **–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤ —Ç–æ–ø–µ**: –º–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–Ω—ã—Ö –ñ–ö (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
- **–ü–æ–∫–∞–∑ —É—Å–ª–æ–≤–∏–π –∏–ø–æ—Ç–µ–∫–∏**: 100% –∫–∞—Ä—Ç–æ—á–µ–∫ —Å mortgage_available
- **–í–∏–¥–∏–º–æ—Å—Ç—å –±–∞–Ω–∫–æ–≤**: —Ç–æ–ø-3 –∏–∑ approved_banks
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ**: —è–≤–Ω–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ

---

–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –ø–æ–∫–∞–∑–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. üéØ
