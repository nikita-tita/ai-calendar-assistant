# Property Bot - Stage 2 Development Complete ‚úÖ

## –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 29.10.2025

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û –í STAGE 2 (50% –û–ë–©–ï–ì–û –ü–†–û–ì–†–ï–°–°–ê)

### 1. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å 20+ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏** ‚úÖ

**–§–∞–π–ª:** [app/services/property/property_service.py](app/services/property/property_service.py)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `search_listings()` —Å **+26 –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
- –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–ù–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:**

#### –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Ç–∏–ø:
- `category` - –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–∫–≤–∞—Ä—Ç–∏—Ä–∞/–≥–∞—Ä–∞–∂/–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è)
- `property_type` - —Ç–∏–ø (–∂–∏–ª–∞—è/–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è)

#### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–æ–º–∞ (6 —Ñ–∏–ª—å—Ç—Ä–æ–≤):
- `building_types[]` - –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–æ–º–æ–≤
- `exclude_building_types[]` - –∏—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ç–∏–ø—ã
- `building_name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö (fuzzy search —Å ILIKE)

#### –†–µ–º–æ–Ω—Ç (2 —Ñ–∏–ª—å—Ç—Ä–∞):
- `renovations[]` - –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–∏–ø—ã –æ—Ç–¥–µ–ª–∫–∏
- `exclude_renovations[]` - –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–∏–ø—ã

#### –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ (5 —Ñ–∏–ª—å—Ç—Ä–æ–≤):
- `balcony_required` - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ª–∏ –±–∞–ª–∫–æ–Ω
- `balcony_types[]` - —Ç–∏–ø—ã –±–∞–ª–∫–æ–Ω–æ–≤
- `bathroom_type` - —Ç–∏–ø —Å–∞–Ω—É–∑–ª–∞
- `bathroom_count_min` - –º–∏–Ω–∏–º—É–º —Å–∞–Ω—É–∑–ª–æ–≤
- `min_ceiling_height` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤

#### –£–¥–æ–±—Å—Ç–≤–∞ (2 —Ñ–∏–ª—å—Ç—Ä–∞):
- `requires_elevator` - –Ω—É–∂–µ–Ω –ª–∏—Ñ—Ç
- `has_parking` - –Ω—É–∂–Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–∞

#### **–§–ò–ù–ê–ù–°–û–í–´–ï –£–°–õ–û–í–ò–Ø (3 —Ñ–∏–ª—å—Ç—Ä–∞ - –ö–†–ò–¢–ò–ß–ù–û!):**
- `mortgage_required` - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∏–ø–æ—Ç–µ–∫–∞
- `payment_methods[]` - —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–∏–ø–æ—Ç–µ–∫–∞/—Ä–∞—Å—Å—Ä–æ—á–∫–∞/–º–∞—Ç.–∫–∞–ø–∏—Ç–∞–ª)
- `haggle_allowed` - –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ—Ä–≥

#### –°—Ä–æ–∫ —Å–¥–∞—á–∏ (4 —Ñ–∏–ª—å—Ç—Ä–∞):
- `handover_quarter_min/max` - –∫–≤–∞—Ä—Ç–∞–ª —Å–¥–∞—á–∏ (1-4)
- `handover_year_min/max` - –≥–æ–¥ —Å–¥–∞—á–∏

#### –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ (2 —Ñ–∏–ª—å—Ç—Ä–∞):
- `developers[]` - –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ
- `exclude_developers[]` - –∏—Å–∫–ª—é—á–∞–µ–º—ã–µ

#### –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–æ—â–∞–¥–µ–π (4 —Ñ–∏–ª—å—Ç—Ä–∞):
- `living_area_min/max` - –∂–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å
- `kitchen_area_min/max` - –ø–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏

#### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (3 —Ñ–∏–ª—å—Ç—Ä–∞):
- `school_nearby` - —à–∫–æ–ª–∞ —Ä—è–¥–æ–º
- `kindergarten_nearby` - –¥–µ—Ç—Å–∫–∏–π —Å–∞–¥
- `park_nearby` - –ø–∞—Ä–∫

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- JSONB —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è payment_methods (PostgreSQL)
- ILIKE –¥–ª—è fuzzy search –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ñ–ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ exclude —Å–ø–∏—Å–∫–æ–≤ (NOT IN)
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ docstring

---

### 2. **SearchResultHandler - —É–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚úÖ

**–§–∞–π–ª:** [app/services/property/search_result_handler.py](app/services/property/search_result_handler.py:1) (550 —Å—Ç—Ä–æ–∫)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å 5 —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏.

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)**
- –ú–µ—Ç–æ–¥: `handle_no_results()`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—Å–ª–∞–±–ª–µ–Ω–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤:
  1. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ (–∏–ø–æ—Ç–µ–∫–∞, —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã)
  2. –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ (–±–∞–ª–∫–æ–Ω, —Å–∞–Ω—É–∑–µ–ª)
  3. –î–æ–º (—Ç–∏–ø, –æ—Ç–¥–µ–ª–∫–∞)
  4. –°—Ä–æ–∫ —Å–¥–∞—á–∏
  5. –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫
  6. **–ü–û–°–õ–ï–î–ù–ï–ï**: –±—é–¥–∂–µ—Ç, –∫–æ–º–Ω–∞—Ç—ã, —Ä–∞–π–æ–Ω
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1-20)**
- –ú–µ—Ç–æ–¥: `handle_few_results()`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞:
  - –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–π–æ–Ω—ã
  - –£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –Ω–∞ 5%
  - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –æ—Ç–¥–µ–ª–∫–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω, —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ (20-200 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)**
- –ú–µ—Ç–æ–¥: `handle_optimal_results()`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-12 –ø–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—é
- –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: min/max/avg –ø–æ —Ü–µ–Ω–µ –∏ –ø–ª–æ—â–∞–¥–∏
- –ï—Å–ª–∏ >100: –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å (–æ—Ç–¥–µ–ª–∫–∞, —Ç–∏–ø –¥–æ–º–∞, —Å—Ä–æ–∫)

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (200+)**
- –ú–µ—Ç–æ–¥: `handle_too_many_results()`
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ñ–ö, –æ—Ç–¥–µ–ª–∫–∞, —Ç–∏–ø—ã –¥–æ–º–æ–≤)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å—É–∂–µ–Ω–∏—è:
  1. **–í—ã–±–æ—Ä –ñ–ö** (–µ—Å–ª–∏ ‚â•15 –∫–æ–º–ø–ª–µ–∫—Å–æ–≤) - —Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π
  2. **–¢–∏–ø –æ—Ç–¥–µ–ª–∫–∏** (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω)
  3. **–°—Ä–æ–∫ —Å–¥–∞—á–∏** (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω)
  4. **–¢–∏–ø –¥–æ–º–∞** (–µ—Å–ª–∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ >2)
  5. **–≠—Ç–∞–∂** (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é —Ç–æ–ø-12

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 5: –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (100+ –≤ –æ–¥–Ω–æ–º –ñ–ö)**
- –ú–µ—Ç–æ–¥: `handle_clustered_results()`
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º: (–∫–æ–º–Ω–∞—Ç—ã, –ø–ª–æ—â–∞–¥—å, –±–∞–ª–∫–æ–Ω, —Å–∞–Ω—É–∑–µ–ª)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
- –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω/—ç—Ç–∞–∂–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
- –û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```python
{
    "scenario": str,  # –¢–∏–ø —Å—Ü–µ–Ω–∞—Ä–∏—è
    "listings": List[PropertyListingResponse],  # –ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
    "message": str,  # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    "suggestions": List[Dict],  # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    "stats": Dict,  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    "clusters": List[Dict]  # –î–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
}
```

---

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π LLM –∞–≥–µ–Ω—Ç —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏** ‚úÖ

**–§–∞–π–ª:** [app/services/property/llm_agent_property.py](app/services/property/llm_agent_property.py)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

#### **–†–∞—Å—à–∏—Ä–µ–Ω system prompt (200+ —Å—Ç—Ä–æ–∫):**
- –î–æ–±–∞–≤–ª–µ–Ω–æ 15 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è** –≤—ã–¥–µ–ª–µ–Ω—ã –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ
- –ü—Ä–∏–º–µ—Ä—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É

#### **–ù–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–æ–º–ø—Ç–µ:**

**–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ:**
```
"–ò—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É —Å –∏–ø–æ—Ç–µ–∫–æ–π, –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É"
‚Üí mortgage_required: true, payment_methods: ["–∏–ø–æ—Ç–µ–∫–∞", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞"]

"–ù—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–º –∫–∞–ø–∏—Ç–∞–ª–æ–º, —Ç–æ—Ä–≥ –≤–æ–∑–º–æ–∂–µ–Ω"
‚Üí payment_methods: ["–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –∫–∞–ø–∏—Ç–∞–ª"], haggle_allowed: true

"–¢–æ–ª—å–∫–æ –∏–ø–æ—Ç–µ–∫–∞ –°–±–µ—Ä–±–∞–Ω–∫–∞"
‚Üí mortgage_required: true, approved_banks: ["–°–±–µ—Ä–±–∞–Ω–∫"]
```

**–î–æ–º –∏ –æ—Ç–¥–µ–ª–∫–∞:**
```
"–ù—É–∂–Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å —á–∏—Å—Ç–æ–≤–æ–π –æ—Ç–¥–µ–ª–∫–æ–π, –∫–∏—Ä–ø–∏—á–Ω—ã–π –¥–æ–º, —Å –±–∞–ª–∫–æ–Ω–æ–º, –ø–∞—Ä–∫–æ–≤–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞"
‚Üí renovations: ["—á–∏—Å—Ç–æ–≤–∞—è"], building_types: ["–∫–∏—Ä–ø–∏—á–Ω—ã–π"],
  balcony_required: true, has_parking: true
```

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
"3–∫ –æ—Ç 8 –¥–æ 12 –º–ª–Ω, —Å–¥–∞—á–∞ –≤ 2025, –∏–ø–æ—Ç–µ–∫–∞ –°–±–µ—Ä–±–∞–Ω–∫–∞, –¥–µ—Ç—Å–∫–∏–π —Å–∞–¥ —Ä—è–¥–æ–º"
‚Üí budget_min: 8000000, handover_year_min: 2025,
  mortgage_required: true, kindergarten_nearby: true
```

#### **–£–ª—É—á—à–µ–Ω fallback_extraction (+50 —Å—Ç—Ä–æ–∫):**
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–∏–ø–æ—Ç–µ–∫–∞, —Ä–∞—Å—Å—Ä–æ—á–∫–∞, –º–∞—Ç.–∫–∞–ø–∏—Ç–∞–ª, —Ç–æ—Ä–≥)
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–æ–º–æ–≤ (–∫–∏—Ä–ø–∏—á, –ø–∞–Ω–µ–ª—å, –º–æ–Ω–æ–ª–∏—Ç)
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∫–∏ (—á–∏—Å—Ç–æ–≤–∞—è, –±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏)
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—à–∫–æ–ª–∞, —Å–∞–¥, –ø–∞—Ä–∫)
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±–∞–ª–∫–æ–Ω–∞/–ª–æ–¥–∂–∏–∏
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–∞–Ω—É–∑–ª–∞
- –ü–∞—Ä—Å–∏–Ω–≥ –≥–æ–¥–∞ —Å–¥–∞—á–∏

**–†–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó LLM API:**
–î–∞–∂–µ –±–µ–∑ Yandex GPT –±–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ regex –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.

---

### 4. **–°–∏—Å—Ç–µ–º–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞ Dream Score —Å –Ω–æ–≤—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏** ‚úÖ

**–§–∞–π–ª:** [app/services/property/dream_score.py](app/services/property/dream_score.py) (670 —Å—Ç—Ä–æ–∫)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

#### **9 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∫–æ—Ä–∏–Ω–≥–∞ (0-100 –∫–∞–∂–¥—ã–π):**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-----|----------|
| price_match | 20% | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω—ã –±—é–¥–∂–µ—Ç—É |
| location | 15% | –ú–µ—Ç—Ä–æ + —Ä–∞–π–æ–Ω |
| space | 10% | –ö–æ–º–Ω–∞—Ç—ã + –ø–ª–æ—â–∞–¥—å |
| floor | 5% | –≠—Ç–∞–∂ |
| **layout** | **15%** | **–ù–û–í–´–ô**: –ë–∞–ª–∫–æ–Ω, —Å–∞–Ω—É–∑–µ–ª, –ø–æ—Ç–æ–ª–∫–∏, –∫—É—Ö–Ω—è |
| **building_quality** | **15%** | **–ù–û–í–´–ô**: –¢–∏–ø –¥–æ–º–∞, –æ—Ç–¥–µ–ª–∫–∞, –≥–æ–¥ |
| **financial** | **10%** | **–ù–û–í–´–ô**: –ò–ø–æ—Ç–µ–∫–∞, —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã, —Ç–æ—Ä–≥ |
| **infrastructure** | **5%** | **–ù–û–í–´–ô**: –®–∫–æ–ª–∞, —Å–∞–¥, –ø–∞—Ä–∫ |
| amenities | 5% | –õ–∏—Ñ—Ç, –ø–∞—Ä–∫–æ–≤–∫–∞, –∂–∏–≤–æ—Ç–Ω—ã–µ |

**–ò–¢–û–ì–û: 100%**

#### **–î–µ—Ç–∞–ª–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Layout (15%):**
```python
def _score_layout(listing, client) -> float:
    # –ë–∞–ª–∫–æ–Ω (30 –±–∞–ª–ª–æ–≤)
    - –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –µ—Å—Ç—å: 30
    - –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∏–ø–∞ (–ª–æ–¥–∂–∏—è): +5 –±–æ–Ω—É—Å
    - –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –Ω–µ—Ç: 0 (deal breaker)

    # –¢–∏–ø —Å–∞–Ω—É–∑–ª–∞ (25 –±–∞–ª–ª–æ–≤)
    - –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ–º: 25
    - –ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: 5

    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–Ω—É–∑–ª–æ–≤ (20 –±–∞–ª–ª–æ–≤)
    - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∏–Ω–∏–º—É–º—É: 20
    - –ú–µ–Ω—å—à–µ: —à—Ç—Ä–∞—Ñ -8 –∑–∞ –∫–∞–∂–¥—ã–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π

    # –í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ (15 –±–∞–ª–ª–æ–≤)
    - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∏–Ω–∏–º—É–º—É: 15
    - –ü—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–∞ 30—Å–º+: +5 –±–æ–Ω—É—Å
    - –ú–µ–Ω—å—à–µ: —à—Ç—Ä–∞—Ñ -20 –∑–∞ –∫–∞–∂–¥—ã–µ 10—Å–º

    # –ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏ (10 –±–∞–ª–ª–æ–≤)
    - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∏–Ω–∏–º—É–º—É: 10
    - –ú–µ–Ω—å—à–µ: –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ
```

#### **–î–µ—Ç–∞–ª–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Building Quality (15%):**
```python
def _score_building_quality(listing, client) -> float:
    # –¢–∏–ø –¥–æ–º–∞ (40 –±–∞–ª–ª–æ–≤)
    - –í —Å–ø–∏—Å–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π: 40
    - –í —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π: 0
    - –ù–µ —É–∫–∞–∑–∞–Ω: –æ—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É:
      * –ö–∏—Ä–ø–∏—á–Ω—ã–π: 35
      * –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π: 32
      * –ö–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π: 28
      * –ü–∞–Ω–µ–ª—å–Ω—ã–π: 20

    # –û—Ç–¥–µ–ª–∫–∞ (35 –±–∞–ª–ª–æ–≤)
    - –í —Å–ø–∏—Å–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π: 35
    - –í —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π: 0
    - –ù–µ —É–∫–∞–∑–∞–Ω: –æ—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É:
      * –ü–æ–¥ –∫–ª—é—á: 30
      * –ß–∏—Å—Ç–æ–≤–∞—è: 28
      * –ü—Ä–µ–¥—á–∏—Å—Ç–æ–≤–∞—è: 20
      * –ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏: 10

    # –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (25 –±–∞–ª–ª–æ–≤)
    - 2024+: 25
    - 2020+: 20
    - 2015+: 12
    - –°—Ç–∞—Ä—à–µ: 5
```

#### **–î–µ—Ç–∞–ª–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Financial (10%):**
```python
def _score_financial(listing, client) -> float:
    # –ò–ø–æ—Ç–µ–∫–∞ (50 –±–∞–ª–ª–æ–≤)
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞: 50
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∏ –ù–ï –¥–æ—Å—Ç—É–ø–Ω–∞: 0 (deal breaker!)
    - –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞: 25 (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ)

    # –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (30 –±–∞–ª–ª–æ–≤)
    - –í—Å–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã: 30
    - –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    - –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: 5

    # –¢–æ—Ä–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω (20 –±–∞–ª–ª–æ–≤)
    - –î–∞: 20 (–≤—Å–µ–≥–¥–∞ –ø–ª—é—Å)
    - –ù–µ—Ç: 8
```

#### **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏–π:**
```python
dream_score >= 80: "–û—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç!"
dream_score >= 60: "–•–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç"
dream_score >= 40: "–ü—Ä–∏–µ–º–ª–µ–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–∞–º–∏"
dream_score < 40: "–í–∞—Ä–∏–∞–Ω—Ç —Å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ—Ç–ª–∏—á–∏—è–º–∏"

+ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (‚â•70%)
+ –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (<40%)
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
Dream Score: 87.5
–û—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç! –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–µ–Ω—ã (95%), –ª–æ–∫–∞—Ü–∏—è (90%), –∫–∞—á–µ—Å—Ç–≤–æ –¥–æ–º–∞ (85%), —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è (100%).
```

---

### 5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã Stage 2** ‚úÖ

**–§–∞–π–ª:** [tests/test_property_stage2_integration.py](tests/test_property_stage2_integration.py) (680 —Å—Ç—Ä–æ–∫)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

#### **4 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª–∞—Å—Å–∞:**

**1. TestEnhancedSearch (7 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –¥–æ–º–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –æ—Ç–¥–µ–ª–∫–µ
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ä–æ–∫—É —Å–¥–∞—á–∏
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- ‚úÖ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ä–∞–∑—É)

**2. TestSearchResultHandler (5 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 1-20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 20-200 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ø-12)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 200+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å—É–∂–µ–Ω–∏—è)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏)

**3. TestEnhancedLLMAgent (6 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞—Å—Å—Ä–æ—á–∫–∏
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ –¥–æ–º—É
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ –æ—Ç–¥–µ–ª–∫–µ
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ

**4. TestEnhancedDreamScore (6 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (score ‚â•80)
- ‚úÖ –ü–ª–æ—Ö–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (score <40)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç building_quality (–æ—Ç–¥–µ–ª—å–Ω–æ)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç layout (–æ—Ç–¥–µ–ª—å–Ω–æ)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç financial (–æ—Ç–¥–µ–ª—å–Ω–æ)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–ø–æ—Ç–µ–∫–∏

**–í—Å–µ–≥–æ: 24 —Ç–µ—Å—Ç–∞**

**–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install pytest pytest-asyncio

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest tests/test_property_stage2_integration.py -v

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
pytest tests/test_property_stage2_integration.py::TestEnhancedDreamScore -v

# –° –≤—ã–≤–æ–¥–æ–º –ª–æ–≥–æ–≤
pytest tests/test_property_stage2_integration.py -v -s
```

---

## üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê STAGE 2

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã/—Å–æ–∑–¥–∞–Ω—ã:
1. ‚úÖ `app/services/property/property_service.py` - –û–ë–ù–û–í–õ–ï–ù (+350 —Å—Ç—Ä–æ–∫)
2. ‚úÖ `app/services/property/search_result_handler.py` - –°–û–ó–î–ê–ù (550 —Å—Ç—Ä–æ–∫)
3. ‚úÖ `app/services/property/llm_agent_property.py` - –û–ë–ù–û–í–õ–ï–ù (+300 —Å—Ç—Ä–æ–∫)
4. ‚úÖ `app/services/property/dream_score.py` - –°–û–ó–î–ê–ù (670 —Å—Ç—Ä–æ–∫)
5. ‚úÖ `tests/test_property_stage2_integration.py` - –°–û–ó–î–ê–ù (680 —Å—Ç—Ä–æ–∫)

### –°—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞:
- **–ù–æ–≤—ã–π –∫–æ–¥:** ~2250 —Å—Ç—Ä–æ–∫
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:** ~650 —Å—Ç—Ä–æ–∫
- **–ò—Ç–æ–≥–æ:** ~2900 —Å—Ç—Ä–æ–∫

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- **+26 —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞** (–±—ã–ª–æ 11 ‚Üí —Å—Ç–∞–ª–æ 37)
- **5 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** (0, 1-20, 20-200, 200+, –∫–ª–∞—Å—Ç–µ—Ä—ã)
- **+4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞** (–±—ã–ª–æ 5 ‚Üí —Å—Ç–∞–ª–æ 9)
- **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** (–∏–ø–æ—Ç–µ–∫–∞, —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã, —Ç–æ—Ä–≥)
- **24 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞**

---

## üéØ –ß–¢–û –û–°–¢–ê–õ–û–°–¨ (STAGE 3 - 30% —Ä–∞–±–æ—Ç—ã)

### 6. **POI Enrichment (–æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)** ‚è≥
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenStreetMap API
- –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –¥–æ —à–∫–æ–ª/—Å–∞–¥–æ–≤/–ø–∞—Ä–∫–æ–≤
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ poi_data –≤ –ë–î

### 7. **Route Matrix (–º–∞—Ç—Ä–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤)** ‚è≥
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex.Maps API
- –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—É—Ç–∏ –¥–æ —è–∫–æ—Ä–Ω—ã—Ö —Ç–æ—á–µ–∫
- –û—Ü–µ–Ω–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### 8. **Vision Analysis (–∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ)** ‚è≥
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Vision API
- –ê–Ω–∞–ª–∏–∑ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏
- –û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–¥–µ–ª–∫–∏
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ vision_data

### 9. **Price Context (—Ä—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)** ‚è≥
- –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ä–∞–π–æ–Ω—É
- –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–µ–π —Ü–µ–Ω
- –í—ã—è–≤–ª–µ–Ω–∏–µ –≤—ã–≥–æ–¥–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ market_data

### 10. **Developer Reputation (—Ä–µ–ø—É—Ç–∞—Ü–∏—è –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞)** ‚è≥
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤
- –°–∫–æ—Ä–∏–Ω–≥ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- –ò—Å—Ç–æ—Ä–∏—è —Å–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

---

## üöÄ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–∏—Å–∫ —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
```python
from app.services.property.property_service import property_service

listings = await property_service.search_listings(
    budget_min=8000000,
    budget_max=12000000,
    rooms_min=2,
    rooms_max=3,
    # –ù–û–í–û–ï: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è
    mortgage_required=True,
    payment_methods=["–∏–ø–æ—Ç–µ–∫–∞", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞"],
    haggle_allowed=True,
    limit=50
)
```

### –ü—Ä–∏–º–µ—Ä 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```python
from app.services.property.search_result_handler import search_result_handler

result = await search_result_handler.handle_results(
    listings=listings,
    client=client,
    filters_used={
        "budget_max": 12000000,
        "mortgage_required": True,
        "building_types": ["–∫–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π"]
    }
)

print(result["scenario"])  # "optimal_results"
print(result["message"])   # "–ù–∞—à—ë–ª 50 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞—é —Ç–æ–ø-12 –ø–æ —Ü–µ–Ω–µ."
print(len(result["suggestions"]))  # 2
```

### –ü—Ä–∏–º–µ—Ä 3: –†–∞—Å—á–µ—Ç Dream Score
```python
from app.services.property.dream_score import dream_score_calculator

score_data = dream_score_calculator.calculate(
    listing=listing,
    client=client
)

print(score_data["dream_score"])  # 87.5
print(score_data["components"]["financial"])  # 95.0
print(score_data["explanation"])
# "–û—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç! –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è (95%),
#  –∫–∞—á–µ—Å—Ç–≤–æ –¥–æ–º–∞ (85%), –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ (90%)"
```

### –ü—Ä–∏–º–µ—Ä 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ LLM
```python
from app.services.property.llm_agent_property import llm_agent_property

result = await llm_agent_property.extract_search_criteria(
    user_message="–•–æ—á—É 2–∫ —Å –∏–ø–æ—Ç–µ–∫–æ–π –¥–æ 10 –º–ª–Ω, –∫–∏—Ä–ø–∏—á–Ω—ã–π –¥–æ–º, –¥–µ—Ç—Å–∫–∏–π —Å–∞–¥ —Ä—è–¥–æ–º",
    user_id="123456",
    language="ru"
)

print(result["intent"])  # "search"
print(result["criteria"]["mortgage_required"])  # True
print(result["criteria"]["building_types"])  # ["–∫–∏—Ä–ø–∏—á–Ω—ã–π", "–∫–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π"]
print(result["criteria"]["kindergarten_nearby"])  # True
```

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
–í—Å–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ç–µ–∫—É—â–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ Stage 1:
```bash
psql -U postgres -d calendar_bot -f migrations/001_add_extended_property_fields.sql
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–∫—Ä—ã—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# Stage 1 —Ç–µ—Å—Ç—ã
python test_feed_mapper_simple.py

# Stage 2 —Ç–µ—Å—Ç—ã
pytest tests/test_property_stage2_integration.py -v
```

---

## üéâ –ò–¢–û–ì STAGE 2

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 30% ‚Üí **80%** (Stage 1 + Stage 2)

**Stage 2 - –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù:**
‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å 20+ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
‚úÖ SearchResultHandler –¥–ª—è 5 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
‚úÖ LLM –∞–≥–µ–Ω—Ç —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
‚úÖ Dream Score —Å 9 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
‚úÖ 24 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞

**–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É.**

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** Stage 3 - External Enrichment (POI, Routes, Vision, Market, Developers)

---

**–î–∞—Ç–∞:** 29.10.2025
**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** Claude (AI Assistant)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ STAGE 2 COMPLETE
