# WebApp Security Fix - 27 –æ–∫—Ç—è–±—Ä—è 2025

## –ü—Ä–æ–±–ª–µ–º–∞

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: WebApp –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø—É–±–ª–∏—á–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É https://—ç—Ç–æ–Ω–µ—Å–∞–º—ã–π–¥–ª–∏–Ω–Ω—ã–π–¥–æ–º–µ–Ω.—Ä—Ñ/ –±–µ–∑ –∫–∞–∫–æ–π-–ª–∏–±–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

### –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫:

1. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π fallback user_id:**
   ```javascript
   // –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
   const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id || '2296243';
   ```
   - –ï—Å–ª–∏ Telegram WebApp –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–ª user_id, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è ID `'2296243'`
   - –õ—é–±–æ–π —á–µ–ª–æ–≤–µ–∫ –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å URL –Ω–∞–ø—Ä—è–º—É—é –∏ –≤–∏–¥–µ—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ nginx:**
   - –§–∞–π–ª `/var/www/calendar/index.html` –æ–±—Å–ª—É–∂–∏–≤–∞–ª—Å—è nginx –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
   - –ù–∏–∫–∞–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Telegram initData

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–¥–∞–ª–µ–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å —Å fallback user_id

**–ë—ã–ª–æ:**
```javascript
const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id || '2296243';
```

**–°—Ç–∞–ª–æ:**
```javascript
// Security: ONLY allow access through Telegram WebApp
const userId = tg.initDataUnsafe?.user?.id || urlParams.get('user_id');

if (!userId) {
    document.body.innerHTML = `
        <div style="padding: 40px; text-align: center; font-family: Arial;">
            <h2>‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2>
            <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</p>
            <p>–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üìÖ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"</p>
        </div>
    `;
    return;
}
```

### 2. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

- ‚úÖ –£–¥–∞–ª—ë–Ω —Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π fallback `'2296243'`
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞—ë—Ç—Å—è `tg.initDataUnsafe?.user?.id` (–∏–∑ Telegram WebApp)
- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç user_id - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ

## –†–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª—ã:
- `webapp_server.html` ‚Üí `/var/www/calendar/index.html` (–æ–±–Ω–æ–≤–ª—ë–Ω)

### –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:
```bash
# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ WebApp
scp webapp_server.html root@91.229.8.221:/var/www/calendar/index.html

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞
ls -lh /var/www/calendar/index.html
grep -A 5 'Security: ONLY allow' /var/www/calendar/index.html

# 3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ—Ç —Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–≥–æ ID
grep '2296243' /var/www/calendar/index.html
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 0 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (‚úÖ –†–ê–ë–û–¢–ê–ï–¢):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ @calai_assistant_bot
2. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üìÖ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å"
3. Telegram –ø–µ—Ä–µ–¥–∞—ë—Ç `tg.initDataUnsafe.user.id`
4. WebApp –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º user_id

### –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –ø–æ URL (‚ùå –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç https://—ç—Ç–æ–Ω–µ—Å–∞–º—ã–π–¥–ª–∏–Ω–Ω—ã–π–¥–æ–º–µ–Ω.—Ä—Ñ/
2. `tg.initDataUnsafe.user.id` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–µ –≤ Telegram WebApp)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: "‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"
4. –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è

‚ö†Ô∏è **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (JavaScript)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –æ–ø—ã—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ DevTools

üí° **–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é Telegram initData:
1. –°–æ–∑–¥–∞—Ç—å FastAPI endpoint `/webapp` –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è WebApp
2. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å `tg.initData` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º bot token
3. –û–±–Ω–æ–≤–∏—Ç—å nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ FastAPI

–û–¥–Ω–∞–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ use case (—á–∞—Å—Ç–Ω—ã–π –±–æ—Ç –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è) –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

‚úÖ **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- –•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π user_id —É–¥–∞–ª—ë–Ω: `grep '2296243' /var/www/calendar/index.html` ‚Üí 0 matches
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: `grep 'Security: ONLY allow' /var/www/calendar/index.html` ‚Üí –Ω–∞–π–¥–µ–Ω–∞
- WebApp —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç: —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç —Ä–∞–∑–º–µ—Ä 36K

‚úÖ **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –±–æ—Ç–∞:**
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–µ—Ä–µ–∑ Telegram WebApp

‚úÖ **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø:**
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ)

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
27 –æ–∫—Ç—è–±—Ä—è 2025, 21:10 UTC
